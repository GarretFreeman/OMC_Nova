<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC ‚Äî Intranet</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb;
      --accent:#38bdf8; --accent-2:#22d3ee; --ok:#22c55e;
      --warn:#f59e0b; --danger:#ef4444; --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(135deg,var(--bg),#03121b 60%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:16px;margin:12px 0 24px}
    header img{height:56px;width:56px;object-fit:contain;border-radius:12px;background:#0b2f44;border:1px solid #11364a}
    header h1{font-size:clamp(22px,4vw,32px);margin:0;letter-spacing:0.3px}
    header .badge{margin-left:auto;padding:6px 10px;border:1px solid #1f3a4a;border-radius:999px;font-size:12px;background:#0b2130}

    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border:1px solid rgba(148,163,184,0.15);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.25)}
    .choices{display:flex;flex-wrap:wrap;gap:12px}
    .choice{flex:1 1 220px;min-height:120px;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px;border-radius:16px;border:1px solid #1f3a4a;background:linear-gradient(180deg,#061a25,#07121a)}
    .choice h3{margin:0 0 8px;font-size:18px}
    .choice p{margin:0;color:#cbd5e1;font-size:14px;opacity:.9}

    label{display:block;margin:12px 0 6px;font-weight:600}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3f4a;background:#0a1821;color:var(--text)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .row > *[data-col="6"]{grid-column:span 6}
    .row > *[data-col="12"]{grid-column:span 12}
    @media (max-width:900px){.row > *{grid-column:span 12 !important}}

    .muted{color:#94a3b8;font-size:13px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #1e3a4a;background:#0b2230;color:#9ed9ff;font-size:12px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#1d3a4a,transparent);margin:16px 0}

    /* Certificate preview */
    .certificate{background:white;color:#0b2130;border-radius:12px;padding:28px;border:1px solid #e2e8f0;}
    .certificate header{display:flex;gap:14px;align-items:center}
    .certificate header img{height:54px;width:54px;border-radius:10px;border:1px solid #d1e0e8;background:#eef7fb}
    .certificate h2{margin:4px 0 0;font-size:20px}
    .cert-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
    .cert-field{padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
    .cert-label{font-size:12px;color:#64748b;margin-bottom:4px}
    .cert-value{font-weight:600}
    .cert-footer{display:flex;justify-content:space-between;align-items:flex-end;margin-top:18px}
    .signature{margin-top:34px;border-top:1px solid #e2e8f0;padding-top:6px;font-size:12px;color:#64748b}

    /* Login gate */
    #gate{position:fixed;inset:0;background:radial-gradient(1200px 700px at 70% -10%,rgba(56,189,248,.12),transparent 60%),
      linear-gradient(135deg,#06131b,#02080c);display:flex;align-items:center;justify-content:center;}
    .gate-card{width:min(520px,92vw);}

    /* ==== Calculator styles (harmonis√©s) ==== */
    .grid-2{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }
    .section{padding:18px}
    .tabs{display:flex; gap:12px; flex-wrap:wrap; margin:14px 0 20px; justify-content:center; padding:10px; background:rgba(15,23,42,.5); border:1px solid var(--border); border-radius:16px; backdrop-filter:saturate(1.2) blur(6px); box-shadow:0 8px 24px rgba(0,0,0,.3)}
    .tab{appearance:none; border:1px solid var(--border); background:#0b1223; color:var(--text); padding:8px 12px; border-radius:14px; cursor:pointer; display:grid; place-items:center; gap:6px}
    .tab[aria-selected="true"]{background:linear-gradient(180deg, #0ea5e9, #0284c7); color:#001019; border-color:#0369a1; box-shadow:0 6px 16px rgb(2 132 199 / .45)}
    .tab .tab-caption{font-size:12px; color:#9ca3af}
    .list{max-height:520px; overflow:auto; padding:6px}
    .item{display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:12px; padding:10px 12px; border:1px dashed transparent; border-radius:12px}
    .item + .item{margin-top:8px}
    .item:hover{background:#0c1529; border-color:#16223c}
    .pill{font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:#cbd5e1}
    .qty{display:flex; align-items:center; gap:6px}
    .qty input{width:56px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#0b1223; color:#fff; text-align:center}
    .btn{appearance:none; border:none; padding:10px 14px; border-radius:12px; background:#0e172a; color:var(--text); border:1px solid var(--border); cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .totals{padding:18px; border-top:1px solid var(--border); display:grid; gap:10px}
    .totals .row{display:flex; justify-content:space-between; align-items:center}
    .total{font-size:28px; font-weight:800}
    .summary{white-space:pre-wrap; background:#0b1223; border:1px solid var(--border); border-radius:12px; padding:12px; min-height:120px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <!-- Login -->
  <div id="gate">
    <div class="wrap gate-card">
      <div class="card">
        <header>
          <img src="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" alt="OMC" />
          <h1>Ocean Medical Center ‚Äî Intranet</h1>
          <span class="badge">Acc√®s r√©serv√©</span>
        </header>
        <p class="muted">Cet espace est r√©serv√© aux membres de l'OMC. Merci d'entrer le mot de passe interne.</p>
        <label for="pwd">Mot de passe</label>
        <input id="pwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" id="loginBtn">Entrer</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header class="no-print">
      <img src="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" alt="OMC" />
      <h1>Ocean Medical Center ‚Äî Intranet</h1>
      <span class="badge" id="who">Connect√©</span>
    </header>

    <!-- Accueil -->
    <section id="home" class="card no-print">
      <div class="choices">
        <div class="choice" data-open="calc">
          <div>
            <h3>Calcul des co√ªts d'intervention</h3>
            <p>Catalogue d‚Äôactes (USD), quantit√©s, TVA, total.</p>
          </div>
          <button class="btn">Ouvrir</button>
        </div>
        <div class="choice" data-open="cert">
          <div>
            <h3>R√©aliser un certificat</h3>
            <p>Pro / PPA / Divers ‚Äî envoi Discord.</p>
          </div>
          <button class="btn">Ouvrir</button>
        </div>
      </div>
    </section>

    <!-- Module Calcul -->
    <section id="calc" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0">üßÆ Calcul des co√ªts d‚Äôintervention (USD)</h2>
        <button class="btn" data-back>‚Üê Retour</button>
      </div>
      <div class="hr"></div>

      <div class="grid-2">
        <!-- Catalogue -->
        <section class="section">
          <div class="tabs" id="tabs" role="tablist" aria-label="Cat√©gories de soins">
            <button class="tab" role="tab" aria-selected="true" data-cat="Administratif">
              <span class="tab-caption">Administratif</span>
            </button>
            <button class="tab" role="tab" aria-selected="false" data-cat="Transport">
              <span class="tab-caption">Transport</span>
            </button>
            <button class="tab" role="tab" aria-selected="false" data-cat="Soins H√¥pital">
              <span class="tab-caption">Soins H√¥pital</span>
            </button>
            <button class="tab" role="tab" aria-selected="false" data-cat="Soins sur site">
              <span class="tab-caption">Soins sur site</span>
            </button>
          </div>
          <div id="list" class="list" aria-live="polite"></div>
        </section>

        <!-- R√©cap -->
        <section class="section card">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:6px">
            <h3 style="margin:0">R√©capitulatif</h3>
            <div style="display:flex; gap:8px">
              <button class="btn" id="reset">R√©initialiser</button>
            </div>
          </div>
          <div id="summary" class="summary">‚Äî Aucun soin s√©lectionn√© ‚Äî</div>

          <div class="totals">
            <div class="row"><span>Sous-total</span><strong id="subtotal">$0</strong></div>
            <div class="row muted"><span>Taxes (optionnelles)</span>
              <span>
                <label style="display:inline-flex; align-items:center; gap:6px">
                  <input type="checkbox" id="taxEnable"> TVA
                </label>
                <input type="number" id="taxRate" value="0" min="0" max="100" step="0.5" style="width:80px; margin-left:8px; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:#0b1223; color:#fff"> %
              </span>
            </div>
            <div class="row"><span>Total</span><span class="total" id="total">$0</span></div>
          </div>
        </section>
      </div>
    </section>

    <!-- Module Certificat -->
    <section id="cert" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0">üìù G√©n√©rateur de certificat</h2>
        <div style="display:flex;gap:8px">
          <button class="btn" data-back>‚Üê Retour</button>
          <button class="btn" id="sendDiscord">Envoyer vers Discord</button>
        </div>
      </div>
      <div class="hr"></div>

      <!-- Formulaire -->
      <form id="certForm" class="row no-print">
        <div data-col="6">
          <label>Type de certificat</label>
          <select id="certType">
            <option value="pro">Certificat m√©dical d‚Äôaptitude professionnelle</option>
            <option value="ppa">Certificat de capacit√© √† passer l‚Äôexamen du PPA</option>
            <option value="divers">Certificat ‚Äî Divers</option>
          </select>
        </div>
        <div data-col="6">
          <label>Date</label>
          <input type="date" id="certDate" />
        </div>

        <div data-col="6">
          <label>Nom & Pr√©nom du patient</label>
          <input id="patient" placeholder="Ex : John DOE" />
        </div>
        <div data-col="6">
          <label>Date de naissance</label>
          <input id="dob" placeholder="Ex : 01/01/1995" />
        </div>

        <!-- Entreprise (PRO uniquement) -->
        <div data-col="12" id="companyWrap">
          <label>Entreprise</label>
          <input id="company" placeholder="Ex : Gruppe Sechs, LTD" />
        </div>

        <!-- Conclusion / r√©serves (PRO & PPA) -->
        <div data-col="12" id="conclusionWrap">
          <label>Conclusion</label>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <label><input type="radio" name="concl" value="ok" checked> Examen clinique sans anomalie. Aucune contre-indication relev√©e par rapport √† l‚Äôobjet du certificat.</label>
            <label><input type="radio" name="concl" value="reserve"> Apte avec r√©serve</label>
          </div>
        </div>
        <div data-col="12" id="reserveWrap" style="display:none">
          <label>R√©serves</label>
          <textarea id="reserveText" rows="3" placeholder="Pr√©ciser les r√©serves‚Ä¶"></textarea>
        </div>

        <!-- Divers : texte libre -->
        <div data-col="12" id="notesWrap" style="display:none">
          <label>Texte du certificat</label>
          <textarea id="notes" rows="5" placeholder="Saisir le contenu du certificat‚Ä¶"></textarea>
        </div>

        <div data-col="12">
          <label>M√©decin / Intervenant</label>
          <input id="doctor" placeholder="Dr. Jane SMITH" />
        </div>
      </form>

      <div class="hr no-print"></div>

      <!-- Aper√ßu -->
      <div class="certificate" id="certPreview">
        <header>
          <img src="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" alt="OMC" />
          <div>
            <div class="tag" id="certTag">OCEAN MEDICAL CENTER</div>
            <h2 id="certTitle">Certificat</h2>
          </div>
        </header>

        <div class="cert-grid">
          <div class="cert-field">
            <div class="cert-label">Patient</div>
            <div class="cert-value" id="pvPatient">‚Äî</div>
          </div>
          <div class="cert-field">
            <div class="cert-label">Date de naissance</div>
            <div class="cert-value" id="pvDob">‚Äî</div>
          </div>
          <div class="cert-field">
            <div class="cert-label">Date</div>
            <div class="cert-value" id="pvDate">‚Äî</div>
          </div>
          <div class="cert-field">
            <div class="cert-label">R√©f√©rence (JJMMHHMM)</div>
            <div class="cert-value" id="pvRef">‚Äî</div>
          </div>
          <div class="cert-field" id="pvCompanyWrap" style="display:none">
            <div class="cert-label">Entreprise</div>
            <div class="cert-value" id="pvCompany">‚Äî</div>
          </div>
        </div>

        <div class="cert-field" style="margin-top:14px">
          <div class="cert-label">Objet / Conclusion</div>
          <div class="cert-value" id="pvNotes">‚Äî</div>
        </div>

        <div class="cert-footer">
          <div>
            <div class="cert-label">√âtabli par</div>
            <div class="cert-value" id="pvDoctor">‚Äî</div>
            <div class="signature">Signature et cachet</div>
          </div>
          <div style="text-align:right">
            <div class="cert-label">Mention</div>
            <div class="cert-value">Usage interne OMC</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  /* ====== Config ====== */
  const OMC_PASSWORD = "omc2025";
  const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1417874223115931789/fa_Ar35jK1b8i2Z3itgqpg79Q0ZN0VnFaIF63R10QouiIJ8JTIMAihW8k_2gNflYJPn3";

  /* ====== Login ====== */
  const gate = document.getElementById('gate');
  const loginBtn = document.getElementById('loginBtn');
  const pwdInput = document.getElementById('pwd');
  function setLoggedIn(){ gate.style.display='none'; }
  loginBtn.addEventListener('click',()=>{ if(pwdInput.value===OMC_PASSWORD){ setLoggedIn(); } else { alert("Mot de passe incorrect"); }});
  pwdInput.addEventListener('keyup',e=>{ if(e.key==="Enter") loginBtn.click(); });

  /* ====== Navigation ====== */
  const home = document.getElementById('home');
  const calc = document.getElementById('calc');
  const cert = document.getElementById('cert');
  document.querySelectorAll('.choice').forEach(el=>{
    el.addEventListener('click',()=>{
      const panel = el.getAttribute('data-open');
      home.style.display='none';
      if(panel==='calc') calc.style.display='block';
      if(panel==='cert') cert.style.display='block';
    });
  });
  document.querySelectorAll('[data-back]').forEach(b=> b.addEventListener('click',()=>{
    calc.style.display='none'; cert.style.display='none'; home.style.display='block';
  }));

  /* ====== Helpers ====== */
  const el = id => document.getElementById(id);
  const pad2 = n => n.toString().padStart(2,'0');
  function buildRefJJMMHHMM(dateObj = new Date()){
    const d = pad2(dateObj.getDate());
    const m = pad2(dateObj.getMonth()+1);
    const H = pad2(dateObj.getHours());
    const M = pad2(dateObj.getMinutes());
    return `${d}${m}${H}${M}`;
  }

  /* ====== CERTIFICAT ====== */
  const certType = el('certType');
  const certDate = el('certDate');
  const patient  = el('patient');
  const dob      = el('dob');
  const companyWrap = el('companyWrap');
  const company  = el('company');
  const conclusionWrap = el('conclusionWrap');
  const reserveWrap = el('reserveWrap');
  const reserveText = el('reserveText');
  const notesWrap = el('notesWrap');
  const notes    = el('notes');
  const doctor   = el('doctor');

  const pvTitle = el('certTitle');
  const pvTag = el('certTag');
  const pvPatient = el('pvPatient');
  const pvDob = el('pvDob');
  const pvDate = el('pvDate');
  const pvRef = el('pvRef');
  const pvCompanyWrap = el('pvCompanyWrap');
  const pvCompany = el('pvCompany');
  const pvNotes = el('pvNotes');
  const pvDoctor = el('pvDoctor');

  certDate.valueAsNumber = Date.now() - (new Date()).getTimezoneOffset()*60000;

  function updateVisibility(){
    const type = certType.value;
    if(type === 'pro'){
      companyWrap.style.display = '';
      conclusionWrap.style.display = '';
      notesWrap.style.display = 'none';
    }
    if(type === 'ppa'){
      companyWrap.style.display = 'none';
      conclusionWrap.style.display = '';
      notesWrap.style.display = 'none';
    }
    if(type === 'divers'){
      companyWrap.style.display = 'none';
      conclusionWrap.style.display = 'none';
      reserveWrap.style.display = 'none';
      notesWrap.style.display = '';
    }
  }

  function currentConclusionText(){
    const type = certType.value;
    if(type === 'divers'){
      return (notes.value || '‚Äî');
    }
    const choice = (document.querySelector('input[name="concl"]:checked') || {}).value || 'ok';
    if(choice === 'ok'){
      return "Examen clinique sans anomalie. Aucune contre-indication relev√©e par rapport √† l‚Äôobjet du certificat.";
    }else{
      const r = reserveText.value.trim();
      return "Apte avec r√©serve" + (r ? " ‚Äî " + r : "");
    }
  }

  function refreshCert(){
    if(certType.value === 'pro'){
      pvTitle.textContent = "Certificat m√©dical d‚Äôaptitude professionnelle";
      pvTag.textContent = "OCEAN MEDICAL CENTER ‚Äî APTITUDE PRO";
    }else if(certType.value === 'ppa'){
      pvTitle.textContent = "Certificat de capacit√© √† passer l‚Äôexamen du PPA";
      pvTag.textContent = "OCEAN MEDICAL CENTER ‚Äî PPA";
    }else{
      pvTitle.textContent = "Certificat ‚Äî Divers";
      pvTag.textContent = "OCEAN MEDICAL CENTER";
    }

    pvPatient.textContent = patient.value || '‚Äî';
    pvDob.textContent = dob.value || '‚Äî';
    pvDate.textContent = certDate.value || '‚Äî';
    pvRef.textContent = buildRefJJMMHHMM(new Date());

    if(certType.value === 'pro'){
      pvCompanyWrap.style.display = '';
      pvCompany.textContent = company.value || '‚Äî';
    }else{
      pvCompanyWrap.style.display = 'none';
      pvCompany.textContent = '‚Äî';
    }

    pvNotes.textContent = currentConclusionText();
    pvDoctor.textContent = doctor.value || '‚Äî';
  }

  ['change','keyup','input'].forEach(evt=>{
    [certType,certDate,patient,dob,company,notes,doctor,reserveText].forEach(c=> c.addEventListener(evt, ()=>{ updateVisibility(); refreshCert(); }));
  });
  document.querySelectorAll('input[name="concl"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      reserveWrap.style.display = (r.value==='reserve' && r.checked && certType.value!=='divers') ? '' : 'none';
      refreshCert();
    });
  });
  updateVisibility();
  refreshCert();

  async function sendToDiscord(){
    const btn = document.getElementById('sendDiscord');
    btn.disabled = true; btn.textContent = 'Envoi‚Ä¶';
    try{
      const node = document.getElementById('certPreview');
      const canvas = await html2canvas(node, {scale: 2, backgroundColor: '#ffffff'});
      const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
      const destinataire = (patient.value || '‚Äî');
      const content = `Certificat OMC ‚Äî confidentiel √† l‚Äôattention de ${destinataire}`;

      const form = new FormData();
      form.append('payload_json', JSON.stringify({content}));
      form.append('file', blob, `certificat_${buildRefJJMMHHMM(new Date())}.png`);

      const resp = await fetch(DISCORD_WEBHOOK, {method:'POST', body: form});
      if(!resp.ok){
        const txt = await resp.text();
        throw new Error('Discord: '+txt);
      }
      alert("‚úÖ Envoy√© dans Discord !");
    }catch(e){
      alert("Erreur d‚Äôenvoi : " + e.message);
      console.error(e);
    }finally{
      btn.disabled = false; btn.textContent = 'Envoyer vers Discord';
    }
  }
  document.getElementById('sendDiscord').addEventListener('click', sendToDiscord);

  /* ====== CALCULATEUR (USD) ====== */
  const CATALOG = [
    // Administratif
    { id:'CERT_TRAVAIL', name:'Certificat aptitude travail', priceUSD:450,  category:'Administratif' },
    { id:'CERT_PPA',     name:'Certificat aptitude PPA',     priceUSD:6500, category:'Administratif' },
    // Transport
    { id:'AMBUL_LOCAL',  name:'Transport ambulance locale',  priceUSD:200,  category:'Transport' },
    // Soins H√¥pital
    { id:'HOP_SOIN',     name:'Soins',                       priceUSD:450,  category:'Soins H√¥pital' },
    { id:'HOP_REA',      name:'R√©animation',                 priceUSD:800,  category:'Soins H√¥pital' },
    { id:'HOP_RADIO',    name:'Radio de contr√¥le',           priceUSD:480,  category:'Soins H√¥pital' },
    { id:'HOP_SUTURE',   name:'Points de suture',            priceUSD:500,  category:'Soins H√¥pital' },
    { id:'HOP_ATTELLE',  name:"Fourniture et pose d'une attelle", priceUSD:950, category:'Soins H√¥pital' },
    { id:'HOP_PLATRE',   name:"Fourniture et pose d'un pl√¢tre",   priceUSD:1100, category:'Soins H√¥pital' },
    // Soins sur site
    { id:'SITE_SOIN',    name:'Soins',                       priceUSD:450,  category:'Soins sur site' },
    { id:'SITE_REA',     name:'R√©animation',                 priceUSD:800,  category:'Soins sur site' },
  ];

  const state = new Map(); // id -> qty
  let activeCategory = 'Administratif';

  const elsCalc = {
    list: document.getElementById('list'),
    tabs: document.getElementById('tabs'),
    summary: document.getElementById('summary'),
    subtotal: document.getElementById('subtotal'),
    total: document.getElementById('total'),
    taxEnable: document.getElementById('taxEnable'),
    taxRate: document.getElementById('taxRate'),
    reset: document.getElementById('reset'),
  };
  const fmtUSD = (n) => new Intl.NumberFormat('en-US', { style:'currency', currency: 'USD' }).format(n);

  function syncTabs(){
    for (const btn of elsCalc.tabs.querySelectorAll('.tab')) {
      btn.setAttribute('aria-selected', String(btn.dataset.cat === activeCategory));
    }
  }
  function renderList(){
    elsCalc.list.innerHTML='';
    CATALOG.filter(x => x.category === activeCategory).forEach(item => {
      const row = document.createElement('div');
      row.className = 'item';

      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:600">${item.name}</div>
                        <div class="muted" style="font-size:13px">${item.id} ¬∑ <span class="pill">${item.category}</span></div>`;

      const price = document.createElement('div');
      price.className = 'muted';
      price.textContent = fmtUSD(item.priceUSD);

      const qty = document.createElement('div');
      qty.className = 'qty';
      const minus = document.createElement('button'); minus.className='btn'; minus.textContent='‚àí';
      const input = document.createElement('input'); input.type='number'; input.min='0'; input.step='1';
      input.value = state.get(item.id) ?? 0;
      const plus = document.createElement('button'); plus.className='btn'; plus.textContent='+';

      minus.onclick = () => { const v=Math.max(0, (state.get(item.id)||0)-1); state.set(item.id, v); input.value=v; updateSummary(); };
      plus.onclick  = () => { const v=(state.get(item.id)||0)+1; state.set(item.id, v); input.value=v; updateSummary(); };
      input.oninput = () => { const v=Math.max(0, parseInt(input.value||'0',10)); state.set(item.id, v); input.value=v; updateSummary(); };

      qty.append(minus, input, plus);
      row.append(left, price, qty);
      elsCalc.list.appendChild(row);
    });
  }
  function compute(){
    let lines = [];
    let subtotal = 0;
    for(const item of CATALOG){
      const q = state.get(item.id)||0;
      if(!q) continue;
      const unit = item.priceUSD;
      const line = unit * q;
      subtotal += line;
      lines.push(`‚Ä¢ ${item.name} √ó ${q} ‚Äî ${fmtUSD(line)} (${fmtUSD(unit)}/u)`);
    }
    const taxEnabled = elsCalc.taxEnable.checked;
    const taxRate = Math.max(0, Number(elsCalc.taxRate.value||0));
    const taxValue = taxEnabled ? (subtotal * taxRate/100) : 0;
    const total = subtotal + taxValue;
    return { lines, subtotal, taxEnabled, taxRate, taxValue, total };
  }
  function updateSummary(){
    const {lines, subtotal, taxEnabled, taxRate, taxValue, total} = compute();
    elsCalc.summary.textContent = lines.length ? lines.join('\n') : '‚Äî Aucun soin s√©lectionn√© ‚Äî';
    elsCalc.subtotal.textContent = fmtUSD(subtotal);
    elsCalc.total.textContent = fmtUSD(total);
    elsCalc.taxRate.disabled = !taxEnabled;
    elsCalc.taxRate.style.opacity = taxEnabled ? 1 : .6;
  }

  elsCalc.tabs.addEventListener('click', (e) => {
    const btn = e.target.closest('.tab');
    if (!btn) return;
    activeCategory = btn.dataset.cat;
    syncTabs();
    renderList();
    updateSummary();
  });
  elsCalc.taxEnable.addEventListener('change', updateSummary);
  elsCalc.taxRate.addEventListener('input', updateSummary);
  elsCalc.reset.addEventListener('click', ()=>{ state.clear(); updateSummary(); renderList(); });

  // Init calc
  syncTabs();
  renderList();
  updateSummary();
  </script>
</body>
</html>

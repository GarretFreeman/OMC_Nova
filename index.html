<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC ‚Äî Intranet</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb;
      --accent:#38bdf8; --accent-2:#22d3ee; --ok:#22c55e;
      --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(135deg,var(--bg),#03121b 60%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:16px;margin:12px 0 24px}
    header img{height:56px;width:56px;object-fit:contain;border-radius:12px;background:#0b2f44;border:1px solid #11364a}
    header h1{font-size:clamp(22px,4vw,32px);margin:0;letter-spacing:0.3px}
    header .badge{margin-left:auto;padding:6px 10px;border:1px solid #1f3a4a;border-radius:999px;font-size:12px;background:#0b2130}

    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border:1px solid rgba(148,163,184,0.15);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.25)}
    .choices{display:flex;flex-wrap:wrap;gap:12px}
    .choice{flex:1 1 220px;min-height:120px;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px;border-radius:16px;border:1px solid #1f3a4a;background:linear-gradient(180deg,#061a25,#07121a)}
    .choice h3{margin:0 0 8px;font-size:18px}
    .choice p{margin:0;color:#cbd5e1;font-size:14px;opacity:.9}

    label{display:block;margin:12px 0 6px;font-weight:600}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3f4a;background:#0a1821;color:var(--text)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .row > *[data-col="6"]{grid-column:span 6}
    .row > *[data-col="12"]{grid-column:span 12}
    @media (max-width:900px){.row > *{grid-column:span 12 !important}}

    .muted{color:#94a3b8;font-size:13px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #1e3a4a;background:#0b2230;color:#9ed9ff;font-size:12px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#1d3a4a,transparent);margin:16px 0}

    .certificate{background:white;color:#0b2130;border-radius:12px;padding:28px;border:1px solid #e2e8f0;}
    .certificate header{display:flex;gap:14px;align-items:center}
    .certificate header img{height:54px;width:54px;border-radius:10px;border:1px solid #d1e0e8;background:#eef7fb}
    .certificate h2{margin:4px 0 0;font-size:20px}
    .cert-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
    .cert-field{padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
    .cert-label{font-size:12px;color:#64748b;margin-bottom:4px}
    .cert-value{font-weight:600}
    .cert-footer{display:flex;justify-content:space-between;align-items:flex-end;margin-top:18px}
    .signature{margin-top:34px;border-top:1px solid #e2e8f0;padding-top:6px;font-size:12px;color:#64748b}

    #gate{position:fixed;inset:0;background:radial-gradient(1200px 700px at 70% -10%,rgba(56,189,248,.12),transparent 60%),
      linear-gradient(135deg,#06131b,#02080c);display:flex;align-items:center;justify-content:center;}
    .gate-card{width:min(520px,92vw);}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <!-- Login -->
  <div id="gate">
    <div class="wrap gate-card">
      <div class="card">
        <header>
          <img src="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" alt="OMC" />
          <h1>Ocean Medical Center ‚Äî Intranet</h1>
          <span class="badge">Acc√®s r√©serv√©</span>
        </header>
        <p class="muted">Cet espace est r√©serv√© aux membres de l'OMC. Merci d'entrer le mot de passe interne.</p>
        <label for="pwd">Mot de passe</label>
        <input id="pwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" id="loginBtn">Entrer</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header class="no-print">
      <img src="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" alt="OMC" />
      <h1>Ocean Medical Center ‚Äî Intranet</h1>
      <span class="badge" id="who">Connect√©</span>
    </header>

    <!-- Home -->
    <section id="home" class="card no-print">
      <div class="choices">
        <div class="choice" data-open="cert">
          <div>
            <h3>R√©aliser un certificat</h3>
            <p>Pro / PPA / Divers</p>
          </div>
          <button class="btn">Ouvrir</button>
        </div>
      </div>
    </section>

    <!-- Certificat -->
    <section id="cert" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h2 style="margin:0">üìù G√©n√©rateur de certificat</h2>
        <div style="display:flex;gap:8px">
          <button class="btn secondary" data-back>‚Üê Retour</button>
          <button class="btn" id="sendDiscord">Envoyer vers Discord</button>
        </div>
      </div>
      <div class="hr"></div>

      <!-- Formulaire -->
      <form id="certForm" class="row no-print">
        <div data-col="6">
          <label>Type de certificat</label>
          <select id="certType">
            <option value="pro">Certificat m√©dical d‚Äôaptitude professionnelle</option>
            <option value="ppa">Certificat de capacit√© √† passer l‚Äôexamen du PPA</option>
            <option value="divers">Certificat ‚Äî Divers</option>
          </select>
        </div>
        <div data-col="6">
          <label>Date</label>
          <input type="date" id="certDate" />
        </div>

        <div data-col="6">
          <label>Nom & Pr√©nom du patient</label>
          <input id="patient" placeholder="Ex : John DOE" />
        </div>
        <div data-col="6">
          <label>Date de naissance</label>
          <input id="dob" placeholder="Ex : 01/01/1995" />
        </div>

        <!-- Entreprise (uniquement pour PRO) -->
        <div data-col="12" id="companyWrap">
          <label>Entreprise</label>
          <input id="company" placeholder="Ex : Gruppe Sechs, LTD" />
        </div>

        <!-- Conclusions / r√©serves (PRO & PPA) -->
        <div data-col="12" id="conclusionWrap">
          <label>Conclusion</label>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <label><input type="radio" name="concl" value="ok" checked> Examen clinique sans anomalie. Aucune contre-indication relev√©e par rapport √† l‚Äôobjet du certificat.</label>
            <label><input type="radio" name="concl" value="reserve"> Apte avec r√©serve</label>
          </div>
        </div>
        <div data-col="12" id="reserveWrap" style="display:none">
          <label>R√©serves</label>
          <textarea id="reserveText" rows="3" placeholder="Pr√©ciser les r√©serves‚Ä¶"></textarea>
        </div>

        <!-- Notes libres (uniquement DIVERS) -->
        <div data-col="12" id="notesWrap" style="display:none">
          <label>Texte du certificat</label>
          <textarea id="notes" rows="5" placeholder="Saisir le contenu du certificat‚Ä¶"></textarea>
        </div>

        <!-- Docteur (toujours) -->
        <div data-col="12">
          <label>M√©decin / Intervenant</label>
          <input id="doctor" placeholder="Dr. Jane SMITH" />
        </div>
      </form>

      <div class="hr no-print"></div>

      <!-- Aper√ßu -->
      <div class="certificate" id="certPreview">
        <header>
          <img src="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" alt="OMC" />
          <div>
            <div class="tag" id="certTag">OCEAN MEDICAL CENTER</div>
            <h2 id="certTitle">Certificat</h2>
          </div>
        </header>

        <div class="cert-grid">
          <div class="cert-field">
            <div class="cert-label">Patient</div>
            <div class="cert-value" id="pvPatient">‚Äî</div>
          </div>
          <div class="cert-field">
            <div class="cert-label">Date de naissance</div>
            <div class="cert-value" id="pvDob">‚Äî</div>
          </div>
          <div class="cert-field">
            <div class="cert-label">Date</div>
            <div class="cert-value" id="pvDate">‚Äî</div>
          </div>
          <div class="cert-field">
            <div class="cert-label">R√©f√©rence (JJMMHHMM)</div>
            <div class="cert-value" id="pvRef">‚Äî</div>
          </div>
          <div class="cert-field" id="pvCompanyWrap" style="display:none">
            <div class="cert-label">Entreprise</div>
            <div class="cert-value" id="pvCompany">‚Äî</div>
          </div>
        </div>

        <div class="cert-field" style="margin-top:14px">
          <div class="cert-label">Objet / Conclusion</div>
          <div class="cert-value" id="pvNotes">‚Äî</div>
        </div>

        <div class="cert-footer">
          <div>
            <div class="cert-label">√âtabli par</div>
            <div class="cert-value" id="pvDoctor">‚Äî</div>
            <div class="signature">Signature et cachet</div>
          </div>
          <div style="text-align:right">
            <div class="cert-label">Mention</div>
            <div class="cert-value">Usage interne OMC</div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ====== Config ====== */
const OMC_PASSWORD = "omc2025";
const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1417874223115931789/fa_Ar35jK1b8i2Z3itgqpg79Q0ZN0VnFaIF63R10QouiIJ8JTIMAihW8k_2gNflYJPn3";

/* ====== Login ====== */
const gate = document.getElementById('gate');
const loginBtn = document.getElementById('loginBtn');
const pwdInput = document.getElementById('pwd');
function setLoggedIn(){ gate.style.display='none'; }
loginBtn.addEventListener('click',()=>{ if(pwdInput.value===OMC_PASSWORD){ setLoggedIn(); } else { alert("Mot de passe incorrect"); }});
pwdInput.addEventListener('keyup',e=>{ if(e.key==="Enter") loginBtn.click(); });

/* ====== Nav ====== */
const home = document.getElementById('home');
const cert = document.getElementById('cert');
document.querySelectorAll('.choice').forEach(el=>el.addEventListener('click',()=>{home.style.display='none';cert.style.display='block';}));
document.querySelectorAll('[data-back]').forEach(b=>b.addEventListener('click',()=>{cert.style.display='none';home.style.display='block';}));

/* ====== Helpers ====== */
const el = id => document.getElementById(id);
const pad2 = n => n.toString().padStart(2,'0');
function buildRefJJMMHHMM(dateObj = new Date()){
  const d = pad2(dateObj.getDate());
  const m = pad2(dateObj.getMonth()+1);
  const H = pad2(dateObj.getHours());
  const M = pad2(dateObj.getMinutes());
  return `${d}${m}${H}${M}`;
}

/* ====== Form fields ====== */
const certType = el('certType');
const certDate = el('certDate');
const patient  = el('patient');
const dob      = el('dob');
const companyWrap = el('companyWrap');
const company  = el('company');
const conclusionWrap = el('conclusionWrap');
const reserveWrap = el('reserveWrap');
const reserveText = el('reserveText');
const notesWrap = el('notesWrap');
const notes    = el('notes');
const doctor   = el('doctor');

/* ====== Preview fields ====== */
const pvTitle = el('certTitle');
const pvTag = el('certTag');
const pvPatient = el('pvPatient');
const pvDob = el('pvDob');
const pvDate = el('pvDate');
const pvRef = el('pvRef');
const pvCompanyWrap = el('pvCompanyWrap');
const pvCompany = el('pvCompany');
const pvNotes = el('pvNotes');
const pvDoctor = el('pvDoctor');

/* Defaults */
certDate.valueAsNumber = Date.now() - (new Date()).getTimezoneOffset()*60000;

/* ====== UI logic by type ====== */
function updateVisibility(){
  const type = certType.value;
  // Pro: entreprise visible, conclusions visibles, notes (libres) masqu√©es
  if(type === 'pro'){
    companyWrap.style.display = '';
    conclusionWrap.style.display = '';
    notesWrap.style.display = 'none';
  }
  // PPA: pas d'entreprise, conclusions visibles, notes masqu√©es
  if(type === 'ppa'){
    companyWrap.style.display = 'none';
    conclusionWrap.style.display = '';
    notesWrap.style.display = 'none';
  }
  // Divers: uniquement champ libre
  if(type === 'divers'){
    companyWrap.style.display = 'none';
    conclusionWrap.style.display = 'none';
    reserveWrap.style.display = 'none';
    notesWrap.style.display = '';
  }
}

/* ====== Build preview ====== */
function currentConclusionText(){
  const type = certType.value;
  if(type === 'divers'){
    return (notes.value || '‚Äî');
  }
  const choice = (document.querySelector('input[name="concl"]:checked') || {}).value || 'ok';
  if(choice === 'ok'){
    return "Examen clinique sans anomalie. Aucune contre-indication relev√©e par rapport √† l‚Äôobjet du certificat.";
  }else{
    const r = reserveText.value.trim();
    return "Apte avec r√©serve" + (r ? " ‚Äî " + r : "");
  }
}

function refreshCert(){
  // Titre
  if(certType.value === 'pro'){
    pvTitle.textContent = "Certificat m√©dical d‚Äôaptitude professionnelle";
    pvTag.textContent = "OCEAN MEDICAL CENTER ‚Äî APTITUDE PRO";
  }else if(certType.value === 'ppa'){
    pvTitle.textContent = "Certificat de capacit√© √† passer l‚Äôexamen du PPA";
    pvTag.textContent = "OCEAN MEDICAL CENTER ‚Äî PPA";
  }else{
    pvTitle.textContent = "Certificat ‚Äî Divers";
    pvTag.textContent = "OCEAN MEDICAL CENTER";
  }

  // Champs de base
  pvPatient.textContent = patient.value || '‚Äî';
  pvDob.textContent = dob.value || '‚Äî';
  pvDate.textContent = certDate.value || '‚Äî';

  // R√©f√©rence JJMMHHMM (√† partir de l'heure actuelle)
  pvRef.textContent = buildRefJJMMHHMM(new Date());

  // Entreprise visible seulement pour PRO
  if(certType.value === 'pro'){
    pvCompanyWrap.style.display = '';
    pvCompany.textContent = company.value || '‚Äî';
  }else{
    pvCompanyWrap.style.display = 'none';
    pvCompany.textContent = '‚Äî';
  }

  // Conclusion / Notes
  pvNotes.textContent = currentConclusionText();

  // Docteur
  pvDoctor.textContent = doctor.value || '‚Äî';
}

/* ====== Events ====== */
['change','keyup','input'].forEach(evt=>{
  [certType,certDate,patient,dob,company,notes,doctor,reserveText].forEach(c=> c.addEventListener(evt, ()=>{ updateVisibility(); refreshCert(); }));
});
document.querySelectorAll('input[name="concl"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    reserveWrap.style.display = (r.value==='reserve' && r.checked && certType.value!=='divers') ? '' : 'none';
    refreshCert();
  });
});

/* Init UI */
updateVisibility();
refreshCert();

/* ====== Send to Discord (PNG) ====== */
async function sendToDiscord(){
  const btn = document.getElementById('sendDiscord');
  btn.disabled = true; btn.textContent = 'Envoi‚Ä¶';
  try{
    const node = document.getElementById('certPreview');
    const canvas = await html2canvas(node, {scale: 2, backgroundColor: '#ffffff'});
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));

    const destinataire = (patient.value || '‚Äî');
    const content = `Certificat OMC ‚Äî confidentiel √† l‚Äôattention de ${destinataire}`;

    const form = new FormData();
    form.append('payload_json', JSON.stringify({content}));
    form.append('file', blob, `certificat_${buildRefJJMMHHMM(new Date())}.png`);

    const resp = await fetch(DISCORD_WEBHOOK, {method:'POST', body: form});
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error('Discord: '+txt);
    }
    alert("‚úÖ Envoy√© dans Discord !");
  }catch(e){
    alert("Erreur d‚Äôenvoi : " + e.message);
    console.error(e);
  }finally{
    btn.disabled = false; btn.textContent = 'Envoyer vers Discord';
  }
}
document.getElementById('sendDiscord').addEventListener('click', sendToDiscord);
</script>
</body>
</html>

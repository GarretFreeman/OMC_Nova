<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC — Certificat de décès</title>
  <link rel="icon" href="assets/Logo-omc.png" type="image/png">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --panel-2:#0b1223; --text:#e5e7eb; --muted:#9ca3af; --ring:#1f2937; --radius:16px; }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; margin:0}
    .wrap{max-width:1100px;margin:40px auto; padding:0 16px}
    .block{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--ring); border-radius:var(--radius)}

    /* ======= Entête ======= */
    .top{ text-align:center; padding:16px 20px; border-bottom:1px solid var(--ring) }
    .brand{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; }
    .brand img{ height:72px; width:288px; object-fit:contain; background:#071423; padding:6px; border-radius:16px; }
    .brand strong{ font-size:18px; font-weight:800; letter-spacing:.3px }
    .backbar{ display:flex; justify-content:center; margin:8px 0 0 }
    .back{ appearance:none; border:1px solid var(--ring); border-radius:12px; padding:8px 12px; background:#0b1223; color:#e5e7eb; text-decoration:none }
    .back:hover{ background:#0e1a2e; border-color:#20314f }

    .panel{background:#0b1223; border:1px solid var(--ring); border-radius:var(--radius); padding:14px; margin:16px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    label small{color:var(--muted)}
    button{appearance:none; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; background:#0b1223; color:#e5e7eb; cursor:pointer}

    /* Carte (fond blanc export Discord) */
    .certificate{background:white;color:#0b2130;border-radius:12px;padding:28px;border:1px solid #e2e8f0;}
    .certificate header{display:flex;gap:14px;align-items:center}
    .certificate header img#brandLogo{height:54px;width:54px;border-radius:10px;border:1px solid #d1e0e8;background:#eef7fb;object-fit:cover}
    .certificate h2{margin:4px 0 0;font-size:20px}
    .cert-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
    .cert-field{padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
    .cert-label{font-size:12px;color:#64748b;margin-bottom:4px}
    .cert-value{font-weight:600;white-space:pre-wrap}

    .cert-footer{display:flex;justify-content:space-between;align-items:center;margin-top:18px;gap:12px}

    /* Tampon rond */
    .stamp{ width:120px;height:120px;border:3px solid #0b2230;border-radius:50%; display:flex;align-items:center;justify-content:center;position:relative;color:#0b2230; font-weight:800;text-align:center;background:#f8fbff; }
    .stamp::before{content:"OCEAN MEDICAL";position:absolute; top:10px; left:0; right:0; text-align:center; font-size:10px; letter-spacing:1.5px;}
    .stamp::after{content:"CENTER";position:absolute; bottom:10px; left:0; right:0; text-align:center; font-size:10px; letter-spacing:2px;}
    .stamp .inner{font-size:11px; line-height:1.1}

    .legal{ margin-top:16px; padding-top:12px; border-top:1px solid #e2e8f0; color:#475569; font-size:12px; line-height:1.45; text-align:center; }

    .qr{ width:110px; height:110px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; object-fit:contain; }

    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    @media (max-width: 720px){
      .cert-grid, .form-grid{grid-template-columns:1fr}
      .cert-footer{flex-direction:column; align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap block">
    <!-- Entête -->
    <div class="top">
      <div class="brand">
        <img src="assets/Logo-omc.png" alt="OMC">
        <strong>Ocean Medical Center — Intranet</strong>
      </div>
      <div class="backbar">
        <a class="back" href="index.html">← Accueil</a>
      </div>
    </div>

    <!-- Formulaire -->
    <div class="panel">
      <div class="form-grid">
        <div class="field"><label>Défunt <small>(Nom Prénom)</small></label><input id="deceased" placeholder="John DOE"></div>
        <div class="field"><label>Date de naissance</label><input id="dob" placeholder="01/01/1980"></div>

        <div class="field"><label>Date du décès</label><input type="date" id="dod"></div>
        <div class="field"><label>Heure du décès</label><input type="time" id="tod"></div>

        <div class="field"><label>Lieu du décès</label><input id="place" placeholder="OMC — Service Urgences"></div>
        <div class="field"><label>Type</label>
          <select id="dtype">
            <option value="naturel">Décès naturel</option>
            <option value="accidentel">Accidentel</option>
            <option value="violent">Violent</option>
            <option value="indetermine">Indéterminé</option>
          </select>
        </div>

        <div class="field" style="grid-column:1/3"><label>Cause immédiate</label><textarea id="causeImm" rows="2" placeholder="Arrêt cardio-respiratoire..."></textarea></div>
        <div class="field" style="grid-column:1/3"><label>Causes antécédentes</label><textarea id="causeAnt" rows="2" placeholder="Traumatisme thoracique, hémorragie interne..."></textarea></div>
        <div class="field" style="grid-column:1/3"><label>Circonstances / Observations</label><textarea id="circ" rows="3" placeholder="Contexte, éléments utiles RP..."></textarea></div>

        <div class="field"><label>Obstacle médico-légal</label>
          <div class="row">
            <label class="row"><input type="radio" name="oml" value="non" checked> Non</label>
            <label class="row"><input type="radio" name="oml" value="oui"> Oui</label>
          </div>
        </div>

        <div class="field"><label>Médecin certificateur</label><input id="doctor" placeholder="Dr. Jane SMITH"></div>

        <div class="field"><label>Ajouter un ping (optionnel)</label>
          <div class="row">
            <input id="mention" placeholder="@role ou @user (coller l'ID si besoin)">
            <label class="row"><input type="checkbox" id="mentionAsId"> Utiliser ID (format &lt@&amp;ROLEID>)</label>
          </div>
        </div>

        <!-- Bouton à droite -->
        <div class="field" style="grid-column:2/3; display:flex; align-items:flex-end; justify-content:flex-end">
          <button id="sendBtn">Imprimer sur copieur (Discord)</button>
        </div>
      </div>
    </div>

    <!-- Aperçu -->
    <div class="panel">
      <div class="certificate" id="certPreview">
        <header>
          <img id="brandLogo" src="assets/Logo-omc.png" alt="OMC" crossOrigin="anonymous">
          <div>
            <div id="certTag" style="display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #1e3a4a;background:#0b2230;color:#9ed9ff;font-size:12px">OCEAN MEDICAL CENTER</div>
            <h2 id="certTitle">Certificat de décès</h2>
          </div>
        </header>

        <div class="cert-grid">
          <div class="cert-field"><div class="cert-label">Défunt</div><div class="cert-value" id="pvName">—</div></div>
          <div class="cert-field"><div class="cert-label">Naissance</div><div class="cert-value" id="pvDob">—</div></div>
          <div class="cert-field"><div class="cert-label">Date / heure du décès</div><div class="cert-value" id="pvDod">—</div></div>
          <div class="cert-field"><div class="cert-label">Lieu</div><div class="cert-value" id="pvPlace">—</div></div>
          <div class="cert-field"><div class="cert-label">Référence dossier</div><div class="cert-value" id="pvRef">—</div></div>
          <div class="cert-field"><div class="cert-label">Type</div><div class="cert-value" id="pvType">—</div></div>
        </div>

        <div class="cert-field" style="margin-top:14px">
          <div class="cert-label">Cause immédiate</div>
          <div class="cert-value" id="pvCauseImm">—</div>
        </div>
        <div class="cert-field" style="margin-top:10px">
          <div class="cert-label">Causes antécédentes</div>
          <div class="cert-value" id="pvCauseAnt">—</div>
        </div>
        <div class="cert-field" style="margin-top:10px">
          <div class="cert-label">Circonstances / Observations</div>
          <div class="cert-value" id="pvCirc">—</div>
        </div>

        <div class="cert-footer">
          <div>
            <div class="cert-label">Établi par</div>
            <div class="cert-value" id="pvDoctor">—</div>
          </div>
          <div style="display:flex; align-items:center; gap:12px">
            <img id="qrImg" class="qr" alt="QR code">
            <div class="stamp"><div class="inner" id="stampInner">OMC</div></div>
          </div>
        </div>

        <div class="legal">
          Ce document RP atteste du décès de la personne identifiée, d'après les éléments cliniques et contextuels connus à la date et heure indiquées. Toute reproduction ou altération sans autorisation est interdite.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ========= CONFIG DISCORD (salon classique) ========= */
    // Remplacer par le webhook du salon cible (texte ou forum/fil existant si désiré)
    const WEBHOOK_CHANNEL_URL = 'https://discord.com/api/webhooks/1423600912563437578/_Lzpp_VeSJ4qPI-e2Jh94UdCjrf4R3084Hytq38guwMZEGwaCLYHkkusHzUd7ptID1s2';

    const el=id=>document.getElementById(id);
    const pad2=n=>String(n).padStart(2,'0');
    const refJJMMHHMM=(d=new Date())=>`${pad2(d.getDate())}${pad2(d.getMonth()+1)}${pad2(d.getHours())}${pad2(d.getMinutes())}`;

    // Champs
    const deceased=el('deceased'), dob=el('dob'), dod=el('dod'), tod=el('tod'), place=el('place'), dtype=el('dtype');
    const causeImm=el('causeImm'), causeAnt=el('causeAnt'), circ=el('circ');
    const doctor=el('doctor');
    const mention=el('mention'), mentionAsId=el('mentionAsId');

    // Preview
    const pvName=el('pvName'), pvDob=el('pvDob'), pvDod=el('pvDod'), pvPlace=el('pvPlace'), pvRef=el('pvRef'), pvType=el('pvType');
    const pvCauseImm=el('pvCauseImm'), pvCauseAnt=el('pvCauseAnt'), pvCirc=el('pvCirc'), pvDoctor=el('pvDoctor');
    const qrImg=el('qrImg'), stampInner=el('stampInner'), certPreview=el('certPreview');
    const brandLogo=el('brandLogo');
    const sendBtn=el('sendBtn');

    // Date/heure par défaut (local)
    (function initDates(){
      const now=new Date();
      const tzOff=now.getTimezoneOffset()*60000;
      const todayISO=new Date(Date.now()-tzOff).toISOString().slice(0,10);
      try{ dod.valueAsNumber=Date.now()-tzOff; }catch{ dod.value=todayISO; }
      tod.value = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    })();

    function currentOML(){ return (document.querySelector('input[name="oml"]:checked')||{}).value||'non'; }

    function refreshPreview(){
      pvName.textContent = deceased.value || '—';
      pvDob.textContent = dob.value || '—';
      const dd = dod.value || '—';
      const tt = tod.value || '—';
      pvDod.textContent = `${dd} ${tt}`.trim();
      pvPlace.textContent = place.value || '—';
      const ref = refJJMMHHMM(new Date());
      pvRef.textContent = ref;
      const typeMap={naturel:'Décès naturel', accidentel:'Accidentel', violent:'Violent', indetermine:'Indéterminé'};
      pvType.textContent = `${typeMap[dtype.value]||'—'} — OML: ${currentOML().toUpperCase()}`;

      pvCauseImm.textContent = causeImm.value || '—';
      pvCauseAnt.textContent = causeAnt.value || '—';
      pvCirc.textContent = circ.value || '—';
      pvDoctor.textContent = doctor.value || '—';

      updateQR(ref);
    }

    function updateQR(ref){
      const data = { name: deceased.value||'', dob: dob.value||'', dod: dod.value||'', tod: tod.value||'', ref: ref||'' };
      const txt = `OMC|Defunt:${data.name}|Naissance:${data.dob}|Deces:${data.dod} ${data.tod}|Ref:${data.ref}`;
      const url = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(txt);
      qrImg.crossOrigin='anonymous';
      qrImg.src = url;
      stampInner.textContent = data.ref || 'OMC';
    }

    ['change','keyup','input'].forEach(evt=>{
      [deceased,dob,dod,tod,place,dtype,causeImm,causeAnt,circ,doctor].forEach(c=> c.addEventListener(evt, refreshPreview));
    });

    refreshPreview();

    function ensureImageLoaded(img, fallbackSrc=null){
      return new Promise((resolve)=>{
        if (img && img.complete && img.naturalWidth>0) return resolve();
        if (!img) return resolve();
        const done = ()=> resolve();
        img.onload = done;
        img.onerror = ()=>{
          if (fallbackSrc && img.src !== fallbackSrc){
            img.crossOrigin = 'anonymous';
            img.src = fallbackSrc;
            img.onload = done;
            img.onerror = done;
          } else { done(); }
        };
      });
    }

    async function ensureAssetsLoaded(){
      const logoFallback = 'https://i.ibb.co/LzwcCLfN/logo-omc-nord.png';
      await Promise.all([
        ensureImageLoaded(brandLogo, logoFallback),
        ensureImageLoaded(qrImg, null)
      ]);
      await new Promise(r=>setTimeout(r,50));
    }

    async function sendToDiscord(){
      if(!WEBHOOK_CHANNEL_URL){ alert('Webhook Discord non configuré.'); return; }
      sendBtn.disabled=true; sendBtn.textContent='Impression…';
      try{
        await ensureAssetsLoaded();
        const canvas = await html2canvas(certPreview, { scale:2, backgroundColor:'#ffffff', useCORS:true, imageTimeout:10000 });
        const blob = await new Promise(res=> canvas.toBlob(res,'image/png'));

        const ref = pvRef.textContent || refJJMMHHMM(new Date());
        const name = deceased.value || 'Sans nom';
        const contentLines = [
          `**Certificat de décès — Ref ${ref}**`,
          `Défunt : ${name}`,
          `Décès : ${dod.value||'—'} ${tod.value||''} — Lieu : ${place.value||'—'}`,
          `Type : ${dtype.options[dtype.selectedIndex].text} — OML: ${currentOML().toUpperCase()}`,
          `Médecin : ${doctor.value||'—'}`
        ];
        // Mention
        const mentionTxt = (mention.value||'').trim();
        if(mentionTxt){
          if(mentionAsId.checked){
            // Si ID de rôle: écrire <@&ID>; si ID d'utilisateur: <@ID>
            const isRoleId = /^\d{17,20}$/.test(mentionTxt);
            contentLines.push(isRoleId ? `<@&${mentionTxt}>` : `<@${mentionTxt}>`);
          } else {
            contentLines.push(mentionTxt);
          }
        }

        const fd = new FormData();
        fd.append('content', contentLines.join('\n'));
        fd.append('file', blob, `certificat_deces_${ref}.png`);

        const res = await fetch(WEBHOOK_CHANNEL_URL + '?wait=true', { method:'POST', body: fd });
        if(!res.ok){
          const txt = await res.text().catch(()=> '');
          throw new Error('Discord ' + res.status + ' — ' + txt);
        }
        alert('✅ Document “imprimé” sur le copieur (salon Discord).');
      } catch(e){
        console.error(e);
        alert('Envoi Discord échoué : ' + e.message);
      } finally {
        sendBtn.disabled=false; sendBtn.textContent='Imprimer sur copieur (Discord)';
      }
    }

    el('sendBtn').addEventListener('click', sendToDiscord);

    // Auto-test simple
    if(location.search.includes('test')){
      try{ const r=refJJMMHHMM(new Date()); console.assert(r.length===8, 'Ref JJMMHHMM incorrecte:'+r); console.log('%c[Tests décès] OK','color:#22c55e'); }catch(e){ console.error('[Tests décès] FAIL', e); }
    }
  });
  </script>
</body>
</html>

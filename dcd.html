<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC - Certificat de deces</title>
  <link rel="icon" href="assets/Logo-omc.png" type="image/png">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --panel-2:#0b1223; --text:#e5e7eb; --muted:#9ca3af; --ring:#1f2937; --radius:16px; }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; margin:0}
    .wrap{max-width:1100px;margin:40px auto; padding:0 16px}
    .block{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--ring); border-radius:var(--radius)}

    .top{ text-align:center; padding:16px 20px; border-bottom:1px solid var(--ring) }
    .brand{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; }
    .brand img{ height:72px; width:288px; object-fit:contain; background:#071423; padding:6px; border-radius:16px; }
    .brand strong{ font-size:18px; font-weight:800; letter-spacing:.3px }
    .backbar{ display:flex; justify-content:center; margin:8px 0 0 }
    .back{ appearance:none; border:1px solid var(--ring); border-radius:12px; padding:8px 12px; background:#0b1223; color:#e5e7eb; text-decoration:none }
    .back:hover{ background:#0e1a2e; border-color:#20314f }

    .panel{background:#0b1223; border:1px solid var(--ring); border-radius:var(--radius); padding:14px; margin:16px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    label small{color:var(--muted)}
    button{appearance:none; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; background:#0b1223; color:#e5e7eb; cursor:pointer}

    .certificate{background:white;color:#0b2130;border-radius:12px;padding:28px;border:1px solid #e2e8f0;}
    .certificate header{display:flex;gap:14px;align-items:center}
    .certificate header img#brandLogo{height:54px;width:54px;border-radius:10px;border:1px solid #d1e0e8;background:#eef7fb;object-fit:cover}
    .certificate h2{margin:4px 0 0;font-size:20px}
    .cert-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
    .cert-field{padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
    .cert-label{font-size:12px;color:#64748b;margin-bottom:4px}
    .cert-value{font-weight:600;white-space:pre-wrap}

    .cert-footer{display:flex;justify-content:space-between;align-items:center;margin-top:18px;gap:12px}

    .stamp{ width:120px;height:120px;border:3px solid #0b2230;border-radius:50%; display:flex;align-items:center;justify-content:center;position:relative;color:#0b2230; font-weight:800;text-align:center;background:#f8fbff; }
    .stamp::before{content:"OCEAN MEDICAL";position:absolute; top:10px; left:0; right:0; text-align:center; font-size:10px; letter-spacing:1.5px;}
    .stamp::after{content:"CENTER";position:absolute; bottom:10px; left:0; right:0; text-align:center; font-size:10px; letter-spacing:2px;}
    .stamp .inner{font-size:11px; line-height:1.1}

    .legal{ margin-top:16px; padding-top:12px; border-top:1px solid #e2e8f0; color:#475569; font-size:12px; line-height:1.45; text-align:justify; }

    .qr{ width:110px; height:110px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; object-fit:contain; }

    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    @media (max-width: 720px){
      .cert-grid, .form-grid{grid-template-columns:1fr}
      .cert-footer{flex-direction:column; align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap block">
    <div class="top">
      <div class="brand">
        <img src="assets/Logo-omc.png" alt="OMC">
        <strong>Ocean Medical Center - Intranet</strong>
      </div>
      <div class="backbar">
        <a class="back" href="index.html">‚Üê Accueil</a>
      </div>
    </div>

    <div class="panel">
      <div class="form-grid">
        <div class="field"><label>Defunt <small>(Nom Prenom)</small></label><input id="deceased" placeholder="John DOE"></div>
        <div class="field"><label>Date de naissance</label><input id="dob" placeholder="01/01/1980"></div>

        <div class="field"><label>Date du deces</label><input type="date" id="dod"></div>
        <div class="field"><label>Heure du deces</label><input type="time" id="tod"></div>

        <div class="field"><label>Lieu du deces</label><input id="place" placeholder="OMC - Service Urgences"></div>

        <!-- Cause immediate: type + detail dependants -->
        <div class="field"><label>Cause immediate - Type</label>
          <select id="immCat"></select>
        </div>
        <div class="field"><label>Cause immediate - Precision</label>
          <select id="immDetail"></select>
        </div>

        <!-- Cause antecedente (on conserve la precision simple) -->
        <div class="field"><label>Cause antecedente - Precision</label>
          <select id="antDetail"></select>
        </div>

        <div class="field"><label>Medecin certificateur</label><input id="doctor" placeholder="Dr. Jane SMITH"></div>

        <div class="field" style="grid-column:2/3; display:flex; align-items:flex-end; justify-content:flex-end">
          <button id="sendBtn">Imprimer sur copieur (Discord)</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="certificate" id="certPreview">
        <header>
          <img id="brandLogo" src="assets/Logo-omc.png" alt="OMC" crossOrigin="anonymous">
          <div>
            <div id="certTag" style="display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #1e3a4a;background:#0b2230;color:#9ed9ff;font-size:12px">OCEAN MEDICAL CENTER</div>
            <h2 id="certTitle">Certificat de deces</h2>
          </div>
        </header>

        <div class="cert-grid">
          <div class="cert-field"><div class="cert-label">Defunt</div><div class="cert-value" id="pvName">-</div></div>
          <div class="cert-field"><div class="cert-label">Naissance</div><div class="cert-value" id="pvDob">-</div></div>
          <div class="cert-field"><div class="cert-label">Date / heure du deces</div><div class="cert-value" id="pvDod">-</div></div>
          <div class="cert-field"><div class="cert-label">Lieu</div><div class="cert-value" id="pvPlace">-</div></div>
          <div class="cert-field"><div class="cert-label">Reference dossier</div><div class="cert-value" id="pvRef">-</div></div>
          <div class="cert-field"><div class="cert-label">Cause immediate</div><div class="cert-value" id="pvImm">-</div></div>
        </div>

        <div class="cert-field" style="margin-top:14px">
          <div class="cert-label">Cause antecedente</div>
          <div class="cert-value" id="pvAnt">-</div>
        </div>

        <div class="cert-footer">
          <div>
            <div class="cert-label">Etabli par</div>
            <div class="cert-value" id="pvDoctor">-</div>
          </div>
          <div style="display:flex; align-items:center; gap:12px">
            <img id="qrImg" class="qr" alt="QR code">
            <div class="stamp"><div class="inner" id="stampInner">OMC</div></div>
          </div>
        </div>

        <div class="legal">
          Ce certificat de deces est etabli dans le cadre de la pratique medicale RP, sur la base des constatations cliniques et des informations disponibles au moment de la certification. Il atteste uniquement du deces de la personne identifiee ci-dessus.
          <br><br>
          Toute reproduction, falsification ou usage detourne de ce document est strictement interdite. Les donnees nominatives y figurant sont protegees par la reglementation en vigueur et ne peuvent etre utilisees qu'aux seules fins administratives, judiciaires ou medicales prevues.
          <br><br>
          Ce document ne prejuge pas des investigations medico-legales complementaires qui pourraient etre requises par les autorites competentes. En cas de doute sur les circonstances du deces, les instances judiciaires sont habilitees a demander des examens supplementaires.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const WEBHOOK_CHANNEL_URL = 'https://discord.com/api/webhooks/XXXXXXXX/XXXXXXXXXXXXXXXX';

    const el = id => document.getElementById(id);
    const pad2 = n => String(n).padStart(2, '0');
    const refJJMMHHMM = (d = new Date()) => `${pad2(d.getDate())}${pad2(d.getMonth() + 1)}${pad2(d.getHours())}${pad2(d.getMinutes())}`;

    // Champs
    const deceased = el('deceased'), dob = el('dob'), dod = el('dod'), tod = el('tod'), place = el('place');
    const immCat = el('immCat'), immDetail = el('immDetail');
    const antDetail = el('antDetail');
    const doctor = el('doctor');

    // Preview
    const pvName = el('pvName'), pvDob = el('pvDob'), pvDod = el('pvDod'), pvPlace = el('pvPlace'), pvRef = el('pvRef');
    const pvImm = el('pvImm'), pvAnt = el('pvAnt'), pvDoctor = el('pvDoctor');
    const qrImg = el('qrImg'), stampInner = el('stampInner'), certPreview = el('certPreview');
    const brandLogo = el('brandLogo');
    const sendBtn = el('sendBtn');

    // Categories de cause immediate
    const IMM_CATEGORIES = {
      cardio: 'Cardio-respiratoire',
      neuro: 'Neurologique',
      hemo: 'Hemorragique',
      infect: 'Infectieuse / Metabolique',
      toxic: 'Toxique',
      trauma: 'Traumatique'
    };

    const IMM_DETAILS = {
      cardio: [
        'Arret cardio-respiratoire',
        'Fibrillation / TV',
        'Infarctus aigu du myocarde',
        'Dissection/rupture aortique',
        'Embolie pulmonaire massive',
        'Oedeme aigu du poumon',
        'Insuffisance respiratoire aigue',
        'Asphyxie mecanique',
        'Noyade'
      ],
      neuro: [
        'Hemorragie meningee',
        'Hemorragie intracerebrale massive',
        'Infarctus cerebral massif',
        'Traumatisme cranien severe',
        'Etat de mal epileptique'
      ],
      hemo: [
        'Hemorragie interne massive',
        'Hemorragie externe incontrolable',
        "Rupture d'anevrisme",
        'Hemorragie obstetricale severe'
      ],
      infect: [
        'Choc septique',
        'Defaillance multiviscerale',
        'Meningite bacterienne fulminante',
        'Acidocetose diabetique severe',
        'Insuffisance hepatique aigue',
        'Hyperthermie maligne / Coup de chaleur'
      ],
      toxic: [
        'Intoxication medicamenteuse massive',
        'Overdose opioides / cocaine',
        'Intoxication monoxyde de carbone',
        'Empoisonnement chimique'
      ],
      trauma: [
        'Polytraumatisme avec choc hemorragique',
        'Ecrasement thoraco-abdominal',
        'Section medullaire haute',
        'Brulures etendues avec defaillance vitale'
      ]
    };

    const ANTECEDENTS = [
      'Cardiopathie chronique', 'Hypertension arterielle', 'Diabete sucre', 'Pathologie respiratoire chronique', 'Insuffisance renale',
      'Cirrhose hepatique', 'Cancer evolutif', 'Polytraumatisme ancien', 'Trouble psychiatrique severe', 'Addiction (alcool, drogues)',
      'Insuffisance cardiaque', 'BPCO', 'Asthme severe', 'Maladie coronarienne', 'AVC ancien',
      'Maladie renale chronique', 'Demence', 'Immunodepression (VIH/SIDA)', 'Maladie auto-immune', 'Obesite severe'
    ];

    function fillSelectFromObject(select, obj){
      select.innerHTML = '';
      Object.keys(obj).forEach(k => {
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = obj[k];
        select.appendChild(opt);
      });
    }
    function fillSelectFromArray(select, arr){
      select.innerHTML = '';
      arr.forEach(v => { const opt = document.createElement('option'); opt.value = v; opt.textContent = v; select.appendChild(opt); });
    }

    // Init menus
    fillSelectFromObject(immCat, IMM_CATEGORIES);
    function refreshImmDetail(){ fillSelectFromArray(immDetail, IMM_DETAILS[immCat.value] || []); }
    immCat.addEventListener('change', () => { refreshImmDetail(); refreshPreview(); });
    refreshImmDetail();

    fillSelectFromArray(antDetail, ANTECEDENTS);

    // Date/heure par defaut
    (function initDates(){
      const now = new Date();
      const tzOff = now.getTimezoneOffset() * 60000;
      const todayISO = new Date(Date.now() - tzOff).toISOString().slice(0, 10);
      try { dod.valueAsNumber = Date.now() - tzOff; } catch { dod.value = todayISO; }
      const hh = pad2(now.getHours()), mm = pad2(now.getMinutes());
      tod.value = `${hh}:${mm}`;
    })();

    function refreshPreview(){
      pvName.textContent = deceased.value || '-';
      pvDob.textContent = dob.value || '-';
      pvDod.textContent = `${dod.value || '-'} ${tod.value || ''}`;
      pvPlace.textContent = place.value || '-';
      const ref = refJJMMHHMM(new Date());
      pvRef.textContent = ref;
      const cat = IMM_CATEGORIES[immCat.value] || '-';
      const det = immDetail.value || '';
      pvImm.textContent = det ? `${cat} - ${det}` : cat;
      pvAnt.textContent = antDetail.value || '-';
      pvDoctor.textContent = doctor.value || '-';
      updateQR(ref);
    }

    function updateQR(ref){
      const data = { name: deceased.value || '', dob: dob.value || '', dod: dod.value || '', tod: tod.value || '', ref: ref || '' };
      const txt = `OMC|Defunt:${data.name}|Naissance:${data.dob}|Deces:${data.dod} ${data.tod}|Ref:${data.ref}`;
      const url = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(txt);
      qrImg.crossOrigin = 'anonymous';
      qrImg.src = url;
      stampInner.textContent = data.ref || 'OMC';
    }

    ['change','keyup','input'].forEach(evt => {
      [deceased, dob, dod, tod, place, immCat, immDetail, antDetail, doctor].forEach(c => c.addEventListener(evt, refreshPreview));
    });

    refreshPreview();

    function ensureImageLoaded(img, fallbackSrc = null){
      return new Promise((resolve) => {
        if (img && img.complete && img.naturalWidth > 0) return resolve();
        if (!img) return resolve();
        const done = () => resolve();
        img.onload = done;
        img.onerror = () => {
          if (fallbackSrc && img.src !== fallbackSrc){
            img.crossOrigin = 'anonymous';
            img.src = fallbackSrc;
            img.onload = done;
            img.onerror = done;
          } else { done(); }
        };
      });
    }

    async function ensureAssetsLoaded(){
      const logoFallback = 'https://i.ibb.co/LzwcCLfN/logo-omc-nord.png';
      await Promise.all([
        ensureImageLoaded(brandLogo, logoFallback),
        ensureImageLoaded(qrImg, null)
      ]);
      await new Promise(r => setTimeout(r, 50));
    }

    async function sendToDiscord(){
      if (!WEBHOOK_CHANNEL_URL){ alert('Webhook Discord non configure.'); return; }
      sendBtn.disabled = true; sendBtn.textContent = 'Impression...';
      try{
        await ensureAssetsLoaded();
        const canvas = await html2canvas(certPreview, { scale: 2, backgroundColor: '#ffffff', useCORS: true, imageTimeout: 10000 });
        const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));

        const ref = pvRef.textContent || refJJMMHHMM(new Date());
        const name = deceased.value || 'Sans nom';
        const contentLines = [
          `**Certificat de deces - Ref ${ref}**`,
          `Defunt : ${name}`,
          `Deces : ${dod.value || '-'} ${tod.value || ''} - Lieu : ${place.value || '-'}`,
          `Cause immediate : ${pvImm.textContent || '-'}`,
          `Cause antecedente : ${antDetail.value || '-'}`,
          `Medecin : ${doctor.value || '-'}`
        ];

        const fd = new FormData();
        fd.append('content', contentLines.join('\n'));
        fd.append('file', blob, `certificat_deces_${ref}.png`);

        const res = await fetch(WEBHOOK_CHANNEL_URL + '?wait=true', { method: 'POST', body: fd });
        if (!res.ok){
          const txt = await res.text().catch(() => '');
          throw new Error('Discord ' + res.status + ' - ' + txt);
        }
        alert('OK: document envoye sur le salon Discord.');
      } catch(e){
        console.error(e);
        alert('Envoi Discord echoue : ' + e.message);
      } finally {
        sendBtn.disabled = false; sendBtn.textContent = 'Imprimer sur copieur (Discord)';
      }
    }

    el('sendBtn').addEventListener('click', sendToDiscord);

    if (location.search.includes('test')){
      try{ const r = refJJMMHHMM(new Date()); console.assert(r.length === 8, 'Ref JJMMHHMM incorrecte: ' + r); console.log('[Tests deces] OK'); } catch(e){ console.error('[Tests deces] FAIL', e); }
    }
  });
  </script>
</body>
</html>

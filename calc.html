<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC — Calcul des coûts</title>
  <link rel="icon" href="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" type="image/png">
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#0b1223; --text:#e5e7eb; --muted:#9ca3af; --ring:#1f2937; --radius:16px;
    }
    *{box-sizing:border-box}
    body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; margin:0}
    .wrap{max-width:1200px;margin:40px auto; padding:0 16px}
    .block{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--ring); border-radius:var(--radius)}
    .header{display:flex; align-items:center; gap:10px; padding:16px 20px; border-bottom:1px solid var(--ring)}
    .header a{appearance:none; border:1px solid var(--ring); border-radius:12px; padding:8px 10px; background:#0b1223; color:var(--text); text-decoration:none}

    /* Disposition 2 colonnes */
    .layout{
      display:grid; gap:16px; padding:16px;
      grid-template-columns: 1fr 340px;
    }
    @media (max-width: 960px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ position:static; top:auto; }
    }

    /* Colonne gauche (contenu) */
    .panel{background:#0b1223; border:1px solid var(--ring); border-radius:var(--radius); padding:14px;}
    .tabs{display:flex; gap:12px; flex-wrap:wrap; margin:6px 0 14px; justify-content:center; padding:10px; background:rgba(15,23,42,.5); border:1px solid var(--ring); border-radius:16px}
    .tab{appearance:none; border:1px solid var(--ring); background:#0b1223; color:#e5e7eb; padding:8px 12px; border-radius:14px; cursor:pointer}
    .tab[aria-selected="true"]{background:linear-gradient(180deg,#0ea5e9,#0284c7); color:#001019; border-color:#0369a1}

    /* Liste en cartes */
    .list{padding:6px}
    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      align-items:stretch;
    }
    .card{
      background:#0b1223; border:1px solid var(--ring); border-radius:14px; padding:12px;
      display:flex; flex-direction:column; gap:10px; min-height:150px;
      transition:transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .card:hover{ transform:translateY(-2px); border-color:#1e2a44; background:#0c1529; }
    .card .title{font-weight:700; line-height:1.25}
    .card .meta{color:#9ca3af; font-size:13px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .pill{font-size:12px; padding:4px 8px; border:1px solid var(--ring); border-radius:999px; color:#cbd5e1}
    .price{color:#cbd5e1; font-weight:600}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .qty{display:inline-flex; align-items:center; gap:6px}
    .qty input{width:56px; padding:8px 10px; border-radius:10px; border:1px solid var(--ring); background:#0b1223; color:#fff; text-align:center}
    .btn{appearance:none;border:1px solid var(--ring);border-radius:10px;padding:6px 10px;background:#0b1223;color:#e5e7eb;cursor:pointer}

    /* Colonne droite (sidebar fixe) */
    .sidebar{
      position:sticky; top:16px;
      background:#0b1223; border:1px solid var(--ring); border-radius:var(--radius); padding:14px;
      display:flex; flex-direction:column; gap:12px; height:fit-content;
    }
    .summary{white-space:pre-wrap; background:#0b1223; border:1px solid var(--ring); border-radius:12px; padding:12px; min-height:140px}
    .total{font-size:28px; font-weight:800}
    .muted{color:#9ca3af}
    .row-spread{display:flex; justify-content:space-between; align-items:center}
  </style>
</head>
<body>
  <div class="wrap block">
    <div class="header">
      <a href="index.html">← Accueil</a>
      <h1 style="margin:0">Calcul des coûts d’intervention (USD)</h1>
    </div>

    <div class="layout">
      <!-- Colonne gauche -->
      <div class="panel">
        <div class="tabs" id="tabs" role="tablist" aria-label="Catégories de soins">
          <button class="tab" role="tab" aria-selected="true"  data-cat="Consultation">Consultation</button>
          <button class="tab" role="tab" aria-selected="false" data-cat="Transport">Transport</button>
          <button class="tab" role="tab" aria-selected="false" data-cat="Soins Hôpital">Soins Hôpital</button>
          <button class="tab" role="tab" aria-selected="false" data-cat="Imagerie">Imagerie</button>
          <button class="tab" role="tab" aria-selected="false" data-cat="Soins sur site">Soins sur site</button>
        </div>
        <div id="list" class="list" aria-live="polite">
          <div class="grid" id="grid"></div>
        </div>
      </div>

      <!-- Colonne droite : récap fixé -->
      <aside class="sidebar" aria-label="Récapitulatif">
        <div class="row-spread"><span>Sous-total</span><strong id="subtotal">$0</strong></div>
        <div class="row" style="gap:10px">
          <span class="muted">TVA</span>
          <label style="display:inline-flex; align-items:center; gap:6px"><input type="checkbox" id="taxEnable"> Activer</label>
          <input type="number" id="taxRate" value="0" min="0" max="100" step="0.5" style="width:80px"> %
          <button id="reset" class="btn" style="margin-left:auto">Réinitialiser</button>
        </div>
        <div class="row-spread"><span>Total</span><span class="total" id="total">$0</span></div>
        <div class="summary" id="summary">— Aucun soin sélectionné —</div>
      </aside>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ====== Données catalogue ======
    const CATALOG = [
      // --- Consultation ---
      { id:'CONS_TRAVAIL',  name:'Certificat aptitude Travail',     priceUSD:450,  category:'Consultation' },
      { id:'CONS_PPA',      name:'Certificat aptitude PPA',         priceUSD:6500, category:'Consultation' },
      { id:'CONS_PSY',      name:'Psychologue',                     priceUSD:275,  category:'Consultation' },
      { id:'CONS_KINE',     name:'Kinésithérapeute',                priceUSD:300,  category:'Consultation' },
      { id:'CONS_MED',      name:'Médecine générale',               priceUSD:225,  category:'Consultation' },
      { id:'CONS_GYNECO',   name:'Gynécologie',                     priceUSD:200,  category:'Consultation' },
      { id:'CONS_INFECTIO', name:'Infectiologue et laboratoire',    priceUSD:350,  category:'Consultation' },

      // --- Transport ---
      { id:'AMBUL_LOCAL',   name:'Transport ambulance locale',      priceUSD:200,  category:'Transport' },
      { id:'TRANS_BAT',     name:'Intervention maritime',           priceUSD:1900, category:'Transport' },
      { id:'TRANS_HEL',     name:'Intervention Hélicoptère',        priceUSD:2900, category:'Transport' },

      // --- Soins Hôpital ---
      { id:'HOP_SOIN',      name:'Soins',                           priceUSD:450,  category:'Soins Hôpital' },
      { id:'HOP_REA',       name:'Réanimation',                     priceUSD:800,  category:'Soins Hôpital' },
      { id:'HOP_CHIR',      name:'Chirurgie',                       priceUSD:3200, category:'Soins Hôpital' },
      { id:'HOP_SUTURE',    name:'Points de suture',                priceUSD:500,  category:'Soins Hôpital' },
      { id:'HOP_ATTELLE',   name:"Fourniture et pose d'une attelle",priceUSD:950,  category:'Soins Hôpital' },
      { id:'HOP_PLATRE',    name:"Fourniture et pose d'un plâtre",  priceUSD:1100, category:'Soins Hôpital' },
      { id:'HOP_PROT',      name:"Fourniture et pose d'une prothèse", priceUSD:6500, category:'Soins Hôpital' },

      // --- Imagerie ---
      { id:'IMG_RADIO',     name:'Radio de contrôle',               priceUSD:480,  category:'Imagerie' },
      { id:'IMG_SCAN',      name:'Scanner de contrôle',             priceUSD:412,  category:'Imagerie' },
      { id:'IMG_IRM',       name:'IRM',                             priceUSD:1119, category:'Imagerie' },
      { id:'IMG_ECHO',      name:'Échographie',                     priceUSD:733,  category:'Imagerie' },

      // --- Soins sur site ---
      { id:'SITE_SOIN',     name:'Soins',                           priceUSD:450,  category:'Soins sur site' },
      { id:'SITE_REA',      name:'Réanimation',                     priceUSD:800,  category:'Soins sur site' },
    ];

    // ====== Références DOM ======
    const els = {
      grid: document.getElementById('grid'),
      tabs: document.getElementById('tabs'),
      summary: document.getElementById('summary'),
      subtotal: document.getElementById('subtotal'),
      total: document.getElementById('total'),
      taxEnable: document.getElementById('taxEnable'),
      taxRate: document.getElementById('taxRate'),
      reset: document.getElementById('reset'),
    };

    // ====== État & helpers ======
    const fmtUSD = (n) => new Intl.NumberFormat('en-US', { style:'currency', currency: 'USD' }).format(n);
    const state = new Map();
    let activeCategory = 'Consultation'; // par défaut

    function syncTabs(){
      for (const btn of els.tabs.querySelectorAll('.tab')) {
        btn.setAttribute('aria-selected', String(btn.dataset.cat === activeCategory));
      }
    }

    function renderList(){
      els.grid.innerHTML = '';
      CATALOG.filter(x => x.category === activeCategory).forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';

        const head = document.createElement('div');
        head.innerHTML = `
          <div class="title">${item.name}</div>
          <div class="meta">${item.id} · <span class="pill">${item.category}</span></div>
        `;

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = fmtUSD(item.priceUSD);

        const controls = document.createElement('div');
        controls.className = 'row';

        const qty = document.createElement('div');
        qty.className = 'qty';
        const minus = document.createElement('button'); minus.textContent='−'; minus.className='btn'; minus.setAttribute('aria-label','Diminuer');
        const input = document.createElement('input'); input.type='number'; input.min='0'; input.step='1'; input.value = state.get(item.id) ?? 0;
        const plus  = document.createElement('button'); plus.textContent='+'; plus.className='btn'; plus.setAttribute('aria-label','Augmenter');

        minus.onclick = () => { const v=Math.max(0, (state.get(item.id)||0)-1); state.set(item.id, v); input.value=v; updateSummary(); };
        plus.onclick  = () => { const v=(state.get(item.id)||0)+1; state.set(item.id, v); input.value=v; updateSummary(); };
        input.oninput = () => { const v=Math.max(0, parseInt(input.value||'0',10)); state.set(item.id, v); input.value=v; updateSummary(); };

        qty.append(minus, input, plus);
        controls.append(price, qty);

        card.append(head, controls);
        els.grid.appendChild(card);
      });
    }

    function compute(){
      let lines = []; let subtotal = 0;
      for(const item of CATALOG){
        const q = state.get(item.id)||0; if(!q) continue;
        const unit = item.priceUSD; const line = unit * q; subtotal += line;
        lines.push(`• ${item.name} × ${q} — ${fmtUSD(line)} (${fmtUSD(unit)}/u)`);
      }
      const taxEnabled = els.taxEnable.checked;
      const taxRate = Math.max(0, Number(els.taxRate.value||0));
      const taxValue = taxEnabled ? (subtotal * taxRate/100) : 0;
      const total = subtotal + taxValue;
      return { lines, subtotal, taxEnabled, taxRate, taxValue, total };
    }

    function updateSummary(){
      const {lines, subtotal, total} = compute();
      els.summary.textContent = lines.length ? lines.join('\n') : '— Aucun soin sélectionné —';
      els.subtotal.textContent = fmtUSD(subtotal);
      els.total.textContent = fmtUSD(total);
      els.taxRate.disabled = !els.taxEnable.checked;
      els.taxRate.style.opacity = els.taxEnable.checked ? 1 : .6;
    }

    // ====== Événements ======
    els.tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab'); if (!btn) return;
      activeCategory = btn.dataset.cat; syncTabs(); renderList(); updateSummary();
    });
    els.taxEnable.addEventListener('change', updateSummary);
    els.taxRate.addEventListener('input', updateSummary);
    els.reset.addEventListener('click', ()=>{ state.clear(); updateSummary(); renderList(); });

    // ====== Init ======
    syncTabs(); renderList(); updateSummary();

    // Test optionnel: ?test dans l’URL
    if(location.search.includes('test')){
      try{
        state.clear();
        state.set('CONS_TRAVAIL',2);   // 2 × 450 = 900
        state.set('HOP_PLATRE',1);     // + 1100 = 2000
        const r1 = compute(); console.assert(r1.subtotal===2000, 'Sous-total attendu 2000, obtenu: '+r1.subtotal);
        els.taxEnable.checked = true; els.taxRate.value = 10;
        const r2 = compute(); console.assert(r2.total===2200, 'Total attendu 2200, obtenu: '+r2.total);
        console.log('%c[Tests calc] OK','color:#22c55e');
        updateSummary();
      }catch(e){ console.error('[Tests calc] FAIL', e); }
    }
  });
  </script>
</body>
</html>

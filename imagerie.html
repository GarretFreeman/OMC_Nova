<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC — Imagerie (avec calibration)</title>
  <link rel="icon" href="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" type="image/png">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --panel-2:#0b1223; --text:#e5e7eb; --muted:#9ca3af; --ring:#1f2937; --radius:16px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; margin:0}
    .wrap{max-width:1200px;margin:40px auto; padding:0 16px}
    .block{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--ring); border-radius:var(--radius)}
    .header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:16px 20px; border-bottom:1px solid var(--ring)}
    .header .brand{display:flex; align-items:center; gap:10px}
    .btn{appearance:none; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; background:#0b1223; color:#e5e7eb; cursor:pointer; text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7); color:#001019; border-color:#0369a1}
    .panel{background:#0b1223; border:1px solid var(--ring); border-radius:var(--radius); padding:16px; margin:16px}

    .main-grid{display:grid; grid-template-columns:1fr 1.1fr; gap:16px; align-items:stretch}
    @media (max-width:1000px){ .main-grid{grid-template-columns:1fr} }

    .bodymap{position:relative; width:100%; background:#0b1223; border:1px solid var(--ring); border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:center}
    .bodyframe{position:relative; width:min(520px,100%); aspect-ratio:418/940;}
    .body-bg{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:.95; filter:drop-shadow(0 8px 24px rgba(0,0,0,.45));}
    svg.overlay{position:absolute; inset:0; width:100%; height:100%}

    .controls{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; color:#9ca3af}
    input,textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:#0b1223; color:var(--text)}
    textarea{min-height:80px; resize:vertical}
    .lesions-grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px}
    .chip{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid var(--ring); border-radius:12px; background:#0b1223; cursor:pointer; user-select:none}
    .chip.active{outline:2px solid #38bdf8}
    .dot{width:14px; height:14px; border-radius:50%}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}

    .report{background:#030712; border:1px solid var(--ring); border-radius:12px; padding:14px; font-size:13px; line-height:1.5}
    .report h4{margin:0 0 6px; font-size:14px; color:#cbd5e1}
    .report small{color:#94a3b8}
    .report ol{margin:8px 0 0 18px; padding:0}
    .report li{margin:4px 0}
    .report .badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--ring); border-radius:999px; font-size:12px; margin-right:6px}
    .report .badge .bdot{width:10px; height:10px; border-radius:50%}

    .legend{display:flex; flex-wrap:wrap; gap:10px; font-size:12px; color:#cbd5e1}
    .legend .item{display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid var(--ring); border-radius:10px; background:#0b1223}

    .marker{cursor:grab}
    .marker:active{cursor:grabbing}
    .marker text{font:600 10px ui-sans-serif,system-ui; fill:#0b1223}

    /* === Calibration UI === */
    .calibbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:10px 0}
    .calibnote{font-size:12px; color:#9ca3af}
    .coords{font-size:12px; color:#cbd5e1; padding:4px 8px; border:1px solid var(--ring); border-radius:8px; background:#0b1223}
    .export{width:100%; min-height:100px; background:#030712; color:#e5e7eb; border:1px solid var(--ring); border-radius:8px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
    .handle{cursor:move}
    .calib-label{font:600 10px ui-sans-serif,system-ui}

    /* Impression : cacher calibration + contrôles */
    @media print{
      .header,.controls,.actions,.calibbar,#exportWrap,.history{display:none !important}
      .panel{border:none; margin:0; padding:0}
      .print-header{display:block !important}
      .report{page-break-inside:avoid}
      .legend{display:none !important}
    }
    .print-header{display:none; margin:0 16px 8px; color:#e5e7eb}
    .print-header h2{margin:0 0 6px}
    .muted{color:#94a3b8; font-size:12px}
  </style>
</head>
<body>
  <div class="wrap block">
    <div class="header">
      <div class="brand">
        <a class="btn" href="index.html">← Accueil</a>
        <h1 style="margin:0">Imagerie médicale</h1>
      </div>
      <div style="display:flex; gap:8px">
        <button id="btnPrint" class="btn">Imprimer</button>
      </div>
    </div>

    <div class="print-header" id="printHeader">
      <h2>Constat lésionnel — OMC</h2>
      <div class="muted" id="printMeta"></div>
    </div>

    <div class="panel">
      <div class="main-grid">
        <!-- Colonne gauche -->
        <section>
          <h3 style="margin:0 0 10px; color:#9ca3af">Localiser les lésions</h3>
          <div class="bodymap">
            <div class="bodyframe" id="frame">
              <img class="body-bg" src="assets/corps-humain.png" alt="Silhouette anatomique (face)">
              <svg class="overlay" id="overlay" viewBox="0 0 418 940" xmlns="http://www.w3.org/2000/svg" aria-label="Localisation des lésions">
                <!-- calque des marqueurs -->
                <g id="markersLayer"></g>
                <!-- calque calibration (dessiné quand actif) -->
                <g id="calibLayer"></g>
              </svg>
            </div>
          </div>

          <!-- Barre calibration -->
          <div class="calibbar">
            <button id="btnCalib" class="btn">Activer calibration</button>
            <button id="btnCalibLabels" class="btn">Masquer étiquettes</button>
            <button id="btnExport" class="btn">Exporter JSON</button>
            <span class="coords" id="coords">x: —, y: —</span>
            <span class="calibnote">Astuce : drag = déplacer, Alt+drag = déplacer la forme entière, ↑↓←→ = pas fin (⇧ = ×10)</span>
          </div>
          <div id="exportWrap" style="display:none">
            <textarea id="exportBox" class="export" readonly></textarea>
          </div>

          <!-- Légende (hors constat) -->
          <div class="legend" id="legend"></div>
        </section>

        <!-- Colonne droite -->
        <section>
          <div class="controls">
            <div class="field">
              <label class="label">Nom / ID patient</label>
              <input id="patientId" type="text" placeholder="Ex: John Doe #SS-204">
            </div>
            <div class="field">
              <label class="label">Commentaires</label>
              <textarea id="comments" placeholder="Notes pour le dossier…"></textarea>
            </div>
          </div>

          <div class="field" style="margin-bottom:8px">
            <label class="label">Choisir un type de lésion puis cliquer sur l’image</label>
            <div class="lesions-grid" id="lesionsGrid"></div>
          </div>

          <div class="actions">
            <button id="btnUndo" class="btn">Annuler le dernier point</button>
            <button id="btnClear" class="btn">Effacer toutes les lésions</button>
            <button id="btnToggleNumbers" class="btn">Afficher/Masquer numéros</button>
          </div>

          <div class="report" id="reportBox">
            <h4>Constat lésionnel</h4>
            <small id="reportMeta">Patient : — • Date : —</small>
            <ol id="reportList"></ol>
            <div id="reportSummary" style="margin-top:10px"></div>
          </div>

          <div class="history" id="history" style="background:#030712; border:1px solid var(--ring); border-radius:12px; padding:10px; max-height:220px; overflow:auto; font-size:12px; color:#9ca3af; margin-top:12px"></div>
        </section>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ================== LÉSIONS ================== */
    const LESIONS = [
      {key:'fracture',      label:'Fracture',               color:'#ef4444', code:'FX'},
      {key:'entorse',       label:'Entorse',                color:'#f59e0b', code:'EN'},
      {key:'luxation',      label:'Luxation',               color:'#10b981', code:'LX'},
      {key:'contusion',     label:'Contusion',              color:'#3b82f6', code:'CT'},
      {key:'plaie_blanche', label:'Plaie arme blanche',     color:'#a855f7', code:'PB'},
      {key:'plaie_feu',     label:'Plaie arme à feu',       color:'#b91c1c', code:'PAF'},
      {key:'brulure',       label:'Brûlure',                color:'#eab308', code:'BR'}
    ];
    const LMAP = Object.fromEntries(LESIONS.map(l => [l.key, l]));

    /* ============== RÉGIONS (calibrables) ============== */
    // Coordonnées initiales (issues de ta version précédente)
    [
  {
    "id": "tete",
    "label": "Téte",
    "type": "poly",
    "points": [
      [
        215,
        20
      ],
      [
        235,
        30
      ],
      [
        245,
        45
      ],
      [
        250,
        60
      ],
      [
        250,
        75
      ],
      [
        255,
        80
      ],
      [
        255,
        95
      ],
      [
        245,
        105
      ],
      [
        240,
        120
      ],
      [
        185,
        120
      ],
      [
        180,
        105
      ],
      [
        175,
        95
      ],
      [
        170,
        80
      ],
      [
        174,
        60
      ],
      [
        175,
        45
      ],
      [
        190,
        30
      ],
      [
        200,
        20
      ],
      [
        215,
        20
      ],
      [
        215,
        20
      ]
    ]
  },
  {
    "id": "cou",
    "label": "Cou",
    "type": "poly",
    "points": [
      [
        185,
        125
      ],
      [
        240,
        123
      ],
      [
        240,
        146
      ],
      [
        185,
        145
      ],
      [
        185,
        125
      ]
    ]
  },
  {
    "id": "epaule_droite",
    "label": "Epaule Droite",
    "type": "poly",
    "points": [
      [
        175,
        155
      ],
      [
        140,
        170
      ],
      [
        95,
        195
      ],
      [
        135,
        265
      ],
      [
        160,
        220
      ],
      [
        175,
        175
      ]
    ]
  },
  {
    "id": "epaule_gauche",
    "label": "Epaule Gauche",
    "type": "poly",
    "points": [
      [
        250,
        150
      ],
      [
        300,
        175
      ],
      [
        320,
        185
      ],
      [
        325,
        190
      ],
      [
        290,
        265
      ],
      [
        260,
        205
      ],
      [
        250,
        150
      ]
    ]
  },
  {
    "id": "thorax",
    "label": "Thorax",
    "type": "poly",
    "points": [
      [
        180,
        155
      ],
      [
        240,
        155
      ],
      [
        253,
        217
      ],
      [
        279,
        266
      ],
      [
        275,
        305
      ],
      [
        149,
        301
      ],
      [
        145,
        265
      ],
      [
        170,
        220
      ]
    ]
  },
  {
    "id": "abdomen",
    "label": "Abdomen",
    "type": "poly",
    "points": [
      [
        150,
        310
      ],
      [
        275,
        314
      ],
      [
        280,
        360
      ],
      [
        285,
        395
      ],
      [
        145,
        395
      ],
      [
        145,
        315
      ]
    ]
  },
  {
    "id": "hanche",
    "label": "Hanche",
    "type": "poly",
    "points": [
      [
        140,
        400
      ],
      [
        285,
        405
      ],
      [
        295,
        440
      ],
      [
        295,
        470
      ],
      [
        130,
        470
      ],
      [
        135,
        425
      ]
    ]
  },
  {
    "id": "cuisse_gauche",
    "label": "Cuisse Gauche",
    "type": "poly",
    "points": [
      [
        215,
        475
      ],
      [
        295,
        475
      ],
      [
        290,
        575
      ],
      [
        285,
        620
      ],
      [
        230,
        620
      ],
      [
        220,
        540
      ],
      [
        220,
        505
      ]
    ]
  },
  {
    "id": "cuisse_droite",
    "label": "Cuisse Droite",
    "type": "poly",
    "points": [
      [
        130,
        475
      ],
      [
        205,
        475
      ],
      [
        205,
        515
      ],
      [
        200,
        575
      ],
      [
        195,
        620
      ],
      [
        140,
        620
      ],
      [
        135,
        575
      ],
      [
        130,
        525
      ]
    ]
  },
  {
    "id": "genoux_gauche",
    "label": "Genoux Gauche",
    "type": "poly",
    "points": [
      [
        230,
        626
      ],
      [
        285,
        626
      ],
      [
        285,
        661
      ],
      [
        235,
        656
      ],
      [
        235,
        646
      ]
    ]
  },
  {
    "id": "genoux_droit",
    "label": "Genoux Droit",
    "type": "poly",
    "points": [
      [
        140,
        625
      ],
      [
        190,
        625
      ],
      [
        190,
        660
      ],
      [
        140,
        660
      ],
      [
        140,
        640
      ]
    ]
  },
  {
    "id": "jambe_gauche",
    "label": "Jambe Gauche",
    "type": "poly",
    "points": [
      [
        235,
        664
      ],
      [
        285,
        670
      ],
      [
        285,
        750
      ],
      [
        270,
        815
      ],
      [
        270,
        825
      ],
      [
        245,
        820
      ],
      [
        240,
        765
      ],
      [
        235,
        730
      ],
      [
        235,
        695
      ]
    ]
  },
  {
    "id": "jambe_droite",
    "label": "Jambe Droite",
    "type": "poly",
    "points": [
      [
        140,
        665
      ],
      [
        190,
        665
      ],
      [
        190,
        730
      ],
      [
        185,
        760
      ],
      [
        180,
        795
      ],
      [
        180,
        820
      ],
      [
        155,
        815
      ],
      [
        145,
        760
      ],
      [
        140,
        725
      ],
      [
        140,
        675
      ]
    ]
  },
  {
    "id": "cheville_gauche",
    "label": "Cheville Gauche",
    "type": "poly",
    "points": [
      [
        245,
        825
      ],
      [
        270,
        830
      ],
      [
        275,
        860
      ],
      [
        245,
        875
      ],
      [
        240,
        855
      ],
      [
        245,
        835
      ]
    ]
  },
  {
    "id": "cheville_droite",
    "label": "Cheville Droite",
    "type": "poly",
    "points": [
      [
        155,
        825
      ],
      [
        180,
        825
      ],
      [
        185,
        855
      ],
      [
        150,
        855
      ],
      [
        155,
        840
      ]
    ]
  },
  {
    "id": "pied_gauche",
    "label": "Pied Gauche",
    "type": "poly",
    "points": [
      [
        280,
        860
      ],
      [
        300,
        885
      ],
      [
        295,
        895
      ],
      [
        280,
        905
      ],
      [
        260,
        905
      ],
      [
        250,
        890
      ],
      [
        250,
        880
      ],
      [
        260,
        870
      ]
    ]
  },
  {
    "id": "pied_droit",
    "label": "Pied Droit",
    "type": "poly",
    "points": [
      [
        160,
        905
      ],
      [
        135,
        900
      ],
      [
        125,
        890
      ],
      [
        130,
        875
      ],
      [
        145,
        860
      ],
      [
        165,
        860
      ],
      [
        185,
        860
      ],
      [
        180,
        875
      ],
      [
        175,
        895
      ],
      [
        170,
        900
      ]
    ]
  },
  {
    "id": "bras_gauche",
    "label": "Bras Gauche",
    "type": "poly",
    "points": [
      [
        335,
        425
      ],
      [
        310,
        355
      ],
      [
        305,
        310
      ],
      [
        295,
        270
      ],
      [
        330,
        195
      ],
      [
        335,
        235
      ],
      [
        335,
        285
      ],
      [
        340,
        310
      ],
      [
        350,
        340
      ],
      [
        360,
        410
      ],
      [
        365,
        430
      ],
      [
        340,
        435
      ]
    ]
  },
  {
    "id": "poignet_gauche",
    "label": "Poignet Gauche",
    "type": "poly",
    "points": [
      [
        340,
        460
      ],
      [
        380,
        455
      ],
      [
        365,
        445
      ],
      [
        365,
        435
      ],
      [
        350,
        435
      ],
      [
        340,
        445
      ]
    ]
  },
  {
    "id": "main_gauche",
    "label": "Main Gauche",
    "type": "poly",
    "points": [
      [
        385,
        530
      ],
      [
        355,
        530
      ],
      [
        345,
        520
      ],
      [
        340,
        480
      ],
      [
        340,
        465
      ],
      [
        355,
        460
      ],
      [
        370,
        460
      ],
      [
        385,
        465
      ],
      [
        400,
        485
      ],
      [
        400,
        495
      ],
      [
        385,
        485
      ]
    ]
  },
  {
    "id": "bras_droit",
    "label": "Bras Droit",
    "type": "poly",
    "points": [
      [
        90,
        430
      ],
      [
        65,
        425
      ],
      [
        70,
        385
      ],
      [
        75,
        345
      ],
      [
        85,
        315
      ],
      [
        90,
        265
      ],
      [
        95,
        220
      ],
      [
        95,
        205
      ],
      [
        130,
        270
      ],
      [
        125,
        310
      ],
      [
        120,
        345
      ],
      [
        110,
        380
      ]
    ]
  },
  {
    "id": "poignet_droit",
    "label": "Poignet Droit",
    "type": "poly",
    "points": [
      [
        85,
        460
      ],
      [
        50,
        450
      ],
      [
        60,
        440
      ],
      [
        60,
        430
      ],
      [
        75,
        430
      ],
      [
        80,
        430
      ],
      [
        85,
        440
      ]
    ]
  },
  {
    "id": "main_droite",
    "label": "Main Droite",
    "type": "poly",
    "points": [
      [
        80,
        520
      ],
      [
        70,
        530
      ],
      [
        55,
        530
      ],
      [
        40,
        525
      ],
      [
        45,
        495
      ],
      [
        45,
        480
      ],
      [
        35,
        495
      ],
      [
        25,
        495
      ],
      [
        30,
        480
      ],
      [
        45,
        455
      ],
      [
        60,
        455
      ],
      [
        75,
        460
      ],
      [
        85,
        470
      ],
      [
        85,
        505
      ],
      [
        85,
        515
      ]
    ]
  }
]
    /* ============== DOM ============== */
    const overlay = document.getElementById('overlay');
    const markersLayer = document.getElementById('markersLayer');
    const calibLayer = document.getElementById('calibLayer');
    const frame = document.getElementById('frame');

    const legendBox = document.getElementById('legend');
    const lesionsGrid = document.getElementById('lesionsGrid');
    const historyBox = document.getElementById('history');
    const patientId = document.getElementById('patientId');
    const comments = document.getElementById('comments');

    const btnUndo = document.getElementById('btnUndo');
    const btnClear = document.getElementById('btnClear');
    const btnToggleNumbers = document.getElementById('btnToggleNumbers');
    const btnPrint = document.getElementById('btnPrint');

    // Calibration
    const btnCalib = document.getElementById('btnCalib');
    const btnCalibLabels = document.getElementById('btnCalibLabels');
    const btnExport = document.getElementById('btnExport');
    const coordsEl = document.getElementById('coords');
    const exportWrap = document.getElementById('exportWrap');
    const exportBox = document.getElementById('exportBox');

    // Constat
    const reportMeta = document.getElementById('reportMeta');
    const reportList = document.getElementById('reportList');
    const reportSummary = document.getElementById('reportSummary');
    const printMeta = document.getElementById('printMeta');

    /* ============== ÉTATS ============== */
    let activeType = LESIONS[0].key;
    let showNumbers = true;
    const markers = []; // {id,type,x,y}
    let drag = {on:false, id:null, dx:0, dy:0};

    // Calibration
    let calibOn = false;
    let showCalibLabels = true;
    let selection = { regionId:null, pointIndex:null }; // pour polygone

    /* ============== UTILS ============== */
    function logH(msg){ const t=new Date().toLocaleString(); const d=document.createElement('div'); d.innerHTML=`<b>[${t}]</b> ${msg}`; historyBox.prepend(d); }
    function svgPoint(evt){
      const pt = overlay.createSVGPoint();
      pt.x = evt.clientX; pt.y = evt.clientY;
      const out = pt.matrixTransform(overlay.getScreenCTM().inverse());
      return { x: Math.max(0, Math.min(418, out.x)), y: Math.max(0, Math.min(940, out.y)) };
    }
    const clamp = (x, min, max) => Math.max(min, Math.min(max, x));

    /* ============== HIT-TEST ============== */
    function inRect(x,y, r){ return x>=r.x && x<=r.x+r.w && y>=r.y && y<=r.y+r.h; }
    function inCircle(x,y, c){ const dx=x-c.cx, dy=y-c.cy; return (dx*dx+dy*dy) <= c.r*c.r; }
    function inPoly(x,y, pts){
      let inside=false;
      for(let i=0,j=pts.length-1;i<pts.length;j=i++){
        const xi=pts[i][0], yi=pts[i][1], xj=pts[j][0], yj=pts[j][1];
        const intersect = ((yi>y)!==(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi+1e-9) + xi);
        if(intersect) inside=!inside;
      }
      return inside;
    }
    function pointInShape(r,x,y){
      if(r.type==='rect')   return inRect(x,y,r);
      if(r.type==='circle') return inCircle(x,y,r);
      if(r.type==='poly')   return inPoly(x,y,r.points);
      return false;
    }
    function regionFrom(x,y){
      for(const r of REGIONS){
        if(pointInShape(r,x,y)){
          if(r.label.startsWith('jambe')){
            if(y<600) return r.label+' (cuisse/genou)';
            if(y<780) return r.label+' (jambe)';
            return r.label+' (cheville/pied)';
          }
          if(r.label.startsWith('bras')){
            if(y<360) return r.label+' (bras/épaule)';
            if(y<520) return r.label+' (coude/avant-bras)';
            return r.label+' (poignet/main)';
          }
          return r.label;
        }
      }
      const side = x<209?'gauche':'droite';
      if(y<200) return 'tête';
      if(y<420) return 'thorax';
      if(y<520) return 'abdomen/pelvis';
      if(y<740) return `membre ${side} (cuisse/genou)`;
      return `membre ${side} (jambe/cheville)`;
    }

    /* ============== REPORT ============== */
    function updateReport(){
      const now = new Date().toLocaleString();
      reportMeta.textContent = `Patient : ${patientId.value || '—'} • Date : ${now}${comments.value ? ' • Notes : ' + comments.value : ''}`;
      reportList.innerHTML = '';
      const perTypeCount = {};
      const perTypeIndex = {};
      markers.forEach(m => {
        perTypeCount[m.type]=(perTypeCount[m.type]||0)+1;
        perTypeIndex[m.type]=(perTypeIndex[m.type]||0)+1;
        const idx = perTypeIndex[m.type];
        const li = document.createElement('li');
        li.innerHTML = `<span class="badge"><span class="bdot" style="background:${LMAP[m.type].color}"></span>${LMAP[m.type].label}</span>
        N°${idx} — localisation estimée : ${regionFrom(m.x,m.y)}.`;
        reportList.appendChild(li);
      });
      const summary = Object.entries(LMAP).map(([k,l])=>{
        const n = perTypeCount[k]||0;
        return `<span class="badge"><span class="bdot" style="background:${l.color}"></span>${l.label} : ${n}</span>`;
      }).join(' ');
      reportSummary.innerHTML = summary || '<small>Aucune lésion renseignée.</small>';
    }

    /* ============== MARQUEURS (lésions) ============== */
    function rebuildNumbers(){
      const perType = {};
      markers.forEach(m => {
        perType[m.type]=(perType[m.type]||0)+1;
        const n = perType[m.type];
        const node = markersLayer.querySelector(`g.marker[data-id="${m.id}"] text`);
        if(node) node.textContent = showNumbers ? String(n) : '';
      });
    }
    function markerNode(m){
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','marker');
      g.setAttribute('data-id', m.id);
      g.setAttribute('transform', `translate(${m.x},${m.y})`);

      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r','10');
      c.setAttribute('fill', LMAP[m.type].color);
      c.setAttribute('stroke','#0b1223');
      c.setAttribute('stroke-width','2');

      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x','0'); t.setAttribute('y','3');
      t.setAttribute('text-anchor','middle');
      t.textContent = '';

      g.appendChild(c); g.appendChild(t);

      g.addEventListener('pointerdown', (e)=>{
        if(calibOn) return; // en mode calib on évite de déplacer des marqueurs par erreur
        e.stopPropagation();
        g.setPointerCapture(e.pointerId);
        drag.on=true; drag.id=m.id;
        const p=svgPoint(e);
        drag.dx=m.x - p.x; drag.dy=m.y - p.y;
      });
      g.addEventListener('pointermove', (e)=>{
        if(calibOn) return;
        if(!drag.on || drag.id!==m.id) return;
        const p=svgPoint(e);
        m.x = clamp(p.x + drag.dx,0,418); m.y = clamp(p.y + drag.dy,0,940);
        g.setAttribute('transform', `translate(${m.x},${m.y})`);
      });
      g.addEventListener('pointerup', ()=>{
        if(calibOn) return;
        drag.on=false; drag.id=null; updateReport(); logH(`Marqueur déplacé — ${LMAP[m.type].label}`);
      });
      g.addEventListener('click', (e)=>{
        if(calibOn) return;
        if(e.altKey){
          const idx = markers.findIndex(mm => mm.id===m.id);
          if(idx>-1){ markers.splice(idx,1); }
          markersLayer.removeChild(g);
          rebuildNumbers(); updateReport(); logH(`Marqueur supprimé — ${LMAP[m.type].label}`);
        }
      });
      return g;
    }
    function addMarker(pt, type){
      const m = { id: 'm'+crypto.randomUUID(), type, x: pt.x, y: pt.y };
      markers.push(m);
      markersLayer.appendChild(markerNode(m));
      rebuildNumbers(); updateReport();
      logH(`Ajout ${LMAP[type].label} @ x:${Math.round(pt.x)} y:${Math.round(pt.y)}`);
    }

    /* ============== PALETTE ============== */
    function buildPalette(){
      lesionsGrid.innerHTML='';
      LESIONS.forEach(l=>{
        const chip = document.createElement('div');
        chip.className='chip' + (l.key===activeType?' active':'');
        chip.setAttribute('data-key', l.key);
        chip.innerHTML = `<span class="dot" style="background:${l.color}"></span><span>${l.label}</span>`;
        chip.addEventListener('click', ()=>{
          [...lesionsGrid.children].forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          activeType = l.key;
          frame.style.cursor='crosshair';
          logH(`Lésion sélectionnée — ${l.label}. Cliquez sur l'image pour placer.`);
        });
        lesionsGrid.appendChild(chip);
      });
    }

    /* ============== LÉGENDE LÉSIONS ============== */
    function redrawLegend(){
      const counts = {};
      markers.forEach(m => counts[m.type]=(counts[m.type]||0)+1);
      legendBox.innerHTML='';
      LESIONS.forEach(l => {
        const item = document.createElement('div');
        item.className='item';
        item.innerHTML = `<span class="dot" style="width:12px;height:12px;background:${l.color}"></span><span>${l.label} — ${counts[l.key]||0}</span>`;
        legendBox.appendChild(item);
      });
    }

    /* ============== CALIBRATION RENDER ============== */
    function drawCalib(){
      calibLayer.innerHTML = '';
      if(!calibOn) return;

      REGIONS.forEach((r, idx)=>{
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('data-rid', r.id);

        // Couleur de calque (semi-transparente)
        const stroke = 'rgba(56,189,248,0.9)'; // cyan
        const fill   = 'rgba(56,189,248,0.15)';

        let shapeNode, labelNode;

        if(r.type==='rect'){
          shapeNode = document.createElementNS('http://www.w3.org/2000/svg','rect');
          shapeNode.setAttribute('x',r.x); shapeNode.setAttribute('y',r.y);
          shapeNode.setAttribute('width',r.w); shapeNode.setAttribute('height',r.h);
          shapeNode.setAttribute('rx', 8);
        } else if(r.type==='circle'){
          shapeNode = document.createElementNS('http://www.w3.org/2000/svg','circle');
          shapeNode.setAttribute('cx',r.cx); shapeNode.setAttribute('cy',r.cy);
          shapeNode.setAttribute('r',r.r);
        } else if(r.type==='poly'){
          shapeNode = document.createElementNS('http://www.w3.org/2000/svg','polygon');
          shapeNode.setAttribute('points', r.points.map(p=>p.join(',')).join(' '));
        }

        shapeNode.setAttribute('fill', fill);
        shapeNode.setAttribute('stroke', stroke);
        shapeNode.setAttribute('stroke-width', '2');
        shapeNode.classList.add('handle');

        // Etiquette
        labelNode = document.createElementNS('http://www.w3.org/2000/svg','text');
        labelNode.setAttribute('x', 6);
        labelNode.setAttribute('y', 16 + idx*0.01); // éviter recouvrement exact
        labelNode.setAttribute('class','calib-label');
        labelNode.setAttribute('fill', 'white');
        labelNode.textContent = r.label;
        if(!showCalibLabels) labelNode.setAttribute('display','none');

        g.appendChild(shapeNode);

        // Handles pour polygone
        if(r.type==='poly'){
          r.points.forEach((p,pi)=>{
            const h = document.createElementNS('http://www.w3.org/2000/svg','rect');
            h.setAttribute('x', p[0]-4); h.setAttribute('y', p[1]-4);
            h.setAttribute('width', 8); h.setAttribute('height', 8);
            h.setAttribute('fill', '#f97316'); // orange
            h.setAttribute('stroke', '#111827');
            h.setAttribute('stroke-width', '1.5');
            h.setAttribute('data-point', pi);
            h.classList.add('handle');

            // drag sommet
            h.addEventListener('pointerdown', (e)=>{
              e.stopPropagation(); h.setPointerCapture(e.pointerId);
              selection = { regionId:r.id, pointIndex:pi };
            });
            h.addEventListener('pointermove', (e)=>{
              if(selection.regionId!==r.id || selection.pointIndex!==pi) return;
              const pnt = svgPoint(e);
              r.points[pi][0] = clamp(Math.round(pnt.x),0,418);
              r.points[pi][1] = clamp(Math.round(pnt.y),0,940);
              drawCalib(); // redraw en live
            });
            h.addEventListener('pointerup', ()=>{
              selection = {regionId:null, pointIndex:null};
              drawCalib();
              logH(`Sommet ajusté — ${r.label} [${pi}]`);
            });

            g.appendChild(h);
          });
        } else {
          // Drag de la forme entière (rect/circle) + Alt+drag pour poly (géré ci-dessous)
          shapeNode.addEventListener('pointerdown', (e)=>{
            e.stopPropagation(); shapeNode.setPointerCapture(e.pointerId);
            selection = { regionId:r.id, pointIndex:null, ox:e.clientX, oy:e.clientY, rx:JSON.parse(JSON.stringify(r)) };
          });
          shapeNode.addEventListener('pointermove', (e)=>{
            if(selection.regionId!==r.id) return;
            const dx = (e.clientX - selection.ox) * (418 / overlay.clientWidth);
            const dy = (e.clientY - selection.oy) * (940 / overlay.clientHeight);
            if(r.type==='rect'){
              r.x = clamp(Math.round(selection.rx.x + dx),0,418-r.w);
              r.y = clamp(Math.round(selection.rx.y + dy),0,940-r.h);
            }else if(r.type==='circle'){
              r.cx = clamp(Math.round(selection.rx.cx + dx),0,418);
              r.cy = clamp(Math.round(selection.rx.cy + dy),0,940);
            }
            drawCalib();
          });
          shapeNode.addEventListener('pointerup', ()=>{
            selection = {regionId:null, pointIndex:null};
            drawCalib();
            logH(`Forme déplacée — ${r.label}`);
          });
        }

        // Alt+drag pour déplacer un polygone entier
        if(r.type==='poly'){
          shapeNode.addEventListener('pointerdown', (e)=>{
            if(!e.altKey) return; e.stopPropagation(); shapeNode.setPointerCapture(e.pointerId);
            selection = { regionId:r.id, movingPoly:true, ox:e.clientX, oy:e.clientY, orig: r.points.map(p=>p.slice()) };
          });
          shapeNode.addEventListener('pointermove', (e)=>{
            if(!selection.movingPoly || selection.regionId!==r.id) return;
            const dx = (e.clientX - selection.ox) * (418 / overlay.clientWidth);
            const dy = (e.clientY - selection.oy) * (940 / overlay.clientHeight);
            r.points = selection.orig.map(p=>[ clamp(Math.round(p[0]+dx),0,418), clamp(Math.round(p[1]+dy),0,940) ]);
            drawCalib();
          });
          shapeNode.addEventListener('pointerup', ()=>{
            if(!selection.movingPoly) return;
            selection = {regionId:null, pointIndex:null};
            drawCalib();
            logH(`Polygone déplacé — ${r.label}`);
          });
        }

        // Clic pour surligner la région sélectionnée
        g.addEventListener('click', () => {
          selection.regionId = r.id;
          drawCalib();
        });

        // Style si sélection
        if(selection.regionId===r.id){
          shapeNode.setAttribute('stroke', '#22c55e'); // vert
          shapeNode.setAttribute('stroke-width', '3');
        }

        g.appendChild(labelNode);
        calibLayer.appendChild(g);
      });
    }

    // clavier : nudges
    window.addEventListener('keydown', (e)=>{
      if(!calibOn || !selection.regionId) return;
      const r = REGIONS.find(R=>R.id===selection.regionId);
      const step = e.shiftKey ? 10 : 1;
      let moved = false;

      if(r.type==='poly'){
        if(selection.pointIndex!=null){
          if(e.key==='ArrowLeft'){ r.points[selection.pointIndex][0] = clamp(r.points[selection.pointIndex][0]-step,0,418); moved=true; }
          if(e.key==='ArrowRight'){ r.points[selection.pointIndex][0] = clamp(r.points[selection.pointIndex][0]+step,0,418); moved=true; }
          if(e.key==='ArrowUp'){ r.points[selection.pointIndex][1] = clamp(r.points[selection.pointIndex][1]-step,0,940); moved=true; }
          if(e.key==='ArrowDown'){ r.points[selection.pointIndex][1] = clamp(r.points[selection.pointIndex][1]+step,0,940); moved=true; }
        } else {
          // nudge du poly entier
          if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
            const dx = (e.key==='ArrowLeft'?-step:(e.key==='ArrowRight'?step:0));
            const dy = (e.key==='ArrowUp'?-step:(e.key==='ArrowDown'?step:0));
            r.points = r.points.map(p=>[ clamp(p[0]+dx,0,418), clamp(p[1]+dy,0,940) ]);
            moved=true;
          }
        }
      } else if(r.type==='rect'){
        if(e.key==='ArrowLeft'){ r.x = clamp(r.x-step,0,418-r.w); moved=true; }
        if(e.key==='ArrowRight'){ r.x = clamp(r.x+step,0,418-r.w); moved=true; }
        if(e.key==='ArrowUp'){ r.y = clamp(r.y-step,0,940-r.h); moved=true; }
        if(e.key==='ArrowDown'){ r.y = clamp(r.y+step,0,940-r.h); moved=true; }
      } else if(r.type==='circle'){
        if(e.key==='ArrowLeft'){ r.cx = clamp(r.cx-step,0,418); moved=true; }
        if(e.key==='ArrowRight'){ r.cx = clamp(r.cx+step,0,418); moved=true; }
        if(e.key==='ArrowUp'){ r.cy = clamp(r.cy-step,0,940); moved=true; }
        if(e.key==='ArrowDown'){ r.cy = clamp(r.cy+step,0,940); moved=true; }
      }

      if(moved){ e.preventDefault(); drawCalib(); }
    });

    // coords souris
    overlay.addEventListener('pointermove', (e)=>{
      const p = svgPoint(e);
      coordsEl.textContent = `x: ${Math.round(p.x)}, y: ${Math.round(p.y)}`;
    });

    /* ============== INTERACTIONS GÉNÉRALES ============== */
    overlay.addEventListener('click', (e)=>{
      if(calibOn) return; // en mode calib : pas de pose de marqueurs
      const pt = svgPoint(e);
      addMarker(pt, activeType);
      redrawLegend();
    });

    btnUndo.addEventListener('click', ()=>{
      const last = markers.pop(); if(!last) return;
      const node = markersLayer.querySelector(`g.marker[data-id="${last.id}"]`);
      if(node) markersLayer.removeChild(node);
      rebuildNumbers(); updateReport(); redrawLegend();
      logH(`Annulé — ${last ? LMAP[last.type].label : ''}`);
    });

    btnClear.addEventListener('click', ()=>{
      if(!markers.length) return;
      markers.splice(0, markers.length);
      markersLayer.innerHTML='';
      rebuildNumbers(); updateReport(); redrawLegend();
      logH('Tous les marqueurs ont été effacés');
    });

    btnToggleNumbers.addEventListener('click', ()=>{
      showNumbers = !showNumbers;
      rebuildNumbers();
      logH(`Numéros ${showNumbers?'affichés':'masqués'}`);
    });

    btnPrint.addEventListener('click', ()=>{
      const d = new Date();
      const dt = d.toLocaleString();
      printMeta.textContent = `Patient: ${patientId.value || '—'} • Date: ${dt}${comments.value ? ' • Notes: ' + comments.value : ''}`;
      window.print();
    });

    [patientId, comments].forEach(el => el.addEventListener('input', ()=>{ updateReport(); }));

    /* ============== CALIBRATION UI ============== */
    btnCalib.addEventListener('click', ()=>{
      calibOn = !calibOn;
      btnCalib.textContent = calibOn ? 'Désactiver calibration' : 'Activer calibration';
      drawCalib();
      logH(calibOn ? 'Mode calibration ACTIVÉ' : 'Mode calibration DÉSACTIVÉ');
    });

    btnCalibLabels.addEventListener('click', ()=>{
      showCalibLabels = !showCalibLabels;
      btnCalibLabels.textContent = showCalibLabels ? 'Masquer étiquettes' : 'Afficher étiquettes';
      drawCalib();
    });

    btnExport.addEventListener('click', ()=>{
      const exportData = REGIONS.map(r=>{
        if(r.type==='poly') return {id:r.id,label:r.label,type:r.type,points:r.points};
        if(r.type==='rect') return {id:r.id,label:r.label,type:r.type,x:r.x,y:r.y,w:r.w,h:r.h};
        if(r.type==='circle') return {id:r.id,label:r.label,type:r.type,cx:r.cx,cy:r.cy,r:r.r};
      });
      exportBox.value = JSON.stringify(exportData, null, 2);
      exportWrap.style.display = 'block';
      exportBox.select();
      logH('Export JSON généré — copie/colle ces valeurs dans REGIONS');
    });

    /* ============== INIT ============== */
    buildPalette();
    redrawLegend();
    updateReport();
    frame.style.cursor='crosshair';
    logH('Prêt — choisissez une lésion puis cliquez sur l’image pour la localiser. (Alt+clic = supprimer, glisser = déplacer)'); 
    logH('Calibration : cliquez “Activer calibration”, puis glissez sommets (polys) ou formes (rect/cercle). Flèches = pas fin.');
  });
  </script>
</body>
</html>

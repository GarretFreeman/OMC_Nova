<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC — Imagerie (zones calibrées)</title>
  <link rel="icon" href="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" type="image/png">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --panel-2:#0b1223; --text:#e5e7eb; --muted:#9ca3af; --ring:#1f2937; --radius:16px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; margin:0}
    .wrap{max-width:1200px;margin:40px auto; padding:0 16px}
    .block{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--ring); border-radius:var(--radius)}
    .header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:16px 20px; border-bottom:1px solid var(--ring)}
    .header .brand{display:flex; align-items:center; gap:10px}
    .btn{appearance:none; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; background:#0b1223; color:#e5e7eb; cursor:pointer; text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7); color:#001019; border-color:#0369a1}
    .panel{background:#0b1223; border:1px solid var(--ring); border-radius:var(--radius); padding:16px; margin:16px}

    .main-grid{display:grid; grid-template-columns:1fr 1.1fr; gap:16px; align-items:stretch}
    @media (max-width:1000px){ .main-grid{grid-template-columns:1fr} }

    /* Image + overlay */
    .bodymap{position:relative; width:100%; background:#0b1223; border:1px solid var(--ring); border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:center}
    .bodyframe{position:relative; width:min(520px,100%); aspect-ratio:418/940;}
    .body-bg{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:.95; filter:drop-shadow(0 8px 24px rgba(0,0,0,.45))}
    svg.overlay{position:absolute; inset:0; width:100%; height:100%}
    .debug polyline, .debug polygon{fill:rgba(56,189,248,.14); stroke:rgba(56,189,248,.9); stroke-width:2}
    .debug text{fill:#cfe6ff; font:600 10px ui-sans-serif,system-ui}
    .legend{display:flex; flex-wrap:wrap; gap:10px; font-size:12px; color:#cbd5e1; margin-top:10px}
    .legend .item{display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid var(--ring); border-radius:10px; background:#0b1223}
    .dot{width:12px; height:12px; border-radius:50%}

    /* Panneau droit */
    .controls{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; color:#9ca3af}
    input,textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:#0b1223; color:#e5e7eb}
    textarea{min-height:80px; resize:vertical}
    .lesions-grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px}
    .chip{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid var(--ring); border-radius:12px; background:#0b1223; cursor:pointer; user-select:none}
    .chip.active{outline:2px solid #38bdf8}

    .actions{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
    .report{background:#030712; border:1px solid var(--ring); border-radius:12px; padding:14px; font-size:13px; line-height:1.5}
    .report h4{margin:0 0 6px; font-size:14px; color:#cbd5e1}
    .report small{color:#94a3b8}
    .report ol{margin:8px 0 0 18px; padding:0}
    .report li{margin:4px 0}
    .report .badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--ring); border-radius:999px; font-size:12px; margin-right:6px}
    .report .badge .bdot{width:10px; height:10px; border-radius:50%}

    /* Marqueurs */
    .marker{cursor:grab}
    .marker:active{cursor:grabbing}
    .marker text{font:600 10px ui-sans-serif,system-ui; fill:#0b1223}

    /* Impression : on garde patient + image + légende + constat */
    @media print{
      body{background:#fff; color:#000}
      .header,.controls,.actions,.history,.panel:first-of-type [data-hide-print]{display:none !important}
      .panel{border:none; margin:0; padding:0}
      .debug{display:none !important}
      .print-header{display:block !important}
      .report{page-break-inside:avoid}
    }
    .print-header{display:none; margin:0 16px 8px; color:#e5e7eb}
    .print-header h2{margin:0 0 6px}
    .muted{color:#94a3b8; font-size:12px}
    .history{background:#030712; border:1px solid var(--ring); border-radius:12px; padding:10px; max-height:220px; overflow:auto; font-size:12px; color:#9ca3af; margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap block">
    <div class="header">
      <div class="brand">
        <a class="btn" href="index.html">← Accueil</a>
        <h1 style="margin:0">Imagerie médicale</h1>
      </div>
      <div style="display:flex; gap:8px">
        <button id="btnDebug" class="btn" data-hide-print>Zones (debug)</button>
        <button id="btnPrint" class="btn">Imprimer</button>
      </div>
    </div>

    <div class="print-header" id="printHeader">
      <h2>Constat lésionnel — OMC</h2>
      <div class="muted" id="printMeta"></div>
    </div>

    <div class="panel">
      <div class="main-grid">
        <!-- Colonne gauche : image + overlay + légende des types -->
        <section>
          <h3 style="margin:0 0 10px; color:#9ca3af">Localiser les lésions</h3>
          <div class="bodymap">
            <div class="bodyframe" id="frame">
              <img class="body-bg" src="assets/corps-humain.png" alt="Silhouette anatomique (face)">
              <svg class="overlay" id="overlay" viewBox="0 0 418 940" xmlns="http://www.w3.org/2000/svg" aria-label="Localisation des lésions">
                <g id="markersLayer"></g>
                <g id="zonesDebugLayer" class="debug" style="display:none"></g>
              </svg>
            </div>
          </div>
          <div class="legend" id="legend"></div>
        </section>

        <!-- Colonne droite : infos + palette + constat -->
        <section>
          <div class="controls">
            <div class="field">
              <label class="label">Nom / ID patient</label>
              <input id="patientId" type="text" placeholder="Ex: John Doe #SS-204">
            </div>
            <div class="field">
              <label class="label">Commentaires</label>
              <textarea id="comments" placeholder="Notes pour le dossier…"></textarea>
            </div>
          </div>

          <div class="field" style="margin-bottom:8px">
            <label class="label">Choisir un type de lésion puis cliquer sur l’image</label>
            <div class="lesions-grid" id="lesionsGrid"></div>
          </div>

          <div class="actions">
            <button id="btnUndo" class="btn">Annuler le dernier point</button>
            <button id="btnClear" class="btn">Effacer toutes les lésions</button>
            <button id="btnToggleNumbers" class="btn">Afficher/Masquer numéros</button>
          </div>

          <div class="report" id="reportBox">
            <h4>Constat lésionnel</h4>
            <small id="reportMeta">Patient : — • Date : —</small>
            <ol id="reportList"></ol>
            <div id="reportSummary" style="margin-top:10px"></div>
          </div>

          <div class="history" id="history" data-hide-print></div>
        </section>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ========== Types de lésions (RP) ========== */
    const LESIONS = [
      {key:'fracture',      label:'Fracture',               color:'#ef4444', code:'FX'},
      {key:'entorse',       label:'Entorse',                color:'#f59e0b', code:'EN'},
      {key:'luxation',      label:'Luxation',               color:'#10b981', code:'LX'},
      {key:'contusion',     label:'Contusion',              color:'#3b82f6', code:'CT'},
      {key:'plaie_blanche', label:'Plaie arme blanche',     color:'#a855f7', code:'PB'},
      {key:'plaie_feu',     label:'Plaie arme à feu',       color:'#b91c1c', code:'PAF'},
      {key:'brulure',       label:'Brûlure',                color:'#eab308', code:'BR'}
    ];
    const LMAP = Object.fromEntries(LESIONS.map(l => [l.key, l]));

    /* ========== REGIONS (tes polygones) ========== */
    const REGIONS_RAW = [
      {"id":"tete","label":"Téte","type":"poly","points":[[215,20],[235,30],[245,45],[250,60],[250,75],[255,80],[255,95],[245,105],[240,120],[185,120],[180,105],[175,95],[170,80],[174,60],[175,45],[190,30],[200,20],[215,20],[215,20]]},
      {"id":"cou","label":"Cou","type":"poly","points":[[185,125],[240,123],[240,146],[185,145],[185,125]]},
      {"id":"epaule_droite","label":"Epaule Droite","type":"poly","points":[[175,155],[140,170],[95,195],[135,265],[160,220],[175,175]]},
      {"id":"epaule_gauche","label":"Epaule Gauche","type":"poly","points":[[250,150],[300,175],[320,185],[325,190],[290,265],[260,205],[250,150]]},
      {"id":"thorax","label":"Thorax","type":"poly","points":[[180,155],[240,155],[253,217],[279,266],[275,305],[149,301],[145,265],[170,220]]},
      {"id":"abdomen","label":"Abdomen","type":"poly","points":[[150,310],[275,314],[280,360],[285,395],[145,395],[145,315]]},
      {"id":"hanche","label":"Hanche","type":"poly","points":[[140,400],[285,405],[295,440],[295,470],[130,470],[135,425]]},
      {"id":"cuisse_gauche","label":"Cuisse Gauche","type":"poly","points":[[215,475],[295,475],[290,575],[285,620],[230,620],[220,540],[220,505]]},
      {"id":"cuisse_droite","label":"Cuisse Droite","type":"poly","points":[[130,475],[205,475],[205,515],[200,575],[195,620],[140,620],[135,575],[130,525]]},
      {"id":"genoux_gauche","label":"Genoux Gauche","type":"poly","points":[[230,626],[285,626],[285,661],[235,656],[235,646]]},
      {"id":"genoux_droit","label":"Genoux Droit","type":"poly","points":[[140,625],[190,625],[190,660],[140,660],[140,640]]},
      {"id":"jambe_gauche","label":"Jambe Gauche","type":"poly","points":[[235,664],[285,670],[285,750],[270,815],[270,825],[245,820],[240,765],[235,730],[235,695]]},
      {"id":"jambe_droite","label":"Jambe Droite","type":"poly","points":[[140,665],[190,665],[190,730],[185,760],[180,795],[180,820],[155,815],[145,760],[140,725],[140,675]]},
      {"id":"cheville_gauche","label":"Cheville Gauche","type":"poly","points":[[245,825],[270,830],[275,860],[245,875],[240,855],[245,835]]},
      {"id":"cheville_droite","label":"Cheville Droite","type":"poly","points":[[155,825],[180,825],[185,855],[150,855],[155,840]]},
      {"id":"pied_gauche","label":"Pied Gauche","type":"poly","points":[[280,860],[300,885],[295,895],[280,905],[260,905],[250,890],[250,880],[260,870]]},
      {"id":"pied_droit","label":"Pied Droit","type":"poly","points":[[160,905],[135,900],[125,890],[130,875],[145,860],[165,860],[185,860],[180,875],[175,895],[170,900]]},
      {"id":"bras_gauche","label":"Bras Gauche","type":"poly","points":[[335,425],[310,355],[305,310],[295,270],[330,195],[335,235],[335,285],[340,310],[350,340],[360,410],[365,430],[340,435]]},
      {"id":"poignet_gauche","label":"Poignet Gauche","type":"poly","points":[[340,460],[380,455],[365,445],[365,435],[350,435],[340,445]]},
      {"id":"main_gauche","label":"Main Gauche","type":"poly","points":[[385,530],[355,530],[345,520],[340,480],[340,465],[355,460],[370,460],[385,465],[400,485],[400,495],[385,485]]},
      {"id":"bras_droit","label":"Bras Droit","type":"poly","points":[[90,430],[65,425],[70,385],[75,345],[85,315],[90,265],[95,220],[95,205],[130,270],[125,310],[120,345],[110,380]]},
      {"id":"poignet_droit","label":"Poignet Droit","type":"poly","points":[[85,460],[50,450],[60,440],[60,430],[75,430],[80,430],[85,440]]},
      {"id":"main_droite","label":"Main Droite","type":"poly","points":[[80,520],[70,530],[55,530],[40,525],[45,495],[45,480],[35,495],[25,495],[30,480],[45,455],[60,455],[75,460],[85,470],[85,505],[85,515]]}
    ];

    /* Tri auto par surface (petites zones d'abord) pour éviter que “bras” capte sur “main/poignet” */
    function polyArea(pts){
      let a=0; for(let i=0,j=pts.length-1;i<pts.length;j=i++) a += (pts[j][0]*pts[i][1] - pts[i][0]*pts[j][1]); return Math.abs(a/2);
    }
    const REGIONS = REGIONS_RAW.slice().sort((a,b)=> polyArea(a.points) - polyArea(b.points));

    /* ========== DOM ========== */
    const overlay = document.getElementById('overlay');
    const markersLayer = document.getElementById('markersLayer');
    const zonesDebugLayer = document.getElementById('zonesDebugLayer');
    const frame = document.getElementById('frame');

    const legendBox = document.getElementById('legend');
    const lesionsGrid = document.getElementById('lesionsGrid');
    const historyBox = document.getElementById('history');
    const patientId = document.getElementById('patientId');
    const comments = document.getElementById('comments');

    const btnUndo = document.getElementById('btnUndo');
    const btnClear = document.getElementById('btnClear');
    const btnToggleNumbers = document.getElementById('btnToggleNumbers');
    const btnPrint = document.getElementById('btnPrint');
    const btnDebug = document.getElementById('btnDebug');

    const reportMeta = document.getElementById('reportMeta');
    const reportList = document.getElementById('reportList');
    const reportSummary = document.getElementById('reportSummary');
    const printMeta = document.getElementById('printMeta');

    /* ========== ÉTAT ========== */
    let activeType = LESIONS[0].key;
    let showNumbers = true;
    const markers = []; // {id,type,x,y}
    let drag = {on:false, id:null, dx:0, dy:0};
    let debugOn = false;

    /* ========== Helpers ========== */
    function logH(msg){ const t=new Date().toLocaleString(); const d=document.createElement('div'); d.innerHTML=`<b>[${t}]</b> ${msg}`; historyBox.prepend(d); }
    function svgPoint(evt){
      const pt = overlay.createSVGPoint();
      pt.x = evt.clientX; pt.y = evt.clientY;
      const out = pt.matrixTransform(overlay.getScreenCTM().inverse());
      return { x: Math.max(0, Math.min(418, out.x)), y: Math.max(0, Math.min(940, out.y)) };
    }
    function inPoly(x,y, pts){
      let inside=false;
      for(let i=0,j=pts.length-1;i<pts.length;j=i++){
        const xi=pts[i][0], yi=pts[i][1], xj=pts[j][0], yj=pts[j][1];
        const intersect = ((yi>y)!==(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi+1e-9) + xi);
        if(intersect) inside=!inside;
      }
      return inside;
    }
    function regionFrom(x,y){
      for(const r of REGIONS){ if(inPoly(x,y,r.points)) return r.label; }
      return 'Zone non définie';
    }

    /* ========== Report ========== */
    function updateReport(){
      const now = new Date().toLocaleString();
      reportMeta.textContent = `Patient : ${patientId.value || '—'} • Date : ${now}${comments.value ? ' • Notes : ' + comments.value : ''}`;
      reportList.innerHTML = '';
      const perTypeCount = {};
      const perTypeIndex = {};
      markers.forEach(m => {
        perTypeCount[m.type]=(perTypeCount[m.type]||0)+1;
        perTypeIndex[m.type]=(perTypeIndex[m.type]||0)+1;
        const idx = perTypeIndex[m.type];
        const li = document.createElement('li');
        li.innerHTML = `<span class="badge"><span class="bdot" style="background:${LMAP[m.type].color}"></span>${LMAP[m.type].label}</span>
        N°${idx} — localisation : ${regionFrom(m.x,m.y)}.`;
        reportList.appendChild(li);
      });
      const summary = LESIONS.map(l=>{
        const n = perTypeCount[l.key]||0;
        return `<span class="badge"><span class="bdot" style="background:${l.color}"></span>${l.label} : ${n}</span>`;
      }).join(' ');
      reportSummary.innerHTML = summary || '<small>Aucune lésion renseignée.</small>';
    }

    /* ========== Marqueurs ========== */
    function rebuildNumbers(){
      const perType = {};
      markers.forEach(m => {
        perType[m.type]=(perType[m.type]||0)+1;
        const n = perType[m.type];
        const node = markersLayer.querySelector(`g.marker[data-id="${m.id}"] text`);
        if(node) node.textContent = showNumbers ? String(n) : '';
      });
    }
    function markerNode(m){
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','marker');
      g.setAttribute('data-id', m.id);
      g.setAttribute('transform', `translate(${m.x},${m.y})`);

      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r','10');
      c.setAttribute('fill', LMAP[m.type].color);
      c.setAttribute('stroke','#0b1223');
      c.setAttribute('stroke-width','2');

      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x','0'); t.setAttribute('y','3'); t.setAttribute('text-anchor','middle'); t.textContent = '';

      g.appendChild(c); g.appendChild(t);

      g.addEventListener('pointerdown', (e)=>{
        e.stopPropagation();
        g.setPointerCapture(e.pointerId);
        drag.on=true; drag.id=m.id;
        const p=svgPoint(e);
        drag.dx=m.x - p.x; drag.dy=m.y - p.y;
      });
      g.addEventListener('pointermove', (e)=>{
        if(!drag.on || drag.id!==m.id) return;
        const p=svgPoint(e);
        m.x = Math.max(0, Math.min(418, p.x + drag.dx));
        m.y = Math.max(0, Math.min(940, p.y + drag.dy));
        g.setAttribute('transform', `translate(${m.x},${m.y})`);
      });
      g.addEventListener('pointerup', ()=>{
        drag.on=false; drag.id=null; updateReport(); logH(`Marqueur déplacé — ${LMAP[m.type].label}`);
      });
      g.addEventListener('click', (e)=>{
        if(e.altKey){
          const idx = markers.findIndex(mm => mm.id===m.id);
          if(idx>-1){ markers.splice(idx,1); }
          markersLayer.removeChild(g);
          rebuildNumbers(); updateReport(); redrawLegend();
          logH(`Marqueur supprimé — ${LMAP[m.type].label}`);
        }
      });
      return g;
    }
    function addMarker(pt, type){
      const m = { id: 'm'+crypto.randomUUID(), type, x: pt.x, y: pt.y };
      markers.push(m);
      markersLayer.appendChild(markerNode(m));
      rebuildNumbers(); updateReport(); redrawLegend();
      logH(`Ajout ${LMAP[type].label} @ x:${Math.round(pt.x)} y:${Math.round(pt.y)}`);
    }

    /* ========== Palette & Légende ========== */
    function buildPalette(){
      lesionsGrid.innerHTML='';
      LESIONS.forEach(l=>{
        const chip = document.createElement('div');
        chip.className='chip' + (l.key===activeType?' active':'');
        chip.setAttribute('data-key', l.key);
        chip.innerHTML = `<span class="dot" style="background:${l.color}"></span><span>${l.label}</span>`;
        chip.addEventListener('click', ()=>{
          [...lesionsGrid.children].forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          activeType = l.key;
          frame.style.cursor='crosshair';
          logH(`Lésion sélectionnée — ${l.label}. Cliquez sur l'image pour placer.`);
        });
        lesionsGrid.appendChild(chip);
      });
    }
    function redrawLegend(){
      const counts = {};
      markers.forEach(m => counts[m.type]=(counts[m.type]||0)+1);
      legendBox.innerHTML='';
      LESIONS.forEach(l => {
        const item = document.createElement('div');
        item.className='item';
        item.innerHTML = `<span class="dot" style="background:${l.color}"></span><span>${l.label}${counts[l.key] ? ' — '+counts[l.key] : ''}</span>`;
        legendBox.appendChild(item);
      });
    }

    /* ========== Zones Debug Overlay ========== */
    function drawZonesDebug(){
      zonesDebugLayer.innerHTML = '';
      if(!debugOn) return;
      REGIONS.forEach(r=>{
        const pg = document.createElementNS('http://www.w3.org/2000/svg','polygon');
        pg.setAttribute('points', r.points.map(p=>p.join(',')).join(' '));
        zonesDebugLayer.appendChild(pg);
        const cx = r.points.reduce((s,p)=>s+p[0],0)/r.points.length;
        const cy = r.points.reduce((s,p)=>s+p[1],0)/r.points.length;
        const label = document.createElementNS('http://www.w3.org/2000/svg','text');
        label.setAttribute('x', cx); label.setAttribute('y', cy);
        label.setAttribute('text-anchor','middle');
        label.textContent = r.label;
        zonesDebugLayer.appendChild(label);
      });
    }

    /* ========== Interactions ========== */
    overlay.addEventListener('click', (e)=>{
      const pt = svgPoint(e);
      addMarker(pt, activeType);
    });

    btnUndo.addEventListener('click', ()=>{
      const last = markers.pop(); if(!last) return;
      const node = markersLayer.querySelector(`g.marker[data-id="${last.id}"]`);
      if(node) markersLayer.removeChild(node);
      rebuildNumbers(); updateReport(); redrawLegend();
      logH(`Annulé — ${last ? LMAP[last.type].label : ''}`);
    });

    btnClear.addEventListener('click', ()=>{
      if(!markers.length) return;
      markers.splice(0, markers.length);
      markersLayer.innerHTML='';
      rebuildNumbers(); updateReport(); redrawLegend();
      logH('Tous les marqueurs ont été effacés');
    });

    btnToggleNumbers.addEventListener('click', ()=>{
      showNumbers = !showNumbers;
      rebuildNumbers();
      logH(`Numéros ${showNumbers?'affichés':'masqués'}`);
    });

    btnDebug.addEventListener('click', ()=>{
      debugOn = !debugOn;
      zonesDebugLayer.style.display = debugOn ? '' : 'none';
      btnDebug.textContent = debugOn ? 'Zones (debug ON)' : 'Zones (debug)';
      drawZonesDebug();
    });

    btnPrint.addEventListener('click', ()=>{
      const d = new Date();
      const dt = d.toLocaleString();
      printMeta.textContent = `Patient: ${patientId.value || '—'} • Date: ${dt}${comments.value ? ' • Notes: ' + comments.value : ''}`;
      window.print();
    });

    [patientId, comments].forEach(el => el.addEventListener('input', ()=>{ updateReport(); }));

    /* ========== Init ========== */
    buildPalette();
    redrawLegend();
    updateReport();
    frame.style.cursor='crosshair';
    logH('Prêt — choisissez une lésion puis cliquez sur l’image pour la localiser. (Alt+clic sur un point = supprimer, glisser = déplacer)');
  });
  </script>
</body>
</html>

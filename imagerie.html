<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC ‚Äî Imagerie (Discord uniquement)</title>
  <link rel="icon" href="assets/logo_omc.png" type="image/png">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --panel-2:#0b1223; --text:#e5e7eb; --muted:#9ca3af; --ring:#1f2937; --radius:16px; --accent:#3b82f6; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; margin:0}
    .wrap{max-width:1200px;margin:40px auto; padding:0 16px}
    .block{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--ring); border-radius:var(--radius)}
    .top{ text-align:center; padding:16px 20px; border-bottom:1px solid var(--ring) }
    .brand{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; }
    .brand img{ height:72px; width:288px; object-fit:contain; background:#071423; padding:6px; border-radius:16px; }
    .brand strong{ font-size:18px; font-weight:800; letter-spacing:.3px }
    .backbar{ display:flex; justify-content:center; margin:8px 0 0 }
    .back{ appearance:none; border:1px solid var(--ring); border-radius:12px; padding:8px 12px; background:#0b1223; color:#e5e7eb; text-decoration:none }
    .back:hover{ background:#0e1a2e; border-color:#20314f }
    .panel{background:#0b1223; border:1px solid var(--ring); border-radius:var(--radius); padding:16px; margin:16px}
    .main-grid{display:grid; grid-template-columns:1fr 1.15fr; gap:16px; align-items:stretch}
    @media (max-width:1000px){ .main-grid{grid-template-columns:1fr} }
    .bodymap{position:relative; width:100%; background:#0b1223; border:1px solid var(--ring); border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:center}
    .bodyframe{position:relative; width:min(520px,100%); aspect-ratio:418/940;}
    .body-bg{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:.95; filter:drop-shadow(0 8px 24px rgba(0,0,0,.45))}
    svg.overlay{position:absolute; inset:0; width:100%; height:100%}
    .cursor-tip{position:absolute; top:0; left:0; transform:translate(-9999px,-9999px); pointer-events:none; background:rgba(2,6,23,.9); color:#e5e7eb; border:1px solid #1f2937; padding:6px 8px; border-radius:10px; font-size:12px; white-space:nowrap; box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .debug polyline, .debug polygon{fill:rgba(56,189,248,.14); stroke:rgba(56,189,248,.9); stroke-width:2}
    .debug text{fill:#cfe6ff; font:600 10px ui-sans-serif,system-ui}
    .legend{display:flex; flex-wrap:wrap; gap:10px; font-size:12px; color:#cbd5e1; margin-top:10px}
    .legend .item{display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid var(--ring); border-radius:10px; background:#0b1223}
    .dot{width:12px; height:12px; border-radius:50%}
    .controls{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; color:#9ca3af}
    input,textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:#0b1223; color:#e5e7eb}
    textarea{min-height:80px; resize:vertical}
    .lesions-grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px}
    .chip{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid var(--ring); border-radius:12px; background:#0b1223; cursor:pointer; user-select:none}
    .chip.active{outline:2px solid #38bdf8}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
    .btn{appearance:none; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; background:#0b1223; color:#e5e7eb; cursor:pointer; text-decoration:none}
    .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0284c7); color:#001019; border-color:#0369a1}
    .btn:hover{background:#0e1a2e; border-color:#20314f}
    .report{background:#030712; border:1px solid var(--ring); border-radius:12px; padding:14px; font-size:13px; line-height:1.5}
    .report h4{margin:0 0 6px; font-size:14px; color:#cbd5e1}
    .report small{color:#94a3b8}
    .report ol{margin:8px 0 0 18px; padding:0}
    .report li{margin:4px 0}
    .report .badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--ring); border-radius:999px; font-size:12px; margin-right:6px}
    .report .badge .bdot{width:10px; height:10px; border-radius:50%}
    .marker{cursor:grab}
    .marker.active circle{ stroke:#fde68a !important; stroke-width:3 !important; }
    .marker:active{cursor:grabbing}
    .marker text{font:600 10px ui-sans-serif,system-ui; fill:#0b1223}
    .history{background:#030712; border:1px solid var(--ring); border-radius:12px; padding:10px; max-height:220px; overflow:auto; font-size:12px; color:#9ca3af; margin-top:12px}
    .options{background:#030712; border:1px solid var(--ring); border-radius:12px; padding:14px}
    .choices{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    .opt-group{border:1px dashed #334155; border-radius:10px; padding:10px}
    .opt-group h5{margin:0 0 8px; font-size:13px; color:#cbd5e1}
    .check{display:flex; gap:8px; align-items:center; padding:8px; border:1px solid var(--ring); border-radius:10px; background:#0b1223}
    .check input{width:auto}
    @media (max-width: 800px){ .choices{grid-template-columns:1fr} }

    /* Popup (Copier / OK) */
    .popup { position: fixed; inset: 0; z-index: 999; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.6); visibility: hidden; opacity: 0; transition: all .2s; }
    .popup.active { visibility: visible; opacity: 1; }
    .popup-content { background: var(--panel); border:1px solid var(--ring); border-radius:16px; width: 90%; max-width: 520px; padding: 20px; text-align:center; box-shadow: 0 0 20px rgba(0,0,0,.35); }
    .popup-content h2 { margin: 0 0 10px; color: var(--accent); font-size: 18px; }
    .popup-content p { word-break: break-all; background: var(--panel-2); border-radius: 10px; padding: 12px; font-size: .92em; color: var(--muted); }
    .popup-buttons { display:flex; justify-content:center; gap:10px; margin-top:14px; }
    .btn-plain { background: var(--accent); border:none; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-plain:hover { filter: brightness(0.95); }
    .btn-secondary { background:#0b1223; border:1px solid var(--ring); color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-secondary:hover { background:#0e1a2e; }
  </style>
</head>

<body>
  <div class="wrap block">
    <div class="top">
      <div class="brand">
        <img src="assets/Logo-omc.png" alt="OMC">
        <strong>Ocean Medical Center ‚Äî Intranet</strong>
      </div>
      <div class="backbar">
        <a class="back" href="index.html">‚Üê Accueil</a>
      </div>
    </div>

    <div class="panel">
      <div class="main-grid">
        <!-- Colonne gauche -->
        <section>
          <h3 style="margin:0 0 10px; color:#9ca3af">Localiser les l√©sions</h3>
          <div class="bodymap">
            <div class="bodyframe" id="frame">
              <img class="body-bg" src="assets/corps-humain.png" alt="Silhouette anatomique (face)">
              <svg class="overlay" id="overlay" viewBox="0 0 418 940" xmlns="http://www.w3.org/2000/svg" aria-label="Localisation des l√©sions">
                <g id="markersLayer"></g>
                <g id="zonesDebugLayer" class="debug" style="display:none"></g>
              </svg>
              <div id="cursorTip" class="cursor-tip" role="tooltip" aria-hidden="true"></div>
            </div>
          </div>
          <div class="legend" id="legend"></div>
        </section>

        <!-- Colonne droite -->
        <section>
          <div class="controls">
            <div class="field">
              <label class="label">Pr√©nom NOM</label>
              <input id="patientId" type="text" placeholder="Garret FREEMAN">
            </div>
            <div class="field">
              <label class="label">Nom du m√©decin</label>
              <input id="doctorName" type="text" placeholder="Ex: Bill Hanson">
            </div>
            <div class="field" style="grid-column:1/-1">
              <label class="label">Commentaires</label>
              <textarea id="comments" placeholder="Notes pour le dossier‚Ä¶"></textarea>
            </div>
          </div>

          <div class="field" style="margin-bottom:8px">
            <label class="label">Choisir un type de l√©sion puis cliquer sur l‚Äôimage</label>
            <div class="lesions-grid" id="lesionsGrid"></div>
          </div>

          <div class="options" id="optionsBox">
            <h4 style="margin:0 0 10px">Options de la l√©sion <span id="activeMarkerLabel">‚Äî</span></h4>
            <div id="lesionOptions" class="choices"></div>
          </div>

          <div class="actions">
            <button id="btnUndo" class="btn">Annuler le dernier point</button>
            <button id="btnClear" class="btn">Effacer toutes les l√©sions</button>
            <button id="btnToggleNumbers" class="btn">Afficher/Masquer num√©ros</button>
            <button id="btnDebug" class="btn">Zones (debug)</button>
            <button id="btnPrint" class="btn primary">Imprimer sur copieur</button>
          </div>

          <div class="report" id="reportBox">
            <h4>Constat l√©sionnel</h4>
            <small id="reportMeta">Patient : ‚Äî ‚Ä¢ M√©decin : ‚Äî ‚Ä¢ Date : ‚Äî</small>
            <ol id="reportList"></ol>
            <div id="reportSummary" style="margin-top:10px"></div>
            <div id="reportTreat" style="margin-top:12px"></div>
            <div id="reportRecs" style="margin-top:6px"></div>
          </div>

          <div class="options">
            <h4 style="margin:0 0 8px">Traitement m√©dicamenteux</h4>
            <small class="label">Propositions en fonction des l√©sions pos√©es. Cochez ce que vous prescrivez :</small>
            <div id="medsChoices" class="choices" style="margin-top:8px"></div>
          </div>

          <div class="options">
            <h4 style="margin:0 0 8px">Pr√©conisations post-rapport</h4>
            <small class="label">Conseils/soins selon le constat. Cochez ce que vous recommandez :</small>
            <div id="recsChoices" class="choices" style="margin-top:8px"></div>
          </div>

          <div class="history" id="history"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Popup URL h√©bergement -->
  <div id="popup" class="popup" aria-hidden="true">
    <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
      <h2 id="popupTitle">Adresse d‚Äôh√©bergement</h2>
      <p id="popupText"></p>
      <div class="popup-buttons">
        <button id="copyBtn" class="btn-plain">Copier</button>
        <button id="okBtn" class="btn-secondary">OK</button>
      </div>
    </div>
  </div>

  <!-- ===== Script SSE unifi√© (inchang√©) ===== -->
  <script>
  (function(){
    if (window.__omcPopupInstalled) return;
    window.__omcPopupInstalled = true;

    const ES_URL = 'https://img.ocean-medical-center.ovh/events';

    if (!window.__omcES) {
      try {
        window.__omcES = new EventSource(ES_URL);
        console.log('[OMC] SSE connect√© √†', ES_URL);
      } catch (e) {
        console.warn('[OMC] √âchec EventSource:', e);
      }
    }
    const es = window.__omcES;
    const shown = (window.__omcShown = window.__omcShown || new Set());

    function showToast(url){
      if (!url || shown.has(url)) return;
      shown.add(url);
      const box = document.createElement('div');
      box.setAttribute('role', 'status');
      box.style.cssText = [
        'position:fixed','right:16px','bottom:16px','z-index:9999',
        'background:#0b1223','color:#e5e7eb','padding:12px 14px',
        'border-radius:12px','border:1px solid #1f2937',
        'box-shadow:0 8px 24px rgba(0,0,0,.35)','max-width:360px',
        'font:14px/1.4 system-ui','opacity:0','transform:translateY(8px)',
        'transition:opacity .25s ease, transform .25s ease'
      ].join(';');

      box.innerHTML = `
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="font-size:18px">üñºÔ∏è</div>
          <div style="flex:1;min-width:0">
            <div style="font-weight:700;margin-bottom:4px">Nouvelle image re√ßue</div>
            <a href="${url}" target="_blank" rel="noopener" style="color:#93c5fd;word-break:break-all">${url}</a>
            <img src="${url}" alt="Image envoy√©e" style="max-width:100%;margin-top:8px;border-radius:8px;display:block">
          </div>
          <button aria-label="Fermer" style="all:unset;cursor:pointer;color:#9ca3af;font-size:16px;line-height:1;padding:2px 4px">‚úñ</button>
        </div>
      `;
      const closeBtn = box.querySelector('button');
      function hide(){ box.style.opacity='0'; box.style.transform='translateY(8px)'; setTimeout(()=>box.remove(),250); }
      closeBtn.onclick = hide;

      document.body.appendChild(box);
      requestAnimationFrame(()=>{ box.style.opacity='1'; box.style.transform='translateY(0)'; });
      setTimeout(hide, 12000);
    }

    if (es) {
      es.onopen  = () => console.log('[OMC] SSE ouvert');
      es.onerror = (e) => console.warn('[OMC] SSE erreur', e);
      es.onmessage = (ev) => {
        try {
          const data = JSON.parse(ev.data);
          const u = data?.url || data?.href || data?.image || data?.link;
          if (u && /^https:\/\//i.test(u) && (!data.type || data.type === 'image')) {
            showToast(u);
          }
        } catch {}
      };
      es.addEventListener('mirrorSaved', (ev) => {
        try {
          const data = JSON.parse(ev.data);
          const u = data?.url || data?.href || data?.image || data?.link;
          if (u && /^https:\/\//i.test(u)) showToast(u);
        } catch {}
      });
    }
    window.__omcTestPopup = (u)=>showToast(u);
  })();
  </script>

  <!-- ===== Script applicatif ===== -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ======= CONFIG API + DISCORD ======= */
    const API_UPLOAD_URL      = 'https://api.ocean-medical-center.ovh/api/upload';
    const API_TOKEN           = 'super-secret-token'; // s√©curiser c√¥t√© serveur
    const WEBHOOK_FORUM_URL   = "https://discord.com/api/webhooks/1421780761731928194/ZFSpiLTHfytIGT02QBf5SBOIEDzWMaf_PMHtDB9sd-GmF5chHnQqQic-9YpLnYHJIRPo";
    const FORUM_THREAD_PREFIX = "Imagerie";
    const LOGO_PATH = "assets/Logo-omc.png";
    const LOGO_FALLBACK = "https://i.ibb.co/LzwcCLfN/logo-omc-nord.png";

    /* ======= Popup ======= */
    const popup = document.getElementById('popup');
    const popupText = document.getElementById('popupText');
    const copyBtn = document.getElementById('copyBtn');
    const okBtn = document.getElementById('okBtn');
    function openPopup(url){
      popupText.textContent = url || '‚Äî';
      popup.classList.add('active'); popup.setAttribute('aria-hidden','false');
      copyBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(url||''); copyBtn.textContent='Copi√© ‚úÖ'; setTimeout(()=>copyBtn.textContent='Copier',1600);}catch{} };
      okBtn.onclick = ()=>{ popup.classList.remove('active'); popup.setAttribute('aria-hidden','true'); };
    }

    /* ======= Donn√©es l√©sionnelles ======= */
    const LESIONS = [
      {key:'fracture',label:'Fracture',color:'#ef4444',code:'FX'},
      {key:'entorse',label:'Entorse',color:'#f59e0b',code:'EN'},
      {key:'luxation',label:'Luxation',color:'#10b981',code:'LX'},
      {key:'contusion',label:'Contusion',color:'#3b82f6',code:'CT'},
      {key:'plaie_blanche',label:'Plaie arme blanche',color:'#a855f7',code:'PB'},
      {key:'plaie_feu',label:'Plaie arme √† feu',color:'#b91c1c',code:'PAF'},
      {key:'brulure',label:'Br√ªlure',color:'#eab308',code:'BR'}
    ];
    const LMAP = Object.fromEntries(LESIONS.map(l => [l.key, l]));

    /* ‚ö†Ô∏è FORM_CFG global (r√©tabli) */
    const FORM_CFG = {
      fracture: [
        {key:'type', label:'Type', kind:'radio', options:['transversale','oblique','comminutive']},
        {key:'deplacement', label:'D√©placement', kind:'radio', options:['aucun','l√©ger','marqu√©']},
        {key:'ouverte', label:'Plaie ouverte', kind:'checkbox'}
      ],
      entorse: [
        {key:'stade', label:'Stade', kind:'radio', options:['I','II','III']},
        {key:'oedeme', label:'≈íd√®me', kind:'radio', options:['absent','discret','important']},
        {key:'instabilite', label:'Instabilit√©', kind:'checkbox'}
      ],
      luxation: [
        {key:'reduction', label:'R√©duction', kind:'radio', options:['spontan√©e','non r√©duite']},
        {key:'douleur', label:'Douleur', kind:'radio', options:['faible','mod√©r√©e','forte']}
      ],
      contusion: [
        {key:'hematome', label:'H√©matome', kind:'radio', options:['absent','discret','important']},
        {key:'douleur', label:'Douleur', kind:'radio', options:['faible','mod√©r√©e','forte']}
      ],
      plaie_blanche: [
        {key:'longueur', label:'Longueur', kind:'radio', options:['~2 cm','~3 cm','~4 cm']},
        {key:'berges', label:'Berges', kind:'radio', options:['r√©guli√®res','irr√©guli√®res']},
        {key:'saign', label:'Saignement actif', kind:'checkbox'}
      ],
      plaie_feu: [
        {key:'orifice', label:'Orifice', kind:'radio', options:['entr√©e','entr√©e + sortie']},
        {key:'traj', label:'Trajectoire', kind:'radio', options:['ant√©ro-post√©rieure','oblique']},
        {key:'hemorragie', label:'H√©morragie', kind:'checkbox'}
      ],
      brulure: [
        {key:'degre', label:'Degr√©', kind:'radio', options:['1er','2e superficiel','2e profond']},
        {key:'surface', label:'Surface', kind:'radio', options:['<1%','1‚Äì3%','>3%']},
        {key:'phlyctenes', label:'Phlyct√®nes', kind:'radio', options:['absentes','pr√©sentes']}
      ]
    };

    const MEDS_CFG = {
      fracture: ['Parac√©tamol 1g', 'Ibuprof√®ne 400mg (si pas de CI)', 'Antalgique palier II si douleur forte', 'ATB si plaie ouverte', 'Rappel t√©tanos si statut inconnu'],
      entorse:  ['Parac√©tamol 1g', 'Ibuprof√®ne 400mg (si pas de CI)'],
      luxation: ['Parac√©tamol 1g', 'Antalgique palier II si douleur forte'],
      contusion:['Parac√©tamol 1g', 'Ibuprof√®ne 400mg (si pas de CI)'],
      plaie_blanche:['Analg√©sique PO', 'Antiseptique local', 'ATB prophylaxie (si plaie √† risque)', 'Rappel t√©tanos si statut inconnu'],
      plaie_feu:   ['Antalgique', 'ATB selon contexte', 'Rappel t√©tanos', 'Couverture anti-douleur'],
      brulure:  ['Antalgique', 'Pansement gras/argent (local)', 'ATB si surinfection']
    };
    const RECS_CFG = {
      fracture: ['Immobilisation (attelle/√©charpe)', 'Glace 15 min/2h', 'Sur√©l√©vation', 'Contr√¥le imagerie'],
      entorse:  ['Protocole GREC (glace, repos, √©l√©vation, compression)', 'Immobilisation courte', 'R√©√©valuation 48‚Äì72h'],
      luxation: ['Immobilisation post-r√©duction', 'Contr√¥le neurovasculaire', 'Imagerie de contr√¥le'],
      contusion:['Glace 15 min/2h', 'Repos relatif', 'Surveillance h√©matome'],
      plaie_blanche:['Nettoyage/Irrigation', 'Suture/Strips selon plaie', 'Surveillance signes infection', 'Consignes pansements'],
      plaie_feu:   ['Compression si h√©morragie', 'Orientation tra√ßabilit√©/forensic', 'Surveillance choc', 'Imagerie selon si√®ge'],
      brulure:  ['Refroidissement 15 min', 'Pansement st√©rile', 'Surveillance douleur', '√âviter exposition']
    };
    const EXTRA_REC = 'Suivi par un kin√©sith√©rapeute pour r√©√©ducation';

    /* Zones anatomiques ‚Äî garde la structure vide si tu n‚Äôas pas les polygones sous la main */
    const REGIONS_RAW = [/* ‚Ä¶ tes polygones ‚Ä¶ */];
    function polyArea(pts){ let a=0; for(let i=0,j=pts.length-1;i<pts.length;j=i++) a += (pts[j][0]*pts[i][1] - pts[i][0]*pts[j][1]); return Math.abs(a/2); }
    const REGIONS = (REGIONS_RAW||[]).slice().sort((a,b)=> polyArea(a.points) - polyArea(b.points));

    /* ======= S√©lecteurs ======= */
    const overlay = document.getElementById('overlay');
    const markersLayer = document.getElementById('markersLayer');
    const zonesDebugLayer = document.getElementById('zonesDebugLayer');
    const frame = document.getElementById('frame');
    const cursorTip = document.getElementById('cursorTip');

    const legendBox = document.getElementById('legend');
    const lesionsGrid = document.getElementById('lesionsGrid');
    const historyBox = document.getElementById('history');
    const patientId = document.getElementById('patientId');
    const doctorName = document.getElementById('doctorName');
    const comments = document.getElementById('comments');

    const btnUndo = document.getElementById('btnUndo');
    const btnClear = document.getElementById('btnClear');
    const btnToggleNumbers = document.getElementById('btnToggleNumbers');
    const btnPrint = document.getElementById('btnPrint');
    const btnDebug = document.getElementById('btnDebug');

    const reportMeta = document.getElementById('reportMeta');
    const reportList = document.getElementById('reportList');
    const reportSummary = document.getElementById('reportSummary');
    const reportTreat = document.getElementById('reportTreat');
    const reportRecs = document.getElementById('reportRecs');

    const lesionOptions = document.getElementById('lesionOptions');
    const activeMarkerLabel = document.getElementById('activeMarkerLabel');
    const medsChoices = document.getElementById('medsChoices');
    const recsChoices = document.getElementById('recsChoices');

    /* ======= √âtat ======= */
    let activeType = LESIONS[0]?.key || 'fracture';
    let showNumbers = true;
    const markers = [];
    let activeMarkerId = null;
    let debugOn = false;
    const selectedMeds = new Set();
    const selectedRecs = new Set();

    /* ======= Utils ======= */
    function logH(msg){ try{ const t=new Date().toLocaleString(); const d=document.createElement('div'); d.innerHTML=`<b>[${t}]</b> ${msg}`; historyBox?.prepend(d);}catch{} }
    function svgPoint(evt){
      const pt = overlay.createSVGPoint();
      pt.x = evt.clientX; pt.y = evt.clientY;
      const out = pt.matrixTransform(overlay.getScreenCTM().inverse());
      return { x: Math.max(0, Math.min(418, out.x)), y: Math.max(0, Math.min(940, out.y)) };
    }
    function inPoly(x,y, pts){
      let inside=false;
      for(let i=0,j=pts.length-1;i<pts.length;j=i++){
        const xi=pts[i][0], yi=pts[i][1], xj=pts[j][0], yj=pts[j][1];
        const intersect = ((yi>y)!==(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi+1e-9) + xi);
        if(intersect) inside=!inside;
      }
      return inside;
    }
    function regionFrom(x,y){ for(const r of REGIONS){ if(inPoly(x,y,r.points)) return r.label; } return null; }

    /* ======= UI: liste des l√©sions (chips) ======= */
    function buildPalette(){
      if(!lesionsGrid){ console.warn('lesionsGrid introuvable'); return; }
      lesionsGrid.innerHTML='';
      LESIONS.forEach(l=>{
        const chip = document.createElement('div');
        chip.className='chip' + (l.key===activeType?' active':'');
        chip.innerHTML = `<span class="dot" style="background:${l.color}"></span><span>${l.label}</span>`;
        chip.addEventListener('click', ()=>{
          [...lesionsGrid.children].forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          activeType = l.key;
          if(frame) frame.style.cursor='crosshair';
          logH(`Type s√©lectionn√© ‚Äî ${l.label}. Cliquez sur l'image pour placer.`);
        });
        lesionsGrid.appendChild(chip);
      });
    }

    function redrawLegend(){
      if(!legendBox) return;
      const counts = {};
      markers.forEach(m => counts[m.type]=(counts[m.type]||0)+1);
      legendBox.innerHTML='';
      LESIONS.forEach(l => {
        const item = document.createElement('div');
        item.className='item';
        item.innerHTML = `<span class="dot" style="background:${l.color}"></span><span>${l.label}${counts[l.key] ? ' ‚Äî '+counts[l.key] : ''}</span>`;
        legendBox.appendChild(item);
      });
    }

    function setActiveMarker(id){
      activeMarkerId = id;
      markersLayer?.querySelectorAll('.marker').forEach(g=>g.classList.remove('active'));
      if(id){
        const node = markersLayer?.querySelector(`g.marker[data-id="${id}"]`);
        if(node) node.classList.add('active');
      }
      renderLesionOptions();
    }

    function renderLesionOptions(){
      if(!lesionOptions) return;
      lesionOptions.innerHTML = '';
      if(!activeMarkerId){
        activeMarkerLabel.textContent = '‚Äî';
        lesionOptions.innerHTML = `<div class="label">S√©lectionnez ou ajoutez une l√©sion pour voir ses options.</div>`;
        return;
      }
      const m = markers.find(x=>x.id===activeMarkerId);
      if(!m){ activeMarkerLabel.textContent='‚Äî'; return; }
      const cfg = FORM_CFG[m.type] || [];
      activeMarkerLabel.textContent = `(${LMAP[m.type].label})`;

      cfg.forEach(group=>{
        const wrap = document.createElement('div');
        wrap.className='opt-group';
        const h5 = document.createElement('h5'); h5.textContent = group.label; wrap.appendChild(h5);

        if(group.kind==='checkbox'){
          const row = document.createElement('label'); row.className='check';
          const input = document.createElement('input'); input.type='checkbox'; input.checked = !!m.opts[group.key];
          const txt = document.createElement('span'); txt.textContent = group.label;
          input.onchange = ()=>{ m.opts[group.key] = input.checked ? true : undefined; updateReport(); };
          row.append(input, txt);
          wrap.appendChild(row);
        } else if(group.kind==='radio'){
          (group.options||[]).forEach(opt=>{
            const row = document.createElement('label'); row.className='check';
            const input = document.createElement('input'); input.type='radio'; input.name=`opt-${group.key}-${m.id}`;
            input.checked = (m.opts[group.key]===opt);
            const txt = document.createElement('span'); txt.textContent = opt;
            input.onchange = ()=>{ m.opts[group.key] = opt; updateReport(); };
            row.append(input, txt);
            wrap.appendChild(row);
          });
        }
        lesionOptions.appendChild(wrap);
      });

      if(cfg.length===0){
        lesionOptions.innerHTML = `<div class="label">Aucune option sp√©cifique pour cette l√©sion.</div>`;
      }
    }

    function markerText(m){
      const zone = regionFrom(m.x,m.y) || 'zone non pr√©cis√©e';
      const o = m.opts || {};
      switch(m.type){
        case 'fracture':
          return `Fracture ${o.type||'non pr√©cis√©e'} ${o.deplacement?('('+o.deplacement+') '):''}${o.ouverte?'avec plaie ouverte, ':''}au niveau de la ${zone.toLowerCase()}.`;
        case 'entorse':
          return `Entorse ${o.stade?('stade '+o.stade):'‚Äî'} ${o.oedeme?('avec ≈ìd√®me '+o.oedeme):''}${o.instabilite?' et instabilit√©':''} au niveau de la ${zone.toLowerCase()}.`;
        case 'luxation':
          return `Luxation ${o.reduction?('('+o.reduction+') '):''}avec douleur ${o.douleur||'‚Äî'} au niveau de la ${zone.toLowerCase()}.`;
        case 'contusion':
          return `Contusion ${o.hematome?('avec h√©matome '+o.hematome):''}${o.douleur?(' et douleur '+o.douleur):''} au niveau de la ${zone.toLowerCase()}.`;
        case 'plaie_blanche':
          return `Plaie par arme blanche ${o.longueur||''}${o.berges?(', berges '+o.berges):''}${o.saign?' avec saignement actif':''} au niveau de la ${zone.toLowerCase()}.`;
        case 'plaie_feu':
          return `Plaie par arme √† feu, orifice ${o.orifice||'‚Äî'}, trajectoire ${o.traj||'‚Äî'}${o.hemorragie?' avec h√©morragie':''} au niveau de la ${zone.toLowerCase()}.`;
        case 'brulure':
          return `Br√ªlure ${o.degre||'‚Äî'} (${o.surface||'surface ‚Äî'})${o.phlyctenes?(', phlyct√®nes '+o.phlyctenes):''} au niveau de la ${zone.toLowerCase()}.`;
        default:
          return `L√©sion ${LMAP[m.type].label} au niveau de la ${zone.toLowerCase()}.`;
      }
    }

    function updateReport(){
      const now = new Date().toLocaleString();
      if(reportMeta) reportMeta.textContent = `Patient : ${patientId.value || '‚Äî'} ‚Ä¢ M√©decin : ${doctorName.value || '‚Äî'} ‚Ä¢ Date : ${now}${comments.value ? ' ‚Ä¢ Notes : ' + comments.value : ''}`;

      if(reportList){
        reportList.innerHTML = '';
        const perTypeIndex = {};
        markers.forEach(m => {
          perTypeIndex[m.type]=(perTypeIndex[m.type]||0)+1;
          const idx = perTypeIndex[m.type];
          const li = document.createElement('li');
          li.innerHTML = `<span class="badge"><span class="bdot" style="background:${LMAP[m.type].color}"></span>${LMAP[m.type].label} ‚Äî N¬∞${idx}</span> ${markerText(m)}`;
          reportList.appendChild(li);
        });
      }

      const counts = {};
      markers.forEach(m => counts[m.type]=(counts[m.type]||0)+1);
      if(reportSummary){
        const summary = LESIONS.map(l=>{
          const n = counts[l.key]||0;
          return `<span class="badge"><span class="bdot" style="background:${l.color}"></span>${l.label} : ${n}</span>`;
        }).join(' ');
        reportSummary.innerHTML = summary || '<small>Aucune l√©sion renseign√©e.</small>';
      }

      if(reportTreat) reportTreat.innerHTML = selectedMeds.size
        ? `<h4 style="margin:10px 0 6px">Traitement m√©dicamenteux</h4><ul style="margin:0 0 0 18px; padding:0">${[...selectedMeds].map(x=>`<li>${x}</li>`).join('')}</ul>`
        : '';
      if(reportRecs) reportRecs.innerHTML = selectedRecs.size
        ? `<h4 style="margin:10px 0 6px">Pr√©conisations</h4><ul style="margin:0 0 0 18px; padding:0">${[...selectedRecs].map(x=>`<li>${x}</li>`).join('')}</ul>`
        : '';
    }

    function redrawNumbers(){
      const perType = {};
      markers.forEach(m => {
        perType[m.type]=(perType[m.type]||0)+1;
        const n = perType[m.type];
        const node = markersLayer?.querySelector(`g.marker[data-id="${m.id}"] text`);
        if(node) node.textContent = showNumbers ? String(n) : '';
      });
    }

    function loadImage(src, {cross=false}={}){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        if(cross) img.crossOrigin = 'anonymous';
        img.onload = ()=>resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }
    function wrapText(context, text, x, y, maxWidth, fontSize, lineHeight){
      const words = String(text).split(/\s+/);
      let line = '', cy=y;
      for(let n=0;n<words.length;n++){
        const test = line + (line? ' ':'') + words[n];
        const w = context.measureText(test).width;
        if(w > maxWidth && n>0){ context.fillText(line, x, cy); line = words[n]; cy += lineHeight; }
        else { line = test; }
      }
      context.fillText(line, x, cy);
      return cy - y + lineHeight;
    }

    /* ‚Äî‚Äî‚Äî Mesure/Export PNG (identique √† la version pr√©c√©dente) ‚Äî‚Äî‚Äî */
    function wrapHeight(ctx, text, maxWidth, lineHeight){
      const words = String(text).split(/\s+/);
      let line = '', used = lineHeight;
      for(let n=0;n<words.length;n++){
        const test = line + (line? ' ':'') + words[n];
        const w = ctx.measureText(test).width;
        if(w > maxWidth && n>0){ line = words[n]; used += lineHeight; }
        else { line = test; }
      }
      return used;
    }

    function measureRightCardHeight(scale, rightW){
      const paddingX = 16*scale, headerH = 72*scale;
      const line14 = 18*scale, line13 = 16*scale, line12 = 16*scale;
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      let y = headerH + 16*scale;

      ctx.font = `${14*scale}px ui-sans-serif, system-ui`;
      y += line14 * 3;

      if(comments.value){
        ctx.font = `${14*scale}px ui-sans-serif, system-ui`;
        y += wrapHeight(ctx, `Notes : ${comments.value}`, rightW - paddingX*2, 18*scale) + 6*scale;
      }

      const counts = {}; markers.forEach(m=>counts[m.type]=(counts[m.type]||0)+1);
      let bx = paddingX, by = y + 12*scale;
      ctx.font = `${12*scale}px ui-sans-serif, system-ui`;
      LESIONS.forEach(l=>{
        const txt = `${l.label} : ${counts[l.key]||0}`;
        const w = ctx.measureText(txt).width + 24*scale + 20*scale;
        if(bx + w > rightW - paddingX){ bx = paddingX; by += 30*scale; }
        bx += w + 8*scale;
      });
      y = by + 24*scale;
      y += 16*scale;

      const perTypeIndex = {};
      if(!markers.length){
        y += line13 + 10*scale;
      } else {
        markers.forEach(m=>{
          perTypeIndex[m.type]=(perTypeIndex[m.type]||0)+1;
          const ch = markerText(m);
          ctx.font = `${12*scale}px ui-sans-serif, system-ui`;
          y += line13 + 12*scale;
          y += wrapHeight(ctx, ch, rightW - (paddingX*2 + 50*scale), line12) + 10*scale;
        });
      }

      if(selectedMeds.size){
        y += 20*scale;
        selectedMeds.forEach(txt=>{
          ctx.font = `${12*scale}px ui-sans-serif, system-ui`;
          y += wrapHeight(ctx, txt, rightW - (paddingX*2 + 20*scale), line12) + 6*scale;
        });
      }
      if(selectedRecs.size){
        y += 20*scale;
        selectedRecs.forEach(txt=>{
          ctx.font = `${12*scale}px ui-sans-serif, system-ui`;
          y += wrapHeight(ctx, txt, rightW - (paddingX*2 + 20*scale), line12) + 6*scale;
        });
      }

      y += 24*scale;
      return y;
    }

    async function exportReportPNG(scale=2){
      const rightW = 640*scale, sideGap = 20*scale, figPad = 20*scale;
      const measuredCardH = measureRightCardHeight(scale, rightW);
      const Hmin = 940*scale;
      const H = Math.max(Hmin, figPad*2 + measuredCardH);

      const canvas = document.createElement('canvas');
      const figH = H - figPad*2;
      const s = figH / 940;
      const figW = 418 * s;
      const W = Math.round(figPad + figW + sideGap + rightW + figPad);

      canvas.width = W; canvas.height = H;
      const ctx = canvas.getContext('2d');

      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);

      const bgSrc = document.querySelector('.body-bg').src;
      const bgImg = await loadImage(bgSrc);
      const figX = figPad, figY = figPad;
      ctx.drawImage(bgImg, figX, figY, figW, figH);

      const perTypeNums = {};
      markers.forEach(m=>{
        perTypeNums[m.type]=(perTypeNums[m.type]||0)+1;
        const n = perTypeNums[m.type];
        const x = Math.round(figX + m.x*s);
        const y = Math.round(figY + m.y*s);
        ctx.beginPath();
        ctx.fillStyle = LMAP[m.type].color;
        ctx.strokeStyle = '#0b1223';
        ctx.lineWidth = 2*scale;
        ctx.arc(x, y, 10*scale, 0, Math.PI*2);
        ctx.fill(); ctx.stroke();
        if(showNumbers){
          ctx.fillStyle = '#0b1223';
          ctx.font = `${10*scale}px ui-sans-serif, system-ui`;
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(String(n), x, y);
        }
      });

      const rightX = Math.round(figX + figW + sideGap);
      const cardY  = figPad;
      const cardW  = rightW;
      const cardH  = measureRightCardHeight(scale, rightW);

      function roundRect(ctx, x, y, w, h, r){
        const rr = Math.min(r, w/2, h/2);
        ctx.beginPath();
        ctx.moveTo(x+rr,y);
        ctx.arcTo(x+w,y,x+w,y+h,rr);
        ctx.arcTo(x+w,y+h,x,y+h,rr);
        ctx.arcTo(x,y+h,x,y,rr);
        ctx.arcTo(x,y,x+w,y,rr);
        ctx.closePath();
      }
      roundRect(ctx, rightX, cardY, cardW, cardH, 16*scale);
      ctx.fillStyle = '#f8fafc'; ctx.fill();
      ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1*scale; ctx.stroke();

      const headerH = 72*scale;
      const grad = ctx.createLinearGradient(0, cardY, 0, cardY+headerH);
      grad.addColorStop(0, '#0ea5e9'); grad.addColorStop(1, '#0284c7');
      roundRect(ctx, rightX, cardY, cardW, headerH, 16*scale);
      ctx.fillStyle = grad; ctx.fill();

      try{
        let logoImg;
        try { logoImg = await loadImage(LOGO_PATH); }
        catch { logoImg = await loadImage(LOGO_FALLBACK, {cross:true}); }
        ctx.drawImage(logoImg, rightX+16*scale, cardY+14*scale, 44*scale, 44*scale);
      }catch{}

      ctx.fillStyle = '#001019';
      ctx.font = `${20*scale}px ui-sans-serif, system-ui`;
      ctx.textAlign='left'; ctx.textBaseline='middle';
      ctx.fillText('Constat l√©sionnel ‚Äî OMC', rightX+72*scale, cardY+headerH/2);

      const metaY = cardY + headerH + 16*scale;
      const dateStr = new Date().toLocaleString();
      ctx.fillStyle = '#0f172a';
      ctx.font = `${14*scale}px ui-sans-serif, system-ui`;
      ctx.fillText(`Patient : ${patientId.value || '‚Äî'}`, rightX+16*scale, metaY);
      ctx.fillText(`M√©decin : ${doctorName.value || '‚Äî'}`, rightX+16*scale, metaY + 20*scale);
      ctx.fillText(`Date : ${dateStr}`, rightX+16*scale, metaY + 40*scale);
      if(comments.value){
        ctx.fillStyle = '#334155';
        wrapText(ctx, `Notes : ${comments.value}`, rightX+16*scale, metaY + 64*scale, cardW-32*scale, 14*scale, 18*scale);
      }

      const counts = {}; markers.forEach(m=>counts[m.type]=(counts[m.type]||0)+1);
      let badgeX = rightX+16*scale, badgeY = metaY + (comments.value? 114*scale : 90*scale);
      ctx.font = `${12*scale}px ui-sans-serif, system-ui`;
      LESIONS.forEach(l=>{
        const txt = `${l.label} : ${counts[l.key]||0}`;
        const w = ctx.measureText(txt).width + 24*scale + 20*scale;
        if(badgeX + w > rightX + cardW - 16*scale){ badgeX = rightX+16*scale; badgeY += 30*scale; }
        roundRect(ctx, badgeX, badgeY, w, 24*scale, 999);
        ctx.fillStyle = '#ffffff'; ctx.fill();
        ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1*scale; ctx.stroke();
        ctx.beginPath(); ctx.fillStyle = l.color; ctx.arc(badgeX+12*scale, badgeY+12*scale, 5*scale, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#0f172a'; ctx.fillText(txt, badgeX+24*scale, badgeY+15*scale);
        badgeX += w + 8*scale;
      });

      let listTop = badgeY + 36*scale;
      ctx.fillStyle = '#0f172a';
      ctx.font = `${14*scale}px ui-sans-serif, system-ui`;
      ctx.fillText('Constatations :', rightX+16*scale, listTop);
      listTop += 16*scale;

      const perTypeIndex = {};
      if(!markers.length){
        ctx.fillStyle = '#334155';
        ctx.font = `${13*scale}px ui-sans-serif, system-ui`;
        ctx.fillText('‚Äî Aucune l√©sion renseign√©e ‚Äî', rightX+24*scale, listTop+6*scale);
      }else{
        markers.forEach(m=>{
          perTypeIndex[m.type]=(perTypeIndex[m.type]||0)+1;
          const idx  = perTypeIndex[m.type];

          ctx.beginPath();
          ctx.fillStyle = LMAP[m.type].color;
          ctx.arc(rightX+22*scale, listTop+8*scale, 4*scale, 0, Math.PI*2); ctx.fill();

          ctx.fillStyle = '#0f172a';
          ctx.font = `${13*scale}px ui-sans-serif, system-ui`;
          const line = `${LMAP[m.type].label} ‚Äî N¬∞${idx}`;
          ctx.fillText(line, rightX+34*scale, listTop+12*scale);

          ctx.fillStyle = '#475569';
          ctx.font = `${12*scale}px ui-sans-serif, system-ui`;
          const ch = markerText(m);
          listTop += wrapText(ctx, ch, rightX+34*scale, listTop+28*scale, cardW-50*scale, 12*scale, 16*scale) + 16*scale;
        });
      }

      if(selectedMeds.size){
        listTop += 16*scale;
        ctx.fillStyle = '#0f172a';
        ctx.font = `${14*scale}px ui-sans-serif, system-ui`;
        ctx.fillText('Traitement m√©dicamenteux :', rightX+16*scale, listTop);
        listTop += 16*scale;
        ctx.fillStyle = '#475569';
        ctx.font = `${12*scale}px ui-sans-serif, system-ui`;
        [...selectedMeds].forEach(txt=>{
          ctx.beginPath(); ctx.fillStyle='#0f172a';
          ctx.arc(rightX+22*scale, listTop-4*scale, 3*scale, 0, Math.PI*2); ctx.fill();
          ctx.fillStyle='#475569';
          listTop += wrapText(ctx, txt, rightX+34*scale, listTop, cardW-50*scale, 12*scale, 16*scale) + 8*scale;
        });
      }
      if(selectedRecs.size){
        listTop += 8*scale;
        ctx.fillStyle = '#0f172a';
        ctx.font = `${14*scale}px ui-sans-serif, system-ui`;
        ctx.fillText('Pr√©conisations :', rightX+16*scale, listTop);
        listTop += 16*scale;
        ctx.fillStyle = '#475569';
        ctx.font = `${12*scale}px ui-sans-serif, system-ui`;
        [...selectedRecs].forEach(txt=>{
          ctx.beginPath(); ctx.fillStyle='#0f172a';
          ctx.arc(rightX+22*scale, listTop-4*scale, 3*scale, 0, Math.PI*2); ctx.fill();
          ctx.fillStyle='#475569';
          listTop += wrapText(ctx, txt, rightX+34*scale, listTop, cardW-50*scale, 12*scale, 16*scale) + 8*scale;
        });
      }

      return await new Promise(res=> canvas.toBlob(b=>res(b),'image/png'));
    }

    /* ======= Upload + Discord (texte + lien) ======= */
    async function uploadToVps(blob, ref){
      const fd = new FormData();
      fd.append('file', blob, `imagerie_${ref}.png`);
      const res = await fetch(API_UPLOAD_URL, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${API_TOKEN}` },
        body: fd
      });
      if(!res.ok){
        const txt = await res.text().catch(()=> ''); throw new Error('Upload VPS ' + res.status + ' ‚Äî ' + txt);
      }
      const data = await res.json().catch(()=> ({}));
      if(!data?.url) throw new Error('R√©ponse API VPS inattendue (pas d‚Äôurl).');
      return data.url; // https://img.ocean-medical-center.ovh/...
    }

    function makeDiscordContent() {
      const p = patientId.value?.trim() || '‚Äî';
      const d = doctorName.value?.trim() || '‚Äî';
      const dateStr = new Date().toLocaleString();
      const lines = [];
      lines.push(`**ü©∫ OMC ‚Äî Imagerie**`);
      lines.push(`**Patient :** ${p}  ‚Ä¢  **M√©decin :** ${d}  ‚Ä¢  **Date :** ${dateStr}`);
      lines.push(``);
      lines.push(`**üßæ Constat l√©sionnel**`);
      if (!markers.length) {
        lines.push(`‚Äî Aucune l√©sion renseign√©e`);
      } else {
        const perTypeIndex = {};
        markers.forEach(m => {
          perTypeIndex[m.type] = (perTypeIndex[m.type] || 0) + 1;
          const idx = perTypeIndex[m.type];
          lines.push(`‚Ä¢ **${LMAP[m.type].label} ‚Äî N¬∞${idx}** ‚Äî ${markerText(m)}`);
        });
      }
      if (comments.value?.trim()) {
        lines.push(``);
        lines.push(`_Notes : ${comments.value.trim()}_`);
      }
      lines.push(``);
      lines.push(`**üíä Traitement m√©dicamenteux**`);
      if (selectedMeds.size) {
        [...selectedMeds].forEach(t => lines.push(`‚Ä¢ ${t}`));
      } else {
        lines.push(`‚Äî`);
      }
      lines.push(``);
      lines.push(`**üß≠ Pr√©conisations**`);
      if (selectedRecs.size) {
        [...selectedRecs].forEach(t => lines.push(`‚Ä¢ ${t}`));
      } else {
        lines.push(`‚Äî`);
      }
      let out = lines.join('\n');
      if (out.length > 1990) out = out.slice(0, 1985) + '‚Ä¶';
      return out;
    }

    async function postTextToDiscord(threadName, publicUrl){
      if(!WEBHOOK_FORUM_URL) throw new Error('Webhook Discord non configur√©.');
      if(!publicUrl) throw new Error('URL publique absente ‚Äî upload requis avant envoi Discord.');
      const content = [`**${threadName}**`, publicUrl, '', makeDiscordContent()].join('\n');
      const res = await fetch(WEBHOOK_FORUM_URL + '?wait=true', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ thread_name: threadName, content })
      });
      if(!res.ok){
        const txt = await res.text().catch(()=> ''); throw new Error('Discord ' + res.status + ' ‚Äî ' + txt);
      }
    }

    async function sendToDiscordForum(){
      try{
        btnPrint.disabled = true; btnPrint.textContent = 'G√©n√©ration‚Ä¶';
        const imgBlob = await exportReportPNG(2);
        const now = new Date();
        const ref = `${String(now.getDate()).padStart(2,'0')}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`; // JJMMHHMM
        const who = patientId.value || 'Sans nom';
        const threadName = `${FORUM_THREAD_PREFIX} ‚Äî ${who} ‚Äî Ref ${ref}`.slice(0,100);

        btnPrint.textContent = 'Envoi vers le serveur‚Ä¶';
        const publicUrl = await uploadToVps(imgBlob, ref);

        btnPrint.textContent = 'Publication Discord‚Ä¶';
        await postTextToDiscord(threadName, publicUrl);

        try{ await navigator.clipboard.writeText(publicUrl); }catch{}
        openPopup(publicUrl);
        logH('Image h√©berg√©e + message Discord publi√©.');
      }catch(e){
        console.error(e);
        openPopup('‚ùå √âchec : ' + e.message);
      }finally{
        btnPrint.disabled = false; btnPrint.textContent = 'Imprimer sur copieur';
      }
    }

    /* ======= Interactions ======= */
    function addMarker(pt, type){
      const m = { id: 'm'+(crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)), type, x: pt.x, y: pt.y, opts:{} };
      markers.push(m);
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','marker'); g.setAttribute('data-id', m.id); g.setAttribute('transform', `translate(${m.x},${m.y})`);
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('r','10'); c.setAttribute('fill', LMAP[m.type].color); c.setAttribute('stroke','#0b1223'); c.setAttribute('stroke-width','2');
      const t = document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x','0'); t.setAttribute('y','3'); t.setAttribute('text-anchor','middle'); t.textContent = '';
      g.appendChild(c); g.appendChild(t);

      let dragging=false;
      g.addEventListener('pointerdown', (e)=>{ g.setPointerCapture(e.pointerId); dragging=true; g.dataset.dx = m.x - svgPoint(e).x; g.dataset.dy = m.y - svgPoint(e).y; });
      g.addEventListener('pointermove', (e)=>{ if(!dragging) return; const p=svgPoint(e); m.x=Math.max(0,Math.min(418,p.x+Number(g.dataset.dx))); m.y=Math.max(0,Math.min(940,p.y+Number(g.dataset.dy))); g.setAttribute('transform', `translate(${m.x},${m.y})`); });
      g.addEventListener('pointerup', ()=>{ dragging=false; updateReport(); });
      g.addEventListener('click', (e)=>{
        if(e.altKey){
          const idx = markers.findIndex(mm => mm.id===m.id);
          if(idx>-1){ markers.splice(idx,1); }
          if(activeMarkerId===m.id) activeMarkerId=null;
          markersLayer.removeChild(g);
          redrawNumbers(); updateReport(); redrawLegend(); updateTPPanels(); renderLesionOptions();
          logH(`Marqueur supprim√© ‚Äî ${LMAP[m.type].label}`);
        } else {
          setActiveMarker(m.id);
        }
      });
      markersLayer.appendChild(g);
      setActiveMarker(m.id);
      redrawNumbers(); updateReport(); redrawLegend(); updateTPPanels();
      logH(`Ajout ${LMAP[type].label} @ x:${Math.round(pt.x)} y:${Math.round(pt.y)}`);
    }

    function updateTPPanels(){
      const types = [...new Set(markers.map(m=>m.type))];
      const meds = new Set(); types.forEach(t => (MEDS_CFG[t]||[]).forEach(x=>meds.add(x)));
      const recs = new Set(); types.forEach(t => (RECS_CFG[t]||[]).forEach(x=>recs.add(x)));
      if(types.length>0){ recs.add(EXTRA_REC); }

      const renderList = (box, items, setStore) => {
        const prev = new Set([...setStore]);
        box.innerHTML = '';
        if(items.size===0){
          box.innerHTML = `<div class="label">Aucune proposition (ajoutez des l√©sions).</div>`;
          setStore.clear(); updateReport(); return;
        }
        [...items].forEach(txt=>{
          const row = document.createElement('label'); row.className='check';
          const input = document.createElement('input'); input.type='checkbox'; input.checked = prev.has(txt);
          input.onchange = ()=>{ input.checked ? setStore.add(txt) : setStore.delete(txt); updateReport(); };
          const span = document.createElement('span'); span.textContent = txt;
          row.append(input, span);
          box.appendChild(row);
        });
        setStore.clear(); prev.forEach(v => { if(items.has(v)) setStore.add(v); });
        updateReport();
      };
      renderList(medsChoices, meds, selectedMeds);
      renderList(recsChoices, recs, selectedRecs);
    }

    /* ======= Listeners ======= */
    overlay?.addEventListener('click', (e)=> addMarker(svgPoint(e), activeType));
    btnUndo?.addEventListener('click', ()=>{
      const last = markers.pop(); if(!last) return;
      const node = markersLayer?.querySelector(`g.marker[data-id="${last.id}"]`);
      if(node) markersLayer.removeChild(node);
      if(activeMarkerId===last.id) activeMarkerId=null;
      redrawNumbers(); updateReport(); redrawLegend(); updateTPPanels(); renderLesionOptions();
      logH(`Annul√© ‚Äî ${last ? LMAP[last.type].label : ''}`);
    });
    btnClear?.addEventListener('click', ()=>{
      if(!markers.length) return;
      markers.splice(0, markers.length);
      if(markersLayer) markersLayer.innerHTML='';
      activeMarkerId=null;
      selectedMeds.clear(); selectedRecs.clear();
      redrawNumbers(); updateReport(); redrawLegend(); updateTPPanels(); renderLesionOptions();
      logH('Tous les marqueurs ont √©t√© effac√©s');
    });
    btnToggleNumbers?.addEventListener('click', ()=>{
      showNumbers = !showNumbers; redrawNumbers();
      logH(`Num√©ros ${showNumbers?'affich√©s':'masqu√©s'}`);
    });
    btnDebug?.addEventListener('click', ()=>{
      debugOn = !debugOn;
      if(zonesDebugLayer){
        zonesDebugLayer.style.display = debugOn ? '' : 'none';
        btnDebug.textContent = debugOn ? 'Zones (debug ON)' : 'Zones (debug)';
        zonesDebugLayer.innerHTML = '';
        if(!debugOn) return;
        REGIONS.forEach(r=>{
          const pg = document.createElementNS('http://www.w3.org/2000/svg','polygon');
          pg.setAttribute('points', r.points.map(p=>p.join(',')).join(' '));
          zonesDebugLayer.appendChild(pg);
          const cx = r.points.reduce((s,p)=>s+p[0],0)/r.points.length;
          const cy = r.points.reduce((s,p)=>s+p[1],0)/r.points.length;
          const label = document.createElementNS('http://www.w3.org/2000/svg','text');
          label.setAttribute('x', cx); label.setAttribute('y', cy);
          label.setAttribute('text-anchor','middle'); label.textContent = r.label;
          zonesDebugLayer.appendChild(label);
        });
      }
    });
    btnPrint?.addEventListener('click', sendToDiscordForum);
    [patientId, doctorName, comments].forEach(el => el?.addEventListener('input', updateReport));

    /* ======= Init ======= */
    buildPalette();
    redrawLegend();
    updateReport();
    updateTPPanels();
    renderLesionOptions();
    if(frame) frame.style.cursor='crosshair';
    logH('Pr√™t ‚Äî choisissez un type puis cliquez sur l‚Äôimage pour placer une l√©sion. (Alt+clic = supprimer, cliquer pour s√©lectionner, glisser pour d√©placer)');
  });
  </script>
</body>
</html>

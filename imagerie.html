<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMC — Imagerie</title>
  <link rel="icon" href="https://i.ibb.co/LzwcCLfN/logo-omc-nord.png" type="image/png">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --panel-2:#0b1223; --text:#e5e7eb; --muted:#9ca3af; --ring:#1f2937; --radius:16px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; margin:0}
    .wrap{max-width:1200px;margin:40px auto; padding:0 16px}
    .block{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--ring); border-radius:var(--radius)}
    .header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:16px 20px; border-bottom:1px solid var(--ring)}
    .header .brand{display:flex; align-items:center; gap:10px}
    .btn{appearance:none; border:1px solid var(--ring); border-radius:12px; padding:10px 12px; background:#0b1223; color:#e5e7eb; cursor:pointer; text-decoration:none}
    .panel{background:#0b1223; border:1px solid var(--ring); border-radius:var(--radius); padding:16px; margin:16px}

    /* GRID principal */
    .main-grid{display:grid; grid-template-columns:1fr 1.1fr; gap:16px; align-items:stretch}
    @media (max-width:1000px){ .main-grid{grid-template-columns:1fr} }

    /* Carte du corps (image + overlay editable) */
    .bodymap{position:relative; width:100%; background:#0b1223; border:1px solid var(--ring); border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:center}
    .bodyframe{position:relative; width:min(520px,100%); aspect-ratio:418/940;}
    .body-bg{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; opacity:.95; filter:drop-shadow(0 8px 24px rgba(0,0,0,.45));}
    svg.overlay{position:absolute; inset:0; width:100%; height:100%}

    /* Panneau droit */
    .controls{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; color:#9ca3af}
    input,textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:#0b1223; color:var(--text)}
    textarea{min-height:80px; resize:vertical}
    .lesions-grid{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px}
    .chip{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid var(--ring); border-radius:12px; background:#0b1223; cursor:pointer; user-select:none}
    .chip.active{outline:2px solid #38bdf8}
    .dot{width:14px; height:14px; border-radius:50%}
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}

    /* Constat lésionnel (droite) */
    .report{background:#030712; border:1px solid var(--ring); border-radius:12px; padding:14px; font-size:13px; line-height:1.5}
    .report h4{margin:0 0 6px; font-size:14px; color:#cbd5e1}
    .report small{color:#94a3b8}
    .report ol{margin:8px 0 0 18px; padding:0}
    .report li{margin:4px 0}
    .report .badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--ring); border-radius:999px; font-size:12px; margin-right:6px}
    .report .badge .bdot{width:10px; height:10px; border-radius:50%}

    /* Marqueurs */
    .marker{cursor:grab}
    .marker:active{cursor:grabbing}
    .marker text{font:600 10px ui-sans-serif,system-ui; fill:#0b1223}

    /* Impression : patient + image + constat */
    @media print{
      body{background:#fff; color:#000}
      .header,.controls,.actions,.history,.panel:first-of-type{display:none !important}
      .panel{border:none; margin:0; padding:0}
      .print-header{display:block !important}
      .report{page-break-inside:avoid}
    }
    .print-header{display:none; margin:0 16px 8px; color:#e5e7eb}
    .print-header h2{margin:0 0 6px}
    .muted{color:#94a3b8; font-size:12px}
  </style>
</head>
<body>
  <div class="wrap block">
    <div class="header">
      <div class="brand">
        <a class="btn" href="index.html">← Accueil</a>
        <h1 style="margin:0">Imagerie médicale</h1>
      </div>
      <button id="btnPrint" class="btn">Imprimer</button>
    </div>

    <!-- En-tête dédiée impression -->
    <div class="print-header" id="printHeader">
      <h2>Constat lésionnel — OMC</h2>
      <div class="muted" id="printMeta"></div>
    </div>

    <div class="panel">
      <div class="main-grid">
        <!-- Colonne gauche : image + overlay -->
        <section>
          <h3 style="margin:0 0 10px; color:#9ca3af">Localiser les lésions</h3>
          <div class="bodymap">
            <div class="bodyframe" id="frame">
              <img class="body-bg" src="assets/corps-humain.png" alt="Silhouette anatomique (face)">
              <svg class="overlay" id="overlay" viewBox="0 0 418 940" xmlns="http://www.w3.org/2000/svg" aria-label="Localisation des lésions"></svg>
            </div>
          </div>
        </section>

        <!-- Colonne droite : infos + palette + constat -->
        <section>
          <div class="controls">
            <div class="field">
              <label class="label">Nom / ID patient</label>
              <input id="patientId" type="text" placeholder="Ex: John Doe #SS-204">
            </div>
            <div class="field">
              <label class="label">Commentaires</label>
              <textarea id="comments" placeholder="Notes pour le dossier…"></textarea>
            </div>
          </div>

          <div class="field" style="margin-bottom:8px">
            <label class="label">Choisir un type de lésion puis cliquer sur l’image</label>
            <div class="lesions-grid" id="lesionsGrid"></div>
          </div>

          <div class="actions">
            <button id="btnUndo" class="btn">Annuler le dernier point</button>
            <button id="btnClear" class="btn">Effacer toutes les lésions</button>
            <button id="btnToggleNumbers" class="btn">Afficher/Masquer numéros</button>
          </div>

          <div class="report" id="reportBox">
            <h4>Constat lésionnel</h4>
            <small id="reportMeta">Patient : — • Date : —</small>
            <ol id="reportList"></ol>
            <div id="reportSummary" style="margin-top:10px"></div>
          </div>

          <div class="history" id="history" style="background:#030712; border:1px solid var(--ring); border-radius:12px; padding:10px; max-height:220px; overflow:auto; font-size:12px; color:#9ca3af; margin-top:12px"></div>
        </section>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ------- Types de lésions (inclut 2 types de plaies)
    const LESIONS = [
      {key:'fracture',      label:'Fracture',                  color:'#ef4444', code:'FX'},
      {key:'entorse',       label:'Entorse',                   color:'#f59e0b', code:'EN'},
      {key:'luxation',      label:'Luxation',                  color:'#10b981', code:'LX'},
      {key:'contusion',     label:'Contusion',                 color:'#3b82f6', code:'CT'},
      {key:'plaie_blanche', label:'Plaie par arme blanche',    color:'#a855f7', code:'PB'},
      {key:'plaie_feu',     label:'Plaie par arme à feu',      color:'#b91c1c', code:'PAF'},
      {key:'brulure',       label:'Brûlure',                   color:'#eab308', code:'BR'}
    ];

    // ------- Éléments DOM
    const overlay = document.getElementById('overlay');
    const frame = document.getElementById('frame');
    const lesionsGrid = document.getElementById('lesionsGrid');
    const historyBox = document.getElementById('history');
    const patientId = document.getElementById('patientId');
    const comments = document.getElementById('comments');
    const btnUndo = document.getElementById('btnUndo');
    const btnClear = document.getElementById('btnClear');
    const btnPrint = document.getElementById('btnPrint');
    const btnToggleNumbers = document.getElementById('btnToggleNumbers');

    const reportBox = document.getElementById('reportBox');
    const reportMeta = document.getElementById('reportMeta');
    const reportList = document.getElementById('reportList');
    const reportSummary = document.getElementById('reportSummary');

    const printHeader = document.getElementById('printHeader');
    const printMeta = document.getElementById('printMeta');

    // ------- État
    let activeType = LESIONS[0].key;
    let showNumbers = true;
    const markers = []; // {id,type,x,y}
    let drag = {on:false, id:null, dx:0, dy:0};

    const LMAP = Object.fromEntries(LESIONS.map(l => [l.key, l]));
    function logH(msg){ const t=new Date().toLocaleString(); const d=document.createElement('div'); d.innerHTML=`<b>[${t}]</b> ${msg}`; historyBox.prepend(d); }

    // Approximation zone anatomique depuis x,y (viewBox 418x940)
    function regionFrom(x,y){
      // bandes verticales gauche/droite (latéralité)
      const side = x < 209 ? 'gauche' : 'droite';
      if(y < 200) return 'tête';
      if(y < 420) return 'thorax';
      if(y < 520) return `abdomen/pelvis`;
      if(y < 740) return `membre ${side} (cuisse/genou)`;
      return `membre ${side} (jambe/cheville)`;
    }

    function svgPoint(evt){
      const pt = overlay.createSVGPoint();
      pt.x = evt.clientX; pt.y = evt.clientY;
      const out = pt.matrixTransform(overlay.getScreenCTM().inverse());
      return { x: Math.max(0, Math.min(418, out.x)), y: Math.max(0, Math.min(940, out.y)) };
    }

    function rebuildNumbers(){
      const perType = {};
      markers.forEach(m => {
        perType[m.type]=(perType[m.type]||0)+1;
        const n = perType[m.type];
        const node = overlay.querySelector(`g.marker[data-id="${m.id}"] text`);
        if(node) node.textContent = showNumbers ? String(n) : '';
      });
    }

    function updateReport(){
      const now = new Date().toLocaleString();
      reportMeta.textContent = `Patient : ${patientId.value || '—'} • Date : ${now}${comments.value ? ' • Notes : ' + comments.value : ''}`;

      // Liste détaillée
      reportList.innerHTML = '';
      const perTypeCount = {};
      const perTypeIndex = {};
      markers.forEach(m => {
        perTypeCount[m.type]=(perTypeCount[m.type]||0)+1;
        perTypeIndex[m.type]=(perTypeIndex[m.type]||0)+1;
        const idx = perTypeIndex[m.type];
        const li = document.createElement('li');
        li.innerHTML = `<span class="badge"><span class="bdot" style="background:${LMAP[m.type].color}"></span>${LMAP[m.type].label}</span>
        N°${idx} — localisation estimée : ${regionFrom(m.x,m.y)}.`;
        reportList.appendChild(li);
      });

      // Résumé par type
      const summaryBadges = Object.entries(LMAP).map(([k,l])=>{
        const n = perTypeCount[k] || 0;
        return `<span class="badge"><span class="bdot" style="background:${l.color}"></span>${l.label} : ${n}</span>`;
      }).join(' ');
      reportSummary.innerHTML = summaryBadges || '<small>Aucune lésion renseignée.</small>';
    }

    function markerNode(m){
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','marker');
      g.setAttribute('data-id', m.id);
      g.setAttribute('transform', `translate(${m.x},${m.y})`);

      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r','10');
      c.setAttribute('fill', LMAP[m.type].color);
      c.setAttribute('stroke','#0b1223');
      c.setAttribute('stroke-width','2');

      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x','0'); t.setAttribute('y','3');
      t.setAttribute('text-anchor','middle');
      t.textContent = ''; // sera défini par rebuildNumbers()

      g.appendChild(c); g.appendChild(t);

      // Drag & drop
      g.addEventListener('pointerdown', (e)=>{
        e.stopPropagation();
        g.setPointerCapture(e.pointerId);
        drag.on=true; drag.id=m.id;
        const p=svgPoint(e);
        drag.dx=m.x - p.x; drag.dy=m.y - p.y;
      });
      g.addEventListener('pointermove', (e)=>{
        if(!drag.on || drag.id!==m.id) return;
        const p=svgPoint(e);
        m.x = p.x + drag.dx; m.y = p.y + drag.dy;
        g.setAttribute('transform', `translate(${m.x},${m.y})`);
      });
      g.addEventListener('pointerup', ()=>{
        drag.on=false; drag.id=null;
        updateReport();
        logH(`Marqueur déplacé — ${LMAP[m.type].label}`);
      });

      // Alt+clic pour supprimer
      g.addEventListener('click', (e)=>{
        if(e.altKey){
          const idx = markers.findIndex(mm => mm.id===m.id);
          if(idx>-1){ markers.splice(idx,1); }
          overlay.removeChild(g);
          rebuildNumbers();
          updateReport();
          logH(`Marqueur supprimé — ${LMAP[m.type].label}`);
        }
      });

      return g;
    }

    function addMarker(pt, type){
      const m = { id: 'm'+crypto.randomUUID(), type, x: pt.x, y: pt.y };
      markers.push(m);
      overlay.appendChild(markerNode(m));
      rebuildNumbers();
      updateReport();
      logH(`Ajout ${LMAP[type].label} @ x:${Math.round(pt.x)} y:${Math.round(pt.y)}`);
    }

    // ------- Palette (droite)
    function buildPalette(){
      lesionsGrid.innerHTML='';
      LESIONS.forEach(l=>{
        const chip = document.createElement('div');
        chip.className='chip' + (l.key===activeType?' active':'');
        chip.setAttribute('data-key', l.key);
        chip.innerHTML = `<span class="dot" style="background:${l.color}"></span><span>${l.label}</span>`;
        chip.addEventListener('click', ()=>{
          [...lesionsGrid.children].forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          activeType = l.key;
          frame.style.cursor='crosshair';
          logH(`Lésion sélectionnée — ${l.label}. Cliquez sur l'image pour placer.`);
        });
        lesionsGrid.appendChild(chip);
      });
    }

    // ------- Interactions
    overlay.addEventListener('click', (e)=>{
      const pt = svgPoint(e);
      addMarker(pt, activeType);
    });

    btnUndo.addEventListener('click', ()=>{
      const last = markers.pop();
      if(!last) return;
      const node = overlay.querySelector(`g.marker[data-id="${last.id}"]`);
      if(node) overlay.removeChild(node);
      rebuildNumbers();
      updateReport();
      logH(`Annulé — ${last ? LMAP[last.type].label : ''}`);
    });

    btnClear.addEventListener('click', ()=>{
      if(!markers.length) return;
      markers.splice(0, markers.length);
      overlay.innerHTML='';
      rebuildNumbers();
      updateReport();
      logH('Tous les marqueurs ont été effacés');
    });

    btnToggleNumbers.addEventListener('click', ()=>{
      showNumbers = !showNumbers;
      rebuildNumbers();
      logH(`Numéros ${showNumbers?'affichés':'masqués'}`);
    });

    // Impression : renseigne l’en-tête
    btnPrint.addEventListener('click', ()=>{
      const d = new Date();
      const dt = d.toLocaleString();
      printMeta.textContent = `Patient: ${patientId.value || '—'} • Date: ${dt}${comments.value ? ' • Notes: ' + comments.value : ''}`;
      window.print();
    });

    // MAJ méta si patient/notes changent
    [patientId, comments].forEach(el => el.addEventListener('input', updateReport));

    // ------- Init
    buildPalette();
    frame.style.cursor='crosshair';
    updateReport();
    logH('Prêt — choisissez une lésion puis cliquez sur l’image pour la localiser. (Alt+clic pour supprimer un point, glisser pour déplacer)');
  });
  </script>
</body>
</html>
